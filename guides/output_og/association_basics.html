<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Active Record Associations — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbo-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbo-track="reload">
  
  <link rel="icon" href="images/favicon.ico" sizes="any">
  <link rel="icon" href="images/icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="images/icon.png">
  
  <script src="javascripts/@hotwired--turbo.js" data-turbo-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbo-track="reload"></script>
  <script src="javascripts/guides.js" data-turbo-track="reload"></script>

  <meta property="og:title" content="Active Record Associations — Ruby on Rails Guides" />
  <meta name="description" content="Active Record AssociationsThis guide covers the association features of Active Record.After reading this guide, you will know how to: Declare associations between Active Record models. Understand the various types of Active Record associations. Use the methods added to your models by creating associations." />
  <meta property="og:description" content="Active Record AssociationsThis guide covers the association features of Active Record.After reading this guide, you will know how to: Declare associations between Active Record models. Understand the various types of Active Record associations. Use the methods added to your models by creating associations." />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />

  <meta name="theme-color" content="#C81418">
</head>

<body dir="ltr" class="guide">
  <div>
    <div id="version-badge">edge</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">More at <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        More Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://rubyonrails.org/blog">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guides</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribute on GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <div class="header-logo"><a href="index.html" title="Return to home page">Guides.rubyonrails.org</a></div>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guides Index</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Start Here</dt>
                  <dd><a href="getting_started.html">Getting Started with Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Other Components</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Digging Deeper</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="error_reporting.html">Error Reporting in Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading</a></dd>
                  <dd><a href="classic_to_zeitwerk_howto.html">Migrating from Classic to Zeitwerk</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases</a></dd>
                  <dd><a href="active_record_composite_primary_keys.html">Composite Primary Keys</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Extending Rails</dt>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contributing</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Guides Guidelines</a></dd>
                  <dd><a href="development_dependencies_install.html">Installing Rails Core Development Dependencies</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Policies</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="7_1_release_notes.html">Version 7.1 - October 2023</a></dd>
                  <dd><a href="7_0_release_notes.html">Version 7.0 - December 2021</a></dd>
                  <dd><a href="6_1_release_notes.html">Version 6.1 - December 2020</a></dd>
                  <dd><a href="6_0_release_notes.html">Version 6.0 - August 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </dl>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribute</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guides Index</option>
              <optgroup label="Start Here">
                  <option value="getting_started.html">Getting Started with Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Other Components">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
              </optgroup>
              <optgroup label="Digging Deeper">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="error_reporting.html">Error Reporting in Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading</option>
                  <option value="classic_to_zeitwerk_howto.html">Migrating from Classic to Zeitwerk</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases</option>
                  <option value="active_record_composite_primary_keys.html">Composite Primary Keys</option>
              </optgroup>
              <optgroup label="Extending Rails">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
              </optgroup>
              <optgroup label="Contributing">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Guides Guidelines</option>
                  <option value="development_dependencies_install.html">Installing Rails Core Development Dependencies</option>
              </optgroup>
              <optgroup label="Policies">
                  <option value="maintenance_policy.html">Maintenance Policy</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="7_1_release_notes.html">Version 7.1 - October 2023</option>
                  <option value="7_0_release_notes.html">Version 7.0 - December 2021</option>
                  <option value="6_1_release_notes.html">Version 6.1 - December 2020</option>
                  <option value="6_0_release_notes.html">Version 6.0 - August 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h1>Active Record Associations</h1><p>This guide covers the association features of Active Record.</p><p>After reading this guide, you will know how to:</p>
<ul>
<li>Declare associations between Active Record models.</li>
<li>Understand the various types of Active Record associations.</li>
<li>Use the methods added to your models by creating associations.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/icon_book-close-bookmark-1.svg" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#why-associations-questionmark">Why Associations?</a></li>
<li><a href="#the-types-of-associations">The Types of Associations</a>

<ul>
<li><a href="#the-belongs-to-association">The <code>belongs_to</code> Association</a></li>
<li><a href="#the-has-one-association">The <code>has_one</code> Association</a></li>
<li><a href="#the-has-many-association">The <code>has_many</code> Association</a></li>
<li><a href="#the-has-many-through-association">The <code>has_many :through</code> Association</a></li>
<li><a href="#the-has-one-through-association">The <code>has_one :through</code> Association</a></li>
<li><a href="#the-has-and-belongs-to-many-association">The <code>has_and_belongs_to_many</code> Association</a></li>
<li><a href="#choosing-between-belongs-to-and-has-one">Choosing Between <code>belongs_to</code> and <code>has_one</code></a></li>
<li><a href="#choosing-between-has-many-through-and-has-and-belongs-to-many">Choosing Between <code>has_many :through</code> and <code>has_and_belongs_to_many</code></a></li>
<li><a href="#polymorphic-associations">Polymorphic Associations</a></li>
<li><a href="#associations-between-models-with-composite-primary-keys">Associations between Models with Composite Primary Keys</a></li>
<li><a href="#self-joins">Self Joins</a></li>
</ul></li>
<li><a href="#tips-tricks-and-warnings">Tips, Tricks, and Warnings</a>

<ul>
<li><a href="#controlling-caching">Controlling Caching</a></li>
<li><a href="#avoiding-name-collisions">Avoiding Name Collisions</a></li>
<li><a href="#updating-the-schema">Updating the Schema</a></li>
<li><a href="#controlling-association-scope">Controlling Association Scope</a></li>
<li><a href="#bi-directional-associations">Bi-directional Associations</a></li>
</ul></li>
<li><a href="#detailed-association-reference">Detailed Association Reference</a>

<ul>
<li><a href="#belongs-to-association-reference"><code>belongs_to</code> Association Reference</a></li>
<li><a href="#has-one-association-reference"><code>has_one</code> Association Reference</a></li>
<li><a href="#has-many-association-reference"><code>has_many</code> Association Reference</a></li>
<li><a href="#has-and-belongs-to-many-association-reference"><code>has_and_belongs_to_many</code> Association Reference</a></li>
<li><a href="#association-callbacks">Association Callbacks</a></li>
<li><a href="#association-extensions">Association Extensions</a></li>
<li><a href="#association-scoping-using-the-association-owner">Association Scoping using the Association Owner</a></li>
</ul></li>
<li><a href="#single-table-inheritance-sti">Single Table Inheritance (STI)</a></li>
<li><a href="#delegated-types">Delegated Types</a>

<ul>
<li><a href="#declare-delegated-type">Declare <code>delegated_type</code></a></li>
<li><a href="#object-creation">Object creation</a></li>
<li><a href="#adding-further-delegation">Adding further delegation</a></li>
</ul></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h2 id="why-associations-questionmark"><a class="anchorlink" href="#why-associations-questionmark">1 Why Associations?</a></h2><p>In Rails, an <em>association</em> is a connection between two Active Record models. Why do we need associations between models? Because they make common operations simpler and easier in your code.</p><p>For example, consider a simple Rails application that includes a model for authors and a model for books. Each author can have many books.</p><p>Without associations, the model declarations would look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
end

class Book < ApplicationRecord
end
">Copy</button>
</div>
<p>Now, suppose we wanted to add a new book for an existing author. We'd need to do something like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">author_id: </span><span class="vi">@author</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book = Book.create(published_at: Time.now, author_id: @author.id)
">Copy</button>
</div>
<p>Or consider deleting an author, and ensuring that all of its books get deleted as well:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">author_id: </span><span class="vi">@author</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
<span class="vi">@books</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
  <span class="n">book</span><span class="p">.</span><span class="nf">destroy</span>
<span class="k">end</span>
<span class="vi">@author</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@books = Book.where(author_id: @author.id)
@books.each do |book|
  book.destroy
end
@author.destroy
">Copy</button>
</div>
<p>With Active Record associations, we can streamline these - and other - operations by declaratively telling Rails that there is a connection between the two models. Here's the revised code for setting up authors and books:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, dependent: :destroy
end

class Book < ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>With this change, creating a new book for a particular author is easier:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book = @author.books.create(published_at: Time.now)
">Copy</button>
</div>
<p>Deleting an author and all of its books is <em>much</em> easier:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.destroy
">Copy</button>
</div>
<p>To learn more about the different types of associations, read the next section of this guide. That's followed by some tips and tricks for working with associations, and then by a complete reference to the methods and options for associations in Rails.</p><h2 id="the-types-of-associations"><a class="anchorlink" href="#the-types-of-associations">2 The Types of Associations</a></h2><p>Rails supports six types of associations, each with a particular use-case in mind.</p><p>Here is a list of all of the supported types with a link to their API docs for more detailed information on how to use them, their method parameters, etc.</p>
<ul>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to"><code>belongs_to</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many :through</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one :through</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many"><code>has_and_belongs_to_many</code></a></li>
</ul>
<p>Associations are implemented using macro-style calls, so that you can declaratively add features to your models. For example, by declaring that one model <code>belongs_to</code> another, you instruct Rails to maintain <a href="https://en.wikipedia.org/wiki/Primary_key">Primary Key</a>-<a href="https://en.wikipedia.org/wiki/Foreign_key">Foreign Key</a> information between instances of the two models, and you also get a number of utility methods added to your model.</p><p>In the remainder of this guide, you'll learn how to declare and use the various forms of associations. But first, a quick introduction to the situations where each association type is appropriate.</p><h3 id="the-belongs-to-association"><a class="anchorlink" href="#the-belongs-to-association">2.1 The <code>belongs_to</code> Association</a></h3><p>A <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to"><code>belongs_to</code></a> association sets up a connection with another model, such that each instance of the declaring model "belongs to" one instance of the other model. For example, if your application includes authors and books, and each book can be assigned to exactly one author, you'd declare the book model this way:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p><img src="images/association_basics/belongs_to.png" alt="belongs_to Association Diagram"></p><div class="note"><p><code>belongs_to</code> associations <em>must</em> use the singular term. If you used the pluralized form in the above example for the <code>author</code> association in the <code>Book</code> model and tried to create the instance by <code>Book.create(authors: @author)</code>, you would be told that there was an "uninitialized constant Book::Authors". This is because Rails automatically infers the class name from the association name. If the association name is wrongly pluralized, then the inferred class will be wrongly pluralized too.</p></div><p>The corresponding migration might look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateBooks < ActiveRecord::Migration[7.2]
  def change
    create_table :authors do |t|
      t.string :name
      t.timestamps
    end

    create_table :books do |t|
      t.belongs_to :author
      t.datetime :published_at
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>When used alone, <code>belongs_to</code> produces a one-directional one-to-one connection. Therefore each book in the above example "knows" its author, but the authors don't know about their books.
To setup a <a href="#bi-directional-associations">bi-directional association</a> - use <code>belongs_to</code> in combination with a <code>has_one</code> or <code>has_many</code> on the other model, in this case the Author model.</p><p><code>belongs_to</code> does not ensure reference consistency if <code>optional</code> is set to true, so depending on the use case, you might also need to add a database-level foreign key constraint on the reference column, like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :books do |t|
  t.belongs_to :author, foreign_key: true
  # ...
end
">Copy</button>
</div>
<h3 id="the-has-one-association"><a class="anchorlink" href="#the-has-one-association">2.2 The <code>has_one</code> Association</a></h3><p>A <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one</code></a> association indicates that one other model has a reference to this model. That model can be fetched through this association.</p><p>For example, if each supplier in your application has only one account, you'd declare the supplier model like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account
end
">Copy</button>
</div>
<p>The main difference from <code>belongs_to</code> is that the link column <code>supplier_id</code> is located in the other table:</p><p><img src="images/association_basics/has_one.png" alt="has_one Association Diagram"></p><p>The corresponding migration might look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateSuppliers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateSuppliers < ActiveRecord::Migration[7.2]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.belongs_to :supplier
      t.string :account_number
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>Depending on the use case, you might also need to create a unique index and/or
a foreign key constraint on the supplier column for the accounts table. In this
case, the column definition might look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">index: </span><span class="p">{</span> <span class="ss">unique: </span><span class="kp">true</span> <span class="p">},</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :accounts do |t|
  t.belongs_to :supplier, index: { unique: true }, foreign_key: true
  # ...
end
">Copy</button>
</div>
<p>This relation can be <a href="#bi-directional-associations">bi-directional</a> when used in combination with <code>belongs_to</code> on the other model.</p><h3 id="the-has-many-association"><a class="anchorlink" href="#the-has-many-association">2.3 The <code>has_many</code> Association</a></h3><p>A <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many</code></a> association is similar to <code>has_one</code>, but indicates a one-to-many connection with another model. You'll often find this association on the "other side" of a <code>belongs_to</code> association. This association indicates that each instance of the model has zero or more instances of another model. For example, in an application containing authors and books, the author model could be declared like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<div class="note"><p>The name of the other model is pluralized when declaring a <code>has_many</code> association.</p></div><p><img src="images/association_basics/has_many.png" alt="has_many Association Diagram"></p><p>The corresponding migration might look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAuthors</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAuthors < ActiveRecord::Migration[7.2]
  def change
    create_table :authors do |t|
      t.string :name
      t.timestamps
    end

    create_table :books do |t|
      t.belongs_to :author
      t.datetime :published_at
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>Depending on the use case, it's usually a good idea to create a non-unique index and optionally
a foreign key constraint on the author column for the books table:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :books do |t|
  t.belongs_to :author, index: true, foreign_key: true
  # ...
end
">Copy</button>
</div>
<h3 id="the-has-many-through-association"><a class="anchorlink" href="#the-has-many-through-association">2.4 The <code>has_many :through</code> Association</a></h3><p>A <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many :through</code></a> association is often used to set up a many-to-many connection with another model. This association indicates that the declaring model can be matched with zero or more instances of another model by proceeding <em>through</em> a third model. For example, consider a medical practice where patients make appointments to see physicians. The relevant association declarations could look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Physician</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:appointments</span>
  <span class="n">has_many</span> <span class="ss">:patients</span><span class="p">,</span> <span class="ss">through: :appointments</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Appointment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:physician</span>
  <span class="n">belongs_to</span> <span class="ss">:patient</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Patient</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:appointments</span>
  <span class="n">has_many</span> <span class="ss">:physicians</span><span class="p">,</span> <span class="ss">through: :appointments</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Physician < ApplicationRecord
  has_many :appointments
  has_many :patients, through: :appointments
end

class Appointment < ApplicationRecord
  belongs_to :physician
  belongs_to :patient
end

class Patient < ApplicationRecord
  has_many :appointments
  has_many :physicians, through: :appointments
end
">Copy</button>
</div>
<p><img src="images/association_basics/has_many_through.png" alt="has_many :through Association Diagram"></p><p>The corresponding migration might look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAppointments</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:physicians</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:patients</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:appointments</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:physician</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:patient</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:appointment_date</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAppointments < ActiveRecord::Migration[7.2]
  def change
    create_table :physicians do |t|
      t.string :name
      t.timestamps
    end

    create_table :patients do |t|
      t.string :name
      t.timestamps
    end

    create_table :appointments do |t|
      t.belongs_to :physician
      t.belongs_to :patient
      t.datetime :appointment_date
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>The collection of join models can be managed via the <a href="#has-many-association-reference"><code>has_many</code> association methods</a>.
For example, if you assign:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">physician</span><span class="p">.</span><span class="nf">patients</span> <span class="o">=</span> <span class="n">patients</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="physician.patients = patients
">Copy</button>
</div>
<p>Then new join models are automatically created for the newly associated objects.
If some that existed previously are now missing, then their join rows are automatically deleted.</p><div class="warning"><p>Automatic deletion of join models is direct, no destroy callbacks are triggered.</p></div><p>The <code>has_many :through</code> association is also useful for setting up "shortcuts" through nested <code>has_many</code> associations. For example, if a document has many sections, and a section has many paragraphs, you may sometimes want to get a simple collection of all paragraphs in the document. You could set that up this way:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Document</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:sections</span>
  <span class="n">has_many</span> <span class="ss">:paragraphs</span><span class="p">,</span> <span class="ss">through: :sections</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Section</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:document</span>
  <span class="n">has_many</span> <span class="ss">:paragraphs</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Paragraph</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:section</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Document < ApplicationRecord
  has_many :sections
  has_many :paragraphs, through: :sections
end

class Section < ApplicationRecord
  belongs_to :document
  has_many :paragraphs
end

class Paragraph < ApplicationRecord
  belongs_to :section
end
">Copy</button>
</div>
<p>With <code>through: :sections</code> specified, Rails will now understand:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@document</span><span class="p">.</span><span class="nf">paragraphs</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@document.paragraphs
">Copy</button>
</div>
<h3 id="the-has-one-through-association"><a class="anchorlink" href="#the-has-one-through-association">2.5 The <code>has_one :through</code> Association</a></h3><p>A <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one :through</code></a> association sets up a one-to-one connection with another model. This association indicates
that the declaring model can be matched with one instance of another model by proceeding <em>through</em> a third model.
For example, if each supplier has one account, and each account is associated with one account history, then the
supplier model could look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
  <span class="n">has_one</span> <span class="ss">:account_history</span><span class="p">,</span> <span class="ss">through: :account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">has_one</span> <span class="ss">:account_history</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">AccountHistory</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account
  has_one :account_history, through: :account
end

class Account < ApplicationRecord
  belongs_to :supplier
  has_one :account_history
end

class AccountHistory < ApplicationRecord
  belongs_to :account
end
">Copy</button>
</div>
<p><img src="images/association_basics/has_one_through.png" alt="has_one :through Association Diagram"></p><p>The corresponding migration might look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAccountHistories</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:account_histories</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:account</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:credit_rating</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAccountHistories < ActiveRecord::Migration[7.2]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.belongs_to :supplier
      t.string :account_number
      t.timestamps
    end

    create_table :account_histories do |t|
      t.belongs_to :account
      t.integer :credit_rating
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<h3 id="the-has-and-belongs-to-many-association"><a class="anchorlink" href="#the-has-and-belongs-to-many-association">2.6 The <code>has_and_belongs_to_many</code> Association</a></h3><p>A <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many"><code>has_and_belongs_to_many</code></a> association creates a direct many-to-many connection with another model, with no intervening model.
This association indicates that each instance of the declaring model refers to zero or more instances of another model.
For example, if your application includes assemblies and parts, with each assembly having many parts and each part appearing in many assemblies, you could declare the models this way:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly < ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part < ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p><img src="images/association_basics/habtm.png" alt="has_and_belongs_to_many Association Diagram"></p><p>The corresponding migration might look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesAndParts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:assemblies</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:parts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:part_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:assembly</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:part</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAssembliesAndParts < ActiveRecord::Migration[7.2]
  def change
    create_table :assemblies do |t|
      t.string :name
      t.timestamps
    end

    create_table :parts do |t|
      t.string :part_number
      t.timestamps
    end

    create_table :assemblies_parts, id: false do |t|
      t.belongs_to :assembly
      t.belongs_to :part
    end
  end
end
">Copy</button>
</div>
<h3 id="choosing-between-belongs-to-and-has-one"><a class="anchorlink" href="#choosing-between-belongs-to-and-has-one">2.7 Choosing Between <code>belongs_to</code> and <code>has_one</code></a></h3><p>If you want to set up a one-to-one relationship between two models, you'll need to add <code>belongs_to</code> to one, and <code>has_one</code> to the other. How do you know which is which?</p><p>The distinction is in where you place the foreign key (it goes on the table for the class declaring the <code>belongs_to</code> association), but you should give some thought to the actual meaning of the data as well. The <code>has_one</code> relationship says that one of something is yours - that is, that something points back to you. For example, it makes more sense to say that a supplier owns an account than that an account owns a supplier. This suggests that the correct relationships are like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account
end

class Account < ApplicationRecord
  belongs_to :supplier
end
">Copy</button>
</div>
<p>The corresponding migration might look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateSuppliers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span>  <span class="ss">:supplier_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">:supplier_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateSuppliers < ActiveRecord::Migration[7.2]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.bigint  :supplier_id
      t.string  :account_number
      t.timestamps
    end

    add_index :accounts, :supplier_id
  end
end
">Copy</button>
</div>
<div class="note"><p>Using <code>t.bigint :supplier_id</code> makes the foreign key naming obvious and explicit. In current versions of Rails, you can abstract away this implementation detail by using <code>t.references :supplier</code> instead.</p></div><h3 id="choosing-between-has-many-through-and-has-and-belongs-to-many"><a class="anchorlink" href="#choosing-between-has-many-through-and-has-and-belongs-to-many">2.8 Choosing Between <code>has_many :through</code> and <code>has_and_belongs_to_many</code></a></h3><p>Rails offers two different ways to declare a many-to-many relationship between models. The first way is to use <code>has_and_belongs_to_many</code>, which allows you to make the association directly:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly < ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part < ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p>The second way to declare a many-to-many relationship is to use <code>has_many :through</code>. This makes the association indirectly, through a join model:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:manifests</span>
  <span class="n">has_many</span> <span class="ss">:parts</span><span class="p">,</span> <span class="ss">through: :manifests</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Manifest</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:assembly</span>
  <span class="n">belongs_to</span> <span class="ss">:part</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:manifests</span>
  <span class="n">has_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">through: :manifests</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly < ApplicationRecord
  has_many :manifests
  has_many :parts, through: :manifests
end

class Manifest < ApplicationRecord
  belongs_to :assembly
  belongs_to :part
end

class Part < ApplicationRecord
  has_many :manifests
  has_many :assemblies, through: :manifests
end
">Copy</button>
</div>
<p>The simplest rule of thumb is that you should set up a <code>has_many :through</code> relationship if you need to work with the relationship model as an independent entity. If you don't need to do anything with the relationship model, it may be simpler to set up a <code>has_and_belongs_to_many</code> relationship (though you'll need to remember to create the joining table in the database).</p><p>You should use <code>has_many :through</code> if you need validations, callbacks, or extra attributes on the join model.</p><p>While <code>has_and_belongs_to_many</code> suggests creating a join table with no primary key via <code>id: false</code>, consider using a composite primary key for the join table in the <code>has_many :through</code> relationship.
For example, it's recommended to use <code>create_table :manifests, primary_key: [:assembly_id, :part_id]</code> in the example above.</p><h3 id="polymorphic-associations"><a class="anchorlink" href="#polymorphic-associations">2.9 Polymorphic Associations</a></h3><p>A slightly more advanced twist on associations is the <em>polymorphic association</em>. With polymorphic associations, a model can belong to more than one other model, on a single association. For example, you might have a picture model that belongs to either an employee model or a product model. Here's how this could be declared:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Picture</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">as: :imageable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">as: :imageable</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Picture < ApplicationRecord
  belongs_to :imageable, polymorphic: true
end

class Employee < ApplicationRecord
  has_many :pictures, as: :imageable
end

class Product < ApplicationRecord
  has_many :pictures, as: :imageable
end
">Copy</button>
</div>
<p>You can think of a polymorphic <code>belongs_to</code> declaration as setting up an interface that any other model can use. From an instance of the <code>Employee</code> model, you can retrieve a collection of pictures: <code>@employee.pictures</code>.</p><p>Similarly, you can retrieve <code>@product.pictures</code>.</p><p>If you have an instance of the <code>Picture</code> model, you can get to its parent via <code>@picture.imageable</code>. To make this work, you need to declare both a foreign key column and a type column in the model that declares the polymorphic interface:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreatePictures</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:pictures</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span>  <span class="ss">:imageable_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:imageable_type</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="p">[</span><span class="ss">:imageable_type</span><span class="p">,</span> <span class="ss">:imageable_id</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreatePictures < ActiveRecord::Migration[7.2]
  def change
    create_table :pictures do |t|
      t.string  :name
      t.bigint  :imageable_id
      t.string  :imageable_type
      t.timestamps
    end

    add_index :pictures, [:imageable_type, :imageable_id]
  end
end
">Copy</button>
</div>
<p>This migration can be simplified by using the <code>t.references</code> form:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreatePictures</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:pictures</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreatePictures < ActiveRecord::Migration[7.2]
  def change
    create_table :pictures do |t|
      t.string :name
      t.references :imageable, polymorphic: true
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<div class="note"><p>Since polymorphic associations rely on storing class names in the
database, that data must remain synchronized with the class name used by the
Ruby code. When renaming a class, make sure to update the data in the
polymorphic type column.</p></div><p><img src="images/association_basics/polymorphic.png" alt="Polymorphic Association Diagram"></p><h3 id="associations-between-models-with-composite-primary-keys"><a class="anchorlink" href="#associations-between-models-with-composite-primary-keys">2.10 Associations between Models with Composite Primary Keys</a></h3><p>Rails is often able to infer the primary key - foreign key information between associated models with composite
primary keys without needing extra information. Take the following example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:shop_id</span><span class="p">,</span> <span class="ss">:id</span><span class="p">]</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:order</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Order < ApplicationRecord
  self.primary_key = [:shop_id, :id]
  has_many :books
end

class Book < ApplicationRecord
  belongs_to :order
end
">Copy</button>
</div>
<p>Here, Rails assumes that the <code>:id</code> column should be used as the primary key for the association between an order
and its books, just as with a regular <code>has_many</code> / <code>belongs_to</code> association. It will infer that the foreign key column
on the <code>books</code> table is <code>:order_id</code>. Accessing a book's order:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">id: </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="ss">status: </span><span class="s2">"pending"</span><span class="p">)</span>
<span class="n">book</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"A Cool Book"</span><span class="p">)</span>

<span class="n">book</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">order</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="order = Order.create!(id: [1, 2], status: &quot;pending&quot;)
book = order.books.create!(title: &quot;A Cool Book&quot;)

book.reload.order
">Copy</button>
</div>
<p>will generate the following SQL to access the order:</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">orders</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">2</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM orders WHERE id = 2
">Copy</button>
</div>
<p>This only works if the model's composite primary key contains the <code>:id</code> column, <em>and</em> the column is unique for
all records. In order to use the full composite primary key in associations, set the <code>query_constraints</code> option on
the association. This option specifies a composite foreign key on the association: all columns in the foreign key will
be used when querying the associated record(s). For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">]</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">query_constraints: </span><span class="p">[</span><span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">]</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">query_constraints: </span><span class="p">[</span><span class="ss">:author_first_name</span><span class="p">,</span> <span class="ss">:author_last_name</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  self.primary_key = [:first_name, :last_name]
  has_many :books, query_constraints: [:first_name, :last_name]
end

class Book < ApplicationRecord
  belongs_to :author, query_constraints: [:author_first_name, :author_last_name]
end
">Copy</button>
</div>
<p>Accessing a book's author:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">first_name: </span><span class="s2">"Jane"</span><span class="p">,</span> <span class="ss">last_name: </span><span class="s2">"Doe"</span><span class="p">)</span>
<span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"A Cool Book"</span><span class="p">)</span>

<span class="n">book</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.create!(first_name: &quot;Jane&quot;, last_name: &quot;Doe&quot;)
book = author.books.create!(title: &quot;A Cool Book&quot;)

book.reload.author
">Copy</button>
</div>
<p>will use <code>:first_name</code> <em>and</em> <code>:last_name</code> in the SQL query:</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">authors</span> <span class="k">WHERE</span> <span class="n">first_name</span> <span class="o">=</span> <span class="s1">'Jane'</span> <span class="k">AND</span> <span class="n">last_name</span> <span class="o">=</span> <span class="s1">'Doe'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM authors WHERE first_name = 'Jane' AND last_name = 'Doe'
">Copy</button>
</div>
<h3 id="self-joins"><a class="anchorlink" href="#self-joins">2.11 Self Joins</a></h3><p>In designing a data model, you will sometimes find a model that should have a relation to itself. For example, you may want to store all employees in a single database model, but be able to trace relationships such as between manager and subordinates. This situation can be modeled with self-joining associations:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:subordinates</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Employee"</span><span class="p">,</span>
                          <span class="ss">foreign_key: </span><span class="s2">"manager_id"</span>

  <span class="n">belongs_to</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Employee"</span><span class="p">,</span> <span class="ss">optional: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Employee < ApplicationRecord
  has_many :subordinates, class_name: &quot;Employee&quot;,
                          foreign_key: &quot;manager_id&quot;

  belongs_to :manager, class_name: &quot;Employee&quot;, optional: true
end
">Copy</button>
</div>
<p>With this setup, you can retrieve <code>@employee.subordinates</code> and <code>@employee.manager</code>.</p><p>In your migrations/schema, you will add a references column to the model itself.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateEmployees</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:employees</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">to_table: :employees</span> <span class="p">}</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateEmployees < ActiveRecord::Migration[7.2]
  def change
    create_table :employees do |t|
      t.references :manager, foreign_key: { to_table: :employees }
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<div class="note"><p>The <code>to_table</code> option passed to <code>foreign_key</code> and more are explained in <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_reference"><code>SchemaStatements#add_reference</code></a>.</p></div><h2 id="tips-tricks-and-warnings"><a class="anchorlink" href="#tips-tricks-and-warnings">3 Tips, Tricks, and Warnings</a></h2><p>Here are a few things you should know to make efficient use of Active Record associations in your Rails applications:</p>
<ul>
<li>Controlling caching</li>
<li>Avoiding name collisions</li>
<li>Updating the schema</li>
<li>Controlling association scope</li>
<li>Bi-directional associations</li>
</ul>
<h3 id="controlling-caching"><a class="anchorlink" href="#controlling-caching">3.1 Controlling Caching</a></h3><p>All of the association methods are built around caching, which keeps the result of the most recent query available for further operations. The cache is even shared across methods. For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># retrieves books from the database</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">load</span>

<span class="c1"># uses the cached copy of books</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>

<span class="c1"># uses the cached copy of books</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">empty?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# retrieves books from the database
author.books.load

# uses the cached copy of books
author.books.size

# uses the cached copy of books
author.books.empty?
">Copy</button>
</div>
<p>But what if you want to reload the cache, because data might have been changed by some other part of the application? Just call <code>reload</code> on the association:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># retrieves books from the database</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">load</span>

<span class="c1"># uses the cached copy of books</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>

<span class="c1"># discards the cached copy of books and goes back to the database</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">empty?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# retrieves books from the database
author.books.load

# uses the cached copy of books
author.books.size

# discards the cached copy of books and goes back to the database
author.books.reload.empty?
">Copy</button>
</div>
<h3 id="avoiding-name-collisions"><a class="anchorlink" href="#avoiding-name-collisions">3.2 Avoiding Name Collisions</a></h3><p>You are not free to use just any name for your associations. Because creating an association adds a method with that name to the model, it is a bad idea to give an association a name that is already used for an instance method of <code>ActiveRecord::Base</code>. The association method would override the base method and break things. For instance, <code>attributes</code> or <code>connection</code> are bad names for associations.</p><h3 id="updating-the-schema"><a class="anchorlink" href="#updating-the-schema">3.3 Updating the Schema</a></h3><p>Associations are extremely useful, but they are not magic. You are responsible for maintaining your database schema to match your associations. In practice, this means two things, depending on what sort of associations you are creating. For <code>belongs_to</code> associations you need to create foreign keys, and for <code>has_and_belongs_to_many</code> associations you need to create the appropriate join table.</p><h4 id="creating-foreign-keys-for-belongs-to-associations"><a class="anchorlink" href="#creating-foreign-keys-for-belongs-to-associations">3.3.1 Creating Foreign Keys for <code>belongs_to</code> Associations</a></h4><p>When you declare a <code>belongs_to</code> association, you need to create foreign keys as appropriate. For example, consider this model:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>This declaration needs to be backed up by a corresponding foreign key column in the books table. For a brand new table, the migration might look something like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span>   <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>     <span class="ss">:book_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:author</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateBooks < ActiveRecord::Migration[7.2]
  def change
    create_table :books do |t|
      t.datetime   :published_at
      t.string     :book_number
      t.references :author
    end
  end
end
">Copy</button>
</div>
<p>Whereas for an existing table, it might look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddAuthorToBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_reference</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">:author</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class AddAuthorToBooks < ActiveRecord::Migration[7.2]
  def change
    add_reference :books, :author
  end
end
">Copy</button>
</div>
<div class="note"><p>If you wish to <a href="active_record_migrations.html#foreign-keys">enforce referential integrity at the database level</a>, add the <code>foreign_key: true</code> option to the ‘reference’ column declarations above.</p></div><h4 id="creating-join-tables-for-has-and-belongs-to-many-associations"><a class="anchorlink" href="#creating-join-tables-for-has-and-belongs-to-many-associations">3.3.2 Creating Join Tables for <code>has_and_belongs_to_many</code> Associations</a></h4><p>If you create a <code>has_and_belongs_to_many</code> association, you need to explicitly create the joining table. Unless the name of the join table is explicitly specified by using the <code>:join_table</code> option, Active Record creates the name by using the lexical order of the class names. So a join between author and book models will give the default join table name of "authors_books" because "a" outranks "b" in lexical ordering.</p><div class="warning"><p>The precedence between model names is calculated using the <code>&lt;=&gt;</code> operator for <code>String</code>. This means that if the strings are of different lengths, and the strings are equal when compared up to the shortest length, then the longer string is considered of higher lexical precedence than the shorter one. For example, one would expect the tables "paper_boxes" and "papers" to generate a join table name of "papers_paper_boxes" because of the length of the name "paper_boxes", but it in fact generates a join table name of "paper_boxes_papers" (because the underscore '_' is lexicographically <em>less</em> than 's' in common encodings).</p></div><p>Whatever the name, you must manually generate the join table with an appropriate migration. For example, consider these associations:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly < ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part < ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p>These need to be backed up by a migration to create the <code>assemblies_parts</code> table. This table should be created without a primary key:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesPartsJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="ss">:assembly_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="ss">:part_id</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:assembly_id</span>
    <span class="n">add_index</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:part_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAssembliesPartsJoinTable < ActiveRecord::Migration[7.2]
  def change
    create_table :assemblies_parts, id: false do |t|
      t.bigint :assembly_id
      t.bigint :part_id
    end

    add_index :assemblies_parts, :assembly_id
    add_index :assemblies_parts, :part_id
  end
end
">Copy</button>
</div>
<p>We pass <code>id: false</code> to <code>create_table</code> because that table does not represent a model. That's required for the association to work properly. If you observe any strange behavior in a <code>has_and_belongs_to_many</code> association like mangled model IDs, or exceptions about conflicting IDs, chances are you forgot that bit.</p><p>For simplicity, you can also use the method <code>create_join_table</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesPartsJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_join_table</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">:parts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:assembly_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:part_id</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAssembliesPartsJoinTable < ActiveRecord::Migration[7.2]
  def change
    create_join_table :assemblies, :parts do |t|
      t.index :assembly_id
      t.index :part_id
    end
  end
end
">Copy</button>
</div>
<h3 id="controlling-association-scope"><a class="anchorlink" href="#controlling-association-scope">3.4 Controlling Association Scope</a></h3><p>By default, associations look for objects only within the current module's scope. This can be important when you declare Active Record models within a module. For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module MyApplication
  module Business
    class Supplier < ApplicationRecord
      has_one :account
    end

    class Account < ApplicationRecord
      belongs_to :supplier
    end
  end
end
">Copy</button>
</div>
<p>This will work fine, because both the <code>Supplier</code> and the <code>Account</code> class are defined within the same scope (<code>MyApplication::Business</code>). This organization allows structuring models into folders based on their scope, without having to explicitly add the scope to every association:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/my_application/business/supplier.rb</span>
<span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/models/my_application/business/supplier.rb
module MyApplication
  module Business
    class Supplier < ApplicationRecord
      has_one :account
    end
  end
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/my_application/business/account.rb</span>
<span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/models/my_application/business/account.rb
module MyApplication
  module Business
    class Account < ApplicationRecord
      belongs_to :supplier
    end
  end
end
">Copy</button>
</div>
<p>It is crucial to note that this does not affect the naming of your tables. For instance, if there is a <code>MyApplication::Business::Supplier</code> model, there must also be a <code>my_application_business_suppliers</code> table.</p><p>Note that the following will <em>not</em> work, because <code>Supplier</code> and <code>Account</code> are defined in different scopes (<code>MyApplication::Business</code> and <code>MyApplication::Billing</code>):</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Billing</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module MyApplication
  module Business
    class Supplier < ApplicationRecord
      has_one :account
    end
  end

  module Billing
    class Account < ApplicationRecord
      belongs_to :supplier
    end
  end
end
">Copy</button>
</div>
<p>To associate a model with a model in a different namespace, you must specify the complete class name in your association declaration:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span>
        <span class="ss">class_name: </span><span class="s2">"MyApplication::Billing::Account"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Billing</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span>
        <span class="ss">class_name: </span><span class="s2">"MyApplication::Business::Supplier"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module MyApplication
  module Business
    class Supplier < ApplicationRecord
      has_one :account,
        class_name: &quot;MyApplication::Billing::Account&quot;
    end
  end

  module Billing
    class Account < ApplicationRecord
      belongs_to :supplier,
        class_name: &quot;MyApplication::Business::Supplier&quot;
    end
  end
end
">Copy</button>
</div>
<h3 id="bi-directional-associations"><a class="anchorlink" href="#bi-directional-associations">3.5 Bi-directional Associations</a></h3><p>It's normal for associations to work in two directions, requiring declaration on two different models:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books
end

class Book < ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>Active Record will attempt to automatically identify that these two models share
a bi-directional association based on the association name. This information
allows Active Record to:</p>
<ul>
<li><p>Prevent needless queries for already-loaded data:</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">all?</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
<span class="gp">irb&gt;</span><span class="w">   </span><span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">equal?</span><span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="c1"># No additional queries executed here</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="k">end</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.first
author.books.all? do |book|
  book.author.equal?(author) # No additional queries executed here
end
">Copy</button>
</div></li>
<li><p>Prevent inconsistent data (since there is only one copy of the <code>Author</code> object
loaded):</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"Changed Name"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.first
book = author.books.first
author.name == book.author.name
author.name = &quot;Changed Name&quot;
author.name == book.author.name
">Copy</button>
</div></li>
<li><p>Autosave associations in more cases:</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">save!</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.new
book = author.books.new
book.save!
book.persisted?
author.persisted?
">Copy</button>
</div></li>
<li><p>Validate the <a href="active_record_validations.html#presence">presence</a> and
<a href="active_record_validations.html#absence">absence</a> of associations in more
cases:</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"Author must exist"</span><span class="p">]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="book = Book.new
book.valid?
book.errors.full_messages
author = Author.new
book = author.books.new
book.valid?
">Copy</button>
</div></li>
</ul>
<p>Active Record supports automatic identification for most associations with standard names. However, bi-directional associations that contain the <code>:through</code> or <code>:foreign_key</code> options will not be automatically identified.</p><p>Custom scopes on the opposite association also prevent automatic identification, as do custom scopes on the association itself unless <a href="configuring.html#config-active-record-automatic-scope-inversing"><code>config.active_record.automatic_scope_inversing</code></a> is set to true (the default for new applications).</p><p>For example, consider the following model declarations:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:writer</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'Author'</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s1">'author_id'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books
end

class Book < ApplicationRecord
  belongs_to :writer, class_name: 'Author', foreign_key: 'author_id'
end
">Copy</button>
</div>
<p>Because of the <code>:foreign_key</code> option, Active Record will no longer automatically
recognize the bi-directional association. This can cause your application to:</p>
<ul>
<li><p>Execute needless queries for the same data (in this example causing N+1 queries):</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">any?</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
<span class="gp">irb&gt;</span><span class="w">   </span><span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">equal?</span><span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="c1"># This executes an author query for every book</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="k">end</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.first
author.books.any? do |book|
  book.author.equal?(author) # This executes an author query for every book
end
">Copy</button>
</div></li>
<li><p>Reference multiple copies of a model with inconsistent data:</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"Changed Name"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">name</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.first
book = author.books.first
author.name == book.author.name
author.name = &quot;Changed Name&quot;
author.name == book.author.name
">Copy</button>
</div></li>
<li><p>Fail to autosave associations:</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">save!</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.new
book = author.books.new
book.save!
book.persisted?
author.persisted?
">Copy</button>
</div></li>
<li><p>Fail to validate presence or absence:</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"Author must exist"</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.new
book = author.books.new
book.valid?
book.errors.full_messages
">Copy</button>
</div></li>
</ul>
<p>Active Record provides the <code>:inverse_of</code> option so you can explicitly declare bi-directional associations:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: </span><span class="s1">'writer'</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:writer</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'Author'</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s1">'author_id'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, inverse_of: 'writer'
end

class Book < ApplicationRecord
  belongs_to :writer, class_name: 'Author', foreign_key: 'author_id'
end
">Copy</button>
</div>
<p>By including the <code>:inverse_of</code> option in the <code>has_many</code> association declaration,
Active Record will now recognize the bi-directional association and behave as in
the initial examples above.</p><h2 id="detailed-association-reference"><a class="anchorlink" href="#detailed-association-reference">4 Detailed Association Reference</a></h2><p>The following sections give the details of each type of association, including the methods that they add and the options that you can use when declaring an association.</p><h3 id="belongs-to-association-reference"><a class="anchorlink" href="#belongs-to-association-reference">4.1 <code>belongs_to</code> Association Reference</a></h3><p>In database terms, the <code>belongs_to</code> association says that this model's table contains a column which represents a reference to another table.
This can be used to set up one-to-one or one-to-many relations, depending on the setup.
If the table of the other class contains the reference in a one-to-one relation, then you should use <code>has_one</code> instead.</p><h4 id="methods-added-by-belongs-to"><a class="anchorlink" href="#methods-added-by-belongs-to">4.1.1 Methods Added by <code>belongs_to</code></a></h4><p>When you declare a <code>belongs_to</code> association, the declaring class automatically gains 8 methods related to the association:</p>
<ul>
<li><code>association</code></li>
<li><code>association=(associate)</code></li>
<li><code>build_association(attributes = {})</code></li>
<li><code>create_association(attributes = {})</code></li>
<li><code>create_association!(attributes = {})</code></li>
<li><code>reload_association</code></li>
<li><code>reset_association</code></li>
<li><code>association_changed?</code></li>
<li><code>association_previously_changed?</code></li>
</ul>
<p>In all of these methods, <code>association</code> is replaced with the symbol passed as the first argument to <code>belongs_to</code>. For example, given the declaration:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>Each instance of the <code>Book</code> model will have these methods:</p>
<ul>
<li><code>author</code></li>
<li><code>author=</code></li>
<li><code>build_author</code></li>
<li><code>create_author</code></li>
<li><code>create_author!</code></li>
<li><code>reload_author</code></li>
<li><code>reset_author</code></li>
<li><code>author_changed?</code></li>
<li><code>author_previously_changed?</code></li>
</ul>
<div class="note"><p>When initializing a new <code>has_one</code> or <code>belongs_to</code> association you must use the <code>build_</code> prefix to build the association, rather than the <code>association.build</code> method that would be used for <code>has_many</code> or <code>has_and_belongs_to_many</code> associations. To create one, use the <code>create_</code> prefix.</p></div><h5 id="methods-added-by-belongs-to-association"><a class="anchorlink" href="#methods-added-by-belongs-to-association">4.1.1.1 <code>association</code></a></h5><p>The <code>association</code> method returns the associated object, if any. If no associated object is found, it returns <code>nil</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author = @book.author
">Copy</button>
</div>
<p>If the associated object has already been retrieved from the database for this object, the cached version will be returned. To override this behavior (and force a database read), call <code>#reload_association</code> on the parent object.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">reload_author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author = @book.reload_author
">Copy</button>
</div>
<p>To unload the cached version of the associated object—causing the next access, if any, to query it from the database—call <code>#reset_association</code> on the parent object.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">reset_author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book.reset_author
">Copy</button>
</div>
<h5 id="methods-added-by-belongs-to-association-associate"><a class="anchorlink" href="#methods-added-by-belongs-to-association-associate">4.1.1.2 <code>association=(associate)</code></a></h5><p>The <code>association=</code> method assigns an associated object to this object. Behind the scenes, this means extracting the primary key from the associated object and setting this object's foreign key to the same value.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="vi">@author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book.author = @author
">Copy</button>
</div>
<h5 id="methods-added-by-belongs-to-build-association-attributes"><a class="anchorlink" href="#methods-added-by-belongs-to-build-association-attributes">4.1.1.3 <code>build_association(attributes = {})</code></a></h5><p>The <code>build_association</code> method returns a new object of the associated type. This object will be instantiated from the passed attributes, and the link through this object's foreign key will be set, but the associated object will <em>not</em> yet be saved.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">build_author</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span>
                             <span class="ss">author_name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author = @book.build_author(author_number: 123,
                             author_name: &quot;John Doe&quot;)
">Copy</button>
</div>
<h5 id="methods-added-by-belongs-to-create-association-attributes"><a class="anchorlink" href="#methods-added-by-belongs-to-create-association-attributes">4.1.1.4 <code>create_association(attributes = {})</code></a></h5><p>The <code>create_association</code> method returns a new object of the associated type. This object will be instantiated from the passed attributes, the link through this object's foreign key will be set, and, once it passes all of the validations specified on the associated model, the associated object <em>will</em> be saved.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">create_author</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span>
                              <span class="ss">author_name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author = @book.create_author(author_number: 123,
                              author_name: &quot;John Doe&quot;)
">Copy</button>
</div>
<h5 id="methods-added-by-belongs-to-create-association-bang-attributes"><a class="anchorlink" href="#methods-added-by-belongs-to-create-association-bang-attributes">4.1.1.5 <code>create_association!(attributes = {})</code></a></h5><p>Does the same as <code>create_association</code> above, but raises <code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p><h5 id="association-changed-questionmark"><a class="anchorlink" href="#association-changed-questionmark">4.1.1.6 <code>association_changed?</code></a></h5><p>The <code>association_changed?</code> method returns true if a new associated object has been assigned and the foreign key will be updated in the next save.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="c1"># =&gt; #&lt;Author author_number: 123, author_name: "John Doe"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; false</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">second</span> <span class="c1"># =&gt; #&lt;Author author_number: 456, author_name: "Jane Smith"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; true</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">save!</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book.author # => #<Author author_number: 123, author_name: &quot;John Doe&quot;>
@book.author_changed? # => false

@book.author = Author.second # => #<Author author_number: 456, author_name: &quot;Jane Smith&quot;>
@book.author_changed? # => true

@book.save!
@book.author_changed? # => false
">Copy</button>
</div>
<h5 id="association-previously-changed-questionmark"><a class="anchorlink" href="#association-previously-changed-questionmark">4.1.1.7 <code>association_previously_changed?</code></a></h5><p>The <code>association_previously_changed?</code> method returns true if the previous save updated the association to reference a new associate object.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="c1"># =&gt; #&lt;Author author_number: 123, author_name: "John Doe"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_previously_changed?</span> <span class="c1"># =&gt; false</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">second</span> <span class="c1"># =&gt; #&lt;Author author_number: 456, author_name: "Jane Smith"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">save!</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_previously_changed?</span> <span class="c1"># =&gt; true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book.author # => #<Author author_number: 123, author_name: &quot;John Doe&quot;>
@book.author_previously_changed? # => false

@book.author = Author.second # => #<Author author_number: 456, author_name: &quot;Jane Smith&quot;>
@book.save!
@book.author_previously_changed? # => true
">Copy</button>
</div>
<h4 id="options-for-belongs-to"><a class="anchorlink" href="#options-for-belongs-to">4.1.2 Options for <code>belongs_to</code></a></h4><p>While Rails uses intelligent defaults that will work well in most situations, there may be times when you want to customize the behavior of the <code>belongs_to</code> association reference. Such customizations can easily be accomplished by passing options and scope blocks when you create the association. For example, this association uses two such options:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: :books_updated_at</span><span class="p">,</span>
    <span class="ss">counter_cache: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, touch: :books_updated_at,
    counter_cache: true
end
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to"><code>belongs_to</code></a> association supports these options:</p>
<ul>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:counter_cache</code></li>
<li><code>:default</code></li>
<li><code>:dependent</code></li>
<li><code>:ensuring_owner_was</code></li>
<li><code>:foreign_key</code></li>
<li><code>:foreign_type</code></li>
<li><code>:primary_key</code></li>
<li><code>:inverse_of</code></li>
<li><code>:optional</code></li>
<li><code>:polymorphic</code></li>
<li><code>:required</code></li>
<li><code>:strict_loading</code></li>
<li><code>:touch</code></li>
<li><code>:validate</code></li>
</ul>
<h5 id="options-for-belongs-to-autosave"><a class="anchorlink" href="#options-for-belongs-to-autosave">4.1.2.1 <code>:autosave</code></a></h5><p>If you set the <code>:autosave</code> option to <code>true</code>, Rails will save any loaded association members and destroy members that are marked for destruction whenever you save the parent object. Setting <code>:autosave</code> to <code>false</code> is not the same as not setting the <code>:autosave</code> option. If the <code>:autosave</code> option is not present, then new associated objects will be saved, but updated associated objects will not be saved.</p><h5 id="options-for-belongs-to-class-name"><a class="anchorlink" href="#options-for-belongs-to-class-name">4.1.2.2 <code>:class_name</code></a></h5><p>If the name of the other model cannot be derived from the association name, you can use the <code>:class_name</code> option to supply the model name. For example, if a book belongs to an author, but the actual name of the model containing authors is <code>Patron</code>, you'd set things up this way:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Patron"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, class_name: &quot;Patron&quot;
end
">Copy</button>
</div>
<h5 id="options-for-belongs-to-counter-cache"><a class="anchorlink" href="#options-for-belongs-to-counter-cache">4.1.2.3 <code>:counter_cache</code></a></h5><p>The <code>:counter_cache</code> option can be used to make finding the number of belonging objects more efficient. Consider these models:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author
end

class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>With these declarations, asking for the value of <code>@author.books.size</code> requires making a call to the database to perform a <code>COUNT(*)</code> query. To avoid this call, you can add a counter cache to the <em>belonging</em> model:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">counter_cache: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, counter_cache: true
end

class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>With this declaration, Rails will keep the cache value up to date, and then return that value in response to the <code>size</code> method.</p><p>Although the <code>:counter_cache</code> option is specified on the model that includes
the <code>belongs_to</code> declaration, the actual column must be added to the
<em>associated</em> (<code>has_many</code>) model. In the case above, you would need to add a
column named <code>books_count</code> to the <code>Author</code> model.</p><p>You can override the default column name by specifying a custom column name in
the <code>counter_cache</code> declaration instead of <code>true</code>. For example, to use
<code>count_of_books</code> instead of <code>books_count</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">counter_cache: :count_of_books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, counter_cache: :count_of_books
end

class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<div class="note"><p>You only need to specify the <code>:counter_cache</code> option on the <code>belongs_to</code>
side of the association.</p></div><p>Counter cache columns are added to the owner model's list of read-only
attributes through <code>attr_readonly</code>.</p><p>If for some reason you change the value of an owner model's primary key, and do
not also update the foreign keys of the counted models, then the counter cache
may have stale data. In other words, any orphaned models will still count
towards the counter. To fix a stale counter cache, use <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/CounterCache/ClassMethods.html#method-i-reset_counters"><code>reset_counters</code></a>.</p><h5 id="default"><a class="anchorlink" href="#default">4.1.2.4 <code>:default</code></a></h5><p>When set to <code>true</code>, the association will not have its presence validated.</p><h5 id="options-for-belongs-to-dependent"><a class="anchorlink" href="#options-for-belongs-to-dependent">4.1.2.5 <code>:dependent</code></a></h5><p>If you set the <code>:dependent</code> option to:</p>
<ul>
<li><code>:destroy</code>, when the object is destroyed, <code>destroy</code> will be called on its
associated objects.</li>
<li><code>:delete</code>, when the object is destroyed, all its associated objects will be
deleted directly from the database without calling their <code>destroy</code> method.</li>
<li><code>:destroy_async</code>: when the object is destroyed, an <code>ActiveRecord::DestroyAssociationAsyncJob</code>
job is enqueued which will call destroy on its associated objects. Active Job must be set up
for this to work. Do not use this option if the association is backed by foreign key
constraints in your database. The foreign key constraint actions will occur inside the same
transaction that deletes its owner.</li>
</ul>
<div class="warning"><p>You should not specify this option on a <code>belongs_to</code> association that is connected with a <code>has_many</code> association on the other class. Doing so can lead to orphaned records in your database.</p></div><h5 id="options-for-belongs-to-ensuring-owner-was"><a class="anchorlink" href="#options-for-belongs-to-ensuring-owner-was">4.1.2.6 <code>:ensuring_owner_was</code></a></h5><p>Specifies an instance method to be called on the owner. The method must return true in order for the associated records to be deleted in a background job.</p><h5 id="options-for-belongs-to-foreign-key"><a class="anchorlink" href="#options-for-belongs-to-foreign-key">4.1.2.7 <code>:foreign_key</code></a></h5><p>By convention, Rails assumes that the column used to hold the foreign key on this model is the name of the association with the suffix <code>_id</code> added. The <code>:foreign_key</code> option lets you set the name of the foreign key directly:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Patron"</span><span class="p">,</span>
                      <span class="ss">foreign_key: </span><span class="s2">"patron_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, class_name: &quot;Patron&quot;,
                      foreign_key: &quot;patron_id&quot;
end
">Copy</button>
</div>
<div class="info"><p>In any case, Rails will not create foreign key columns for you. You need to explicitly define them as part of your migrations.</p></div><h5 id="options-for-belongs-to-foreign-type"><a class="anchorlink" href="#options-for-belongs-to-foreign-type">4.1.2.8 <code>:foreign_type</code></a></h5><p>Specify the column used to store the associated object’s type, if this is a polymorphic association. By default this is guessed to be the name of the association with a “<code>_type</code>” suffix. So a class that defines a <code>belongs_to :taggable, polymorphic: true</code> association will use “<code>taggable_type</code>” as the default <code>:foreign_type</code>.</p><h5 id="options-for-belongs-to-primary-key"><a class="anchorlink" href="#options-for-belongs-to-primary-key">4.1.2.9 <code>:primary_key</code></a></h5><p>By convention, Rails assumes that the <code>id</code> column is used to hold the primary key
of its tables. The <code>:primary_key</code> option allows you to specify a different column.</p><p>For example, given we have a <code>users</code> table with <code>guid</code> as the primary key. If we want a separate <code>todos</code> table to hold the foreign key <code>user_id</code> in the <code>guid</code> column, then we can use <code>primary_key</code> to achieve this like so:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="s1">'guid'</span> <span class="c1"># primary key is guid and not id</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Todo</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">primary_key: </span><span class="s1">'guid'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  self.primary_key = 'guid' # primary key is guid and not id
end

class Todo < ApplicationRecord
  belongs_to :user, primary_key: 'guid'
end
">Copy</button>
</div>
<p>When we execute <code>@user.todos.create</code> then the <code>@todo</code> record will have its
<code>user_id</code> value as the <code>guid</code> value of <code>@user</code>.</p><h5 id="options-for-belongs-to-inverse-of"><a class="anchorlink" href="#options-for-belongs-to-inverse-of">4.1.2.10 <code>:inverse_of</code></a></h5><p>The <code>:inverse_of</code> option specifies the name of the <code>has_many</code> or <code>has_one</code> association that is the inverse of this association.
See the <a href="#bi-directional-associations">bi-directional association</a> section for more details.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: :author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">inverse_of: :books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, inverse_of: :author
end

class Book < ApplicationRecord
  belongs_to :author, inverse_of: :books
end
">Copy</button>
</div>
<h5 id="optional"><a class="anchorlink" href="#optional">4.1.2.11 <code>:optional</code></a></h5><p>If you set the <code>:optional</code> option to <code>true</code>, then the presence of the associated
object won't be validated. By default, this option is set to <code>false</code>.</p><h5 id="polymorphic"><a class="anchorlink" href="#polymorphic">4.1.2.12 <code>:polymorphic</code></a></h5><p>Passing <code>true</code> to the <code>:polymorphic</code> option indicates that this is a polymorphic association. Polymorphic associations were discussed in detail <a href="#polymorphic-associations">earlier in this guide</a>.</p><h5 id="options-for-belongs-to-required"><a class="anchorlink" href="#options-for-belongs-to-required">4.1.2.13 <code>:required</code></a></h5><p>When set to <code>true</code>, the association will also have its presence validated. This will validate the association itself, not the id. You can use <code>:inverse_of</code> to avoid an extra query during validation.</p><div class="note"><p>required is set to <code>true</code> by default and is deprecated. If you don’t want to have association presence validated, use <code>optional: true</code>.</p></div><h5 id="options-for-belongs-to-strict-loading"><a class="anchorlink" href="#options-for-belongs-to-strict-loading">4.1.2.14 <code>:strict_loading</code></a></h5><p>Enforces strict loading every time the associated record is loaded through this association.</p><h5 id="options-for-belongs-to-touch"><a class="anchorlink" href="#options-for-belongs-to-touch">4.1.2.15 <code>:touch</code></a></h5><p>If you set the <code>:touch</code> option to <code>true</code>, then the <code>updated_at</code> or <code>updated_on</code> timestamp on the associated object will be set to the current time whenever this object is saved or destroyed:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, touch: true
end

class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>In this case, saving or destroying a book will update the timestamp on the associated author. You can also specify a particular timestamp attribute to update:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: :books_updated_at</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, touch: :books_updated_at
end
">Copy</button>
</div>
<h5 id="options-for-belongs-to-validate"><a class="anchorlink" href="#options-for-belongs-to-validate">4.1.2.16 <code>:validate</code></a></h5><p>If you set the <code>:validate</code> option to <code>true</code>, then new associated objects will be validated whenever you save this object. By default, this is <code>false</code>: new associated objects will not be validated when this object is saved.</p><h4 id="scopes-for-belongs-to"><a class="anchorlink" href="#scopes-for-belongs-to">4.1.3 Scopes for <code>belongs_to</code></a></h4><p>There may be times when you wish to customize the query used by <code>belongs_to</code>. Such customizations can be achieved via a scope block. For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, -> { where active: true }
end
">Copy</button>
</div>
<p>You can use any of the standard <a href="active_record_querying.html">querying methods</a> inside the scope block. The following ones are discussed below:</p>
<ul>
<li><code>where</code></li>
<li><code>includes</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
</ul>
<h5 id="scopes-for-belongs-to-where"><a class="anchorlink" href="#scopes-for-belongs-to-where">4.1.3.1 <code>where</code></a></h5><p>The <code>where</code> method lets you specify the conditions that the associated object must meet.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, -> { where active: true }
end
">Copy</button>
</div>
<h5 id="scopes-for-belongs-to-includes"><a class="anchorlink" href="#scopes-for-belongs-to-includes">4.1.3.2 <code>includes</code></a></h5><p>You can use the <code>includes</code> method to specify second-order associations that should be eager-loaded when this association is used. For example, consider these models:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Chapter < ApplicationRecord
  belongs_to :book
end

class Book < ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>If you frequently retrieve authors directly from chapters (<code>@chapter.book.author</code>), then you can make your code somewhat more efficient by including authors in the association from chapters to books:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:author</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Chapter < ApplicationRecord
  belongs_to :book, -> { includes :author }
end

class Book < ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<div class="note"><p>There's no need to use <code>includes</code> for immediate associations - that is, if you have <code>Book belongs_to :author</code>, then the author is eager-loaded automatically when it's needed.</p></div><h5 id="scopes-for-belongs-to-readonly"><a class="anchorlink" href="#scopes-for-belongs-to-readonly">4.1.3.3 <code>readonly</code></a></h5><p>If you use <code>readonly</code>, then the associated object will be read-only when retrieved via the association.</p><h5 id="scopes-for-belongs-to-select"><a class="anchorlink" href="#scopes-for-belongs-to-select">4.1.3.4 <code>select</code></a></h5><p>The <code>select</code> method lets you override the SQL <code>SELECT</code> clause that is used to retrieve data about the associated object. By default, Rails retrieves all columns.</p><div class="info"><p>If you use the <code>select</code> method on a <code>belongs_to</code> association, you should also set the <code>:foreign_key</code> option to guarantee the correct results.</p></div><h4 id="belongs-to-association-reference-do-any-associated-objects-exist-questionmark"><a class="anchorlink" href="#belongs-to-association-reference-do-any-associated-objects-exist-questionmark">4.1.4 Do Any Associated Objects Exist?</a></h4><p>You can see if any associated objects exist by using the <code>association.nil?</code> method:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">if</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="vi">@msg</span> <span class="o">=</span> <span class="s2">"No author found for this book"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="if @book.author.nil?
  @msg = &quot;No author found for this book&quot;
end
">Copy</button>
</div>
<h4 id="belongs-to-association-reference-when-are-objects-saved-questionmark"><a class="anchorlink" href="#belongs-to-association-reference-when-are-objects-saved-questionmark">4.1.5 When are Objects Saved?</a></h4><p>Assigning an object to a <code>belongs_to</code> association does <em>not</em> automatically save the object. It does not save the associated object either.</p><h3 id="has-one-association-reference"><a class="anchorlink" href="#has-one-association-reference">4.2 <code>has_one</code> Association Reference</a></h3><p>The <code>has_one</code> association creates a one-to-one match with another model. In database terms, this association says that the other class contains the foreign key. If this class contains the foreign key, then you should use <code>belongs_to</code> instead.</p><h4 id="methods-added-by-has-one"><a class="anchorlink" href="#methods-added-by-has-one">4.2.1 Methods Added by <code>has_one</code></a></h4><p>When you declare a <code>has_one</code> association, the declaring class automatically gains 6 methods related to the association:</p>
<ul>
<li><code>association</code></li>
<li><code>association=(associate)</code></li>
<li><code>build_association(attributes = {})</code></li>
<li><code>create_association(attributes = {})</code></li>
<li><code>create_association!(attributes = {})</code></li>
<li><code>reload_association</code></li>
<li><code>reset_association</code></li>
</ul>
<p>In all of these methods, <code>association</code> is replaced with the symbol passed as the first argument to <code>has_one</code>. For example, given the declaration:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account
end
">Copy</button>
</div>
<p>Each instance of the <code>Supplier</code> model will have these methods:</p>
<ul>
<li><code>account</code></li>
<li><code>account=</code></li>
<li><code>build_account</code></li>
<li><code>create_account</code></li>
<li><code>create_account!</code></li>
<li><code>reload_account</code></li>
<li><code>reset_account</code></li>
</ul>
<div class="note"><p>When initializing a new <code>has_one</code> or <code>belongs_to</code> association you must use the <code>build_</code> prefix to build the association, rather than the <code>association.build</code> method that would be used for <code>has_many</code> or <code>has_and_belongs_to_many</code> associations. To create one, use the <code>create_</code> prefix.</p></div><h5 id="methods-added-by-has-one-association"><a class="anchorlink" href="#methods-added-by-has-one-association">4.2.1.1 <code>association</code></a></h5><p>The <code>association</code> method returns the associated object, if any. If no associated object is found, it returns <code>nil</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@account = @supplier.account
">Copy</button>
</div>
<p>If the associated object has already been retrieved from the database for this object, the cached version will be returned. To override this behavior (and force a database read), call <code>#reload_association</code> on the parent object.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">reload_account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@account = @supplier.reload_account
">Copy</button>
</div>
<p>To unload the cached version of the associated object—forcing the next access, if any, to query it from the database—call <code>#reset_association</code> on the parent object.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@supplier</span><span class="p">.</span><span class="nf">reset_account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@supplier.reset_account
">Copy</button>
</div>
<h5 id="methods-added-by-has-one-association-associate"><a class="anchorlink" href="#methods-added-by-has-one-association-associate">4.2.1.2 <code>association=(associate)</code></a></h5><p>The <code>association=</code> method assigns an associated object to this object. Behind the scenes, this means extracting the primary key from this object and setting the associated object's foreign key to the same value.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span> <span class="o">=</span> <span class="vi">@account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@supplier.account = @account
">Copy</button>
</div>
<h5 id="methods-added-by-has-one-build-association-attributes"><a class="anchorlink" href="#methods-added-by-has-one-build-association-attributes">4.2.1.3 <code>build_association(attributes = {})</code></a></h5><p>The <code>build_association</code> method returns a new object of the associated type. This object will be instantiated from the passed attributes, and the link through its foreign key will be set, but the associated object will <em>not</em> yet be saved.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">build_account</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">"Net 30"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@account = @supplier.build_account(terms: &quot;Net 30&quot;)
">Copy</button>
</div>
<h5 id="methods-added-by-has-one-create-association-attributes"><a class="anchorlink" href="#methods-added-by-has-one-create-association-attributes">4.2.1.4 <code>create_association(attributes = {})</code></a></h5><p>The <code>create_association</code> method returns a new object of the associated type. This object will be instantiated from the passed attributes, the link through its foreign key will be set, and, once it passes all of the validations specified on the associated model, the associated object <em>will</em> be saved.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">create_account</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">"Net 30"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@account = @supplier.create_account(terms: &quot;Net 30&quot;)
">Copy</button>
</div>
<h5 id="methods-added-by-has-one-create-association-bang-attributes"><a class="anchorlink" href="#methods-added-by-has-one-create-association-bang-attributes">4.2.1.5 <code>create_association!(attributes = {})</code></a></h5><p>Does the same as <code>create_association</code> above, but raises <code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p><h4 id="options-for-has-one"><a class="anchorlink" href="#options-for-has-one">4.2.2 Options for <code>has_one</code></a></h4><p>While Rails uses intelligent defaults that will work well in most situations, there may be times when you want to customize the behavior of the <code>has_one</code> association reference. Such customizations can easily be accomplished by passing options when you create the association. For example, this association uses two such options:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Billing"</span><span class="p">,</span> <span class="ss">dependent: :nullify</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account, class_name: &quot;Billing&quot;, dependent: :nullify
end
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one</code></a> association supports these options:</p>
<ul>
<li><code>:as</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:dependent</code></li>
<li><code>:disable_joins</code></li>
<li><code>:ensuring_owner_was</code></li>
<li><code>:foreign_key</code></li>
<li><code>:inverse_of</code></li>
<li><code>:primary_key</code></li>
<li><code>:query_constraints</code></li>
<li><code>:required</code></li>
<li><code>:source</code></li>
<li><code>:source_type</code></li>
<li><code>:strict_loading</code></li>
<li><code>:through</code></li>
<li><code>:touch</code></li>
<li><code>:validate</code></li>
</ul>
<h5 id="options-for-has-one-as"><a class="anchorlink" href="#options-for-has-one-as">4.2.2.1 <code>:as</code></a></h5><p>Setting the <code>:as</code> option indicates that this is a polymorphic association. Polymorphic associations were discussed in detail <a href="#polymorphic-associations">earlier in this guide</a>.</p><h5 id="options-for-has-one-autosave"><a class="anchorlink" href="#options-for-has-one-autosave">4.2.2.2 <code>:autosave</code></a></h5><p>If you set the <code>:autosave</code> option to <code>true</code>, Rails will save any loaded association members and destroy members that are marked for destruction whenever you save the parent object. Setting <code>:autosave</code> to <code>false</code> is not the same as not setting the <code>:autosave</code> option. If the <code>:autosave</code> option is not present, then new associated objects will be saved, but updated associated objects will not be saved.</p><h5 id="options-for-has-one-class-name"><a class="anchorlink" href="#options-for-has-one-class-name">4.2.2.3 <code>:class_name</code></a></h5><p>If the name of the other model cannot be derived from the association name, you can use the <code>:class_name</code> option to supply the model name. For example, if a supplier has an account, but the actual name of the model containing accounts is <code>Billing</code>, you'd set things up this way:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Billing"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account, class_name: &quot;Billing&quot;
end
">Copy</button>
</div>
<h5 id="options-for-has-one-dependent"><a class="anchorlink" href="#options-for-has-one-dependent">4.2.2.4 <code>:dependent</code></a></h5><p>Controls what happens to the associated object when its owner is destroyed:</p>
<ul>
<li><code>:destroy</code> causes the associated object to also be destroyed</li>
<li><code>:delete</code> causes the associated object to be deleted directly from the database (so callbacks will not execute)</li>
<li><code>:destroy_async</code>: when the object is destroyed, an <code>ActiveRecord::DestroyAssociationAsyncJob</code> job is enqueued which will call destroy on its associated objects. Active Job must be set up for this to work. Do not use this option if the association is backed by foreign key constraints in your database. The foreign key constraint actions will occur inside the same transaction that deletes its owner.</li>
<li><code>:nullify</code> causes the foreign key to be set to <code>NULL</code>. Polymorphic type column is also nullified on polymorphic associations. Callbacks are not executed.</li>
<li><code>:restrict_with_exception</code> causes an <code>ActiveRecord::DeleteRestrictionError</code> exception to be raised if there is an associated record</li>
<li><code>:restrict_with_error</code> causes an error to be added to the owner if there is an associated object</li>
</ul>
<p>It's necessary not to set or leave <code>:nullify</code> option for those associations
that have <code>NOT NULL</code> database constraints. If you don't set <code>dependent</code> to
destroy such associations you won't be able to change the associated object
because the initial associated object's foreign key will be set to the
unallowed <code>NULL</code> value.</p><h5 id="options-for-has-one-disable-joins"><a class="anchorlink" href="#options-for-has-one-disable-joins">4.2.2.5 <code>:disable_joins</code></a></h5><p>Specifies whether joins should be skipped for an association. If set to <code>true</code>, two or more queries will be generated. Note that in some cases, if order or limit is applied, it will be done in-memory due to database limitations. This option is only applicable on <code>has_one :through</code> associations as <code>has_one</code> alone does not perform a join.</p><h5 id="options-for-has-one-foreign-key"><a class="anchorlink" href="#options-for-has-one-foreign-key">4.2.2.6 <code>:foreign_key</code></a></h5><p>By convention, Rails assumes that the column used to hold the foreign key on the other model is the name of this model with the suffix <code>_id</code> added. The <code>:foreign_key</code> option lets you set the name of the foreign key directly:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"supp_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account, foreign_key: &quot;supp_id&quot;
end
">Copy</button>
</div>
<div class="info"><p>In any case, Rails will not create foreign key columns for you. You need to explicitly define them as part of your migrations.</p></div><h5 id="options-for-has-one-inverse-of"><a class="anchorlink" href="#options-for-has-one-inverse-of">4.2.2.7 <code>:inverse_of</code></a></h5><p>The <code>:inverse_of</code> option specifies the name of the <code>belongs_to</code> association that is the inverse of this association.
See the <a href="#bi-directional-associations">bi-directional association</a> section for more details.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">inverse_of: :supplier</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">inverse_of: :account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account, inverse_of: :supplier
end

class Account < ApplicationRecord
  belongs_to :supplier, inverse_of: :account
end
">Copy</button>
</div>
<h5 id="options-for-has-one-primary-key"><a class="anchorlink" href="#options-for-has-one-primary-key">4.2.2.8 <code>:primary_key</code></a></h5><p>By convention, Rails assumes that the column used to hold the primary key of this model is <code>id</code>. You can override this and explicitly specify the primary key with the <code>:primary_key</code> option.</p><h5 id="options-for-has-one-query-constraints"><a class="anchorlink" href="#options-for-has-one-query-constraints">4.2.2.9 <code>:query_constraints</code></a></h5><p>Serves as a composite foreign key. Defines the list of columns to be used to query the associated object. This is an optional option. By default Rails will attempt to derive the value automatically. When the value is set the Array size must match associated model’s primary key or query_constraints size.</p><h5 id="options-for-has-one-required"><a class="anchorlink" href="#options-for-has-one-required">4.2.2.10 <code>:required</code></a></h5><p>When set to <code>true</code>, the association will also have its presence validated. This will validate the association itself, not the id. You can use <code>:inverse_of</code> to avoid an extra query during validation.</p><h5 id="options-for-has-one-source"><a class="anchorlink" href="#options-for-has-one-source">4.2.2.11 <code>:source</code></a></h5><p>The <code>:source</code> option specifies the source association name for a <code>has_one :through</code> association.</p><h5 id="options-for-has-one-source-type"><a class="anchorlink" href="#options-for-has-one-source-type">4.2.2.12 <code>:source_type</code></a></h5><p>The <code>:source_type</code> option specifies the source association type for a <code>has_one :through</code> association that proceeds through a polymorphic association.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:book</span>
  <span class="n">has_one</span> <span class="ss">:hardback</span><span class="p">,</span> <span class="ss">through: :book</span><span class="p">,</span> <span class="ss">source: :format</span><span class="p">,</span> <span class="ss">source_type: </span><span class="s2">"Hardback"</span>
  <span class="n">has_one</span> <span class="ss">:dust_jacket</span><span class="p">,</span> <span class="ss">through: :hardback</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:format</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Paperback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>

<span class="k">class</span> <span class="nc">Hardback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:dust_jacket</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">DustJacket</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_one :book
  has_one :hardback, through: :book, source: :format, source_type: &quot;Hardback&quot;
  has_one :dust_jacket, through: :hardback
end

class Book < ApplicationRecord
  belongs_to :format, polymorphic: true
end

class Paperback < ApplicationRecord; end

class Hardback < ApplicationRecord
  has_one :dust_jacket
end

class DustJacket < ApplicationRecord; end
">Copy</button>
</div>
<h5 id="options-for-has-one-strict-loading"><a class="anchorlink" href="#options-for-has-one-strict-loading">4.2.2.13 <code>:strict_loading</code></a></h5><p>Enforces strict loading every time the associated record is loaded through this association.</p><h5 id="options-for-has-one-through"><a class="anchorlink" href="#options-for-has-one-through">4.2.2.14 <code>:through</code></a></h5><p>The <code>:through</code> option specifies a join model through which to perform the query. <code>has_one :through</code> associations were discussed in detail <a href="#the-has-one-through-association">earlier in this guide</a>.</p><h5 id="options-for-has-one-touch"><a class="anchorlink" href="#options-for-has-one-touch">4.2.2.15 <code>:touch</code></a></h5><p>If you set the <code>:touch</code> option to <code>true</code>, then the <code>updated_at</code> or <code>updated_on</code> timestamp on the associated object will be set to the current time whenever this object is saved or destroyed:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account, touch: true
end

class Account < ApplicationRecord
  belongs_to :supplier
end
">Copy</button>
</div>
<p>In this case, saving or destroying a supplier will update the timestamp on the associated account. You can also specify a particular timestamp attribute to update:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">touch: :suppliers_updated_at</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account, touch: :suppliers_updated_at
end
">Copy</button>
</div>
<h5 id="options-for-has-one-validate"><a class="anchorlink" href="#options-for-has-one-validate">4.2.2.16 <code>:validate</code></a></h5><p>If you set the <code>:validate</code> option to <code>true</code>, then new associated objects will be validated whenever you save this object. By default, this is <code>false</code>: new associated objects will not be validated when this object is saved.</p><h4 id="scopes-for-has-one"><a class="anchorlink" href="#scopes-for-has-one">4.2.3 Scopes for <code>has_one</code></a></h4><p>There may be times when you wish to customize the query used by <code>has_one</code>. Such customizations can be achieved via a scope block. For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account, -> { where active: true }
end
">Copy</button>
</div>
<p>You can use any of the standard <a href="active_record_querying.html">querying methods</a> inside the scope block. The following ones are discussed below:</p>
<ul>
<li><code>where</code></li>
<li><code>includes</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
</ul>
<h5 id="scopes-for-has-one-where"><a class="anchorlink" href="#scopes-for-has-one-where">4.2.3.1 <code>where</code></a></h5><p>The <code>where</code> method lets you specify the conditions that the associated object must meet.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"confirmed = 1"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account, -> { where &quot;confirmed = 1&quot; }
end
">Copy</button>
</div>
<h5 id="scopes-for-has-one-includes"><a class="anchorlink" href="#scopes-for-has-one-includes">4.2.3.2 <code>includes</code></a></h5><p>You can use the <code>includes</code> method to specify second-order associations that should be eager-loaded when this association is used. For example, consider these models:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:representative</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Representative</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account
end

class Account < ApplicationRecord
  belongs_to :supplier
  belongs_to :representative
end

class Representative < ApplicationRecord
  has_many :accounts
end
">Copy</button>
</div>
<p>If you frequently retrieve representatives directly from suppliers (<code>@supplier.account.representative</code>), then you can make your code somewhat more efficient by including representatives in the association from suppliers to accounts:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:representative</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:representative</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Representative</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account, -> { includes :representative }
end

class Account < ApplicationRecord
  belongs_to :supplier
  belongs_to :representative
end

class Representative < ApplicationRecord
  has_many :accounts
end
">Copy</button>
</div>
<h5 id="scopes-for-has-one-readonly"><a class="anchorlink" href="#scopes-for-has-one-readonly">4.2.3.3 <code>readonly</code></a></h5><p>If you use the <code>readonly</code> method, then the associated object will be read-only when retrieved via the association.</p><h5 id="scopes-for-has-one-select"><a class="anchorlink" href="#scopes-for-has-one-select">4.2.3.4 <code>select</code></a></h5><p>The <code>select</code> method lets you override the SQL <code>SELECT</code> clause that is used to retrieve data about the associated object. By default, Rails retrieves all columns.</p><h4 id="has-one-association-reference-do-any-associated-objects-exist-questionmark"><a class="anchorlink" href="#has-one-association-reference-do-any-associated-objects-exist-questionmark">4.2.4 Do Any Associated Objects Exist?</a></h4><p>You can see if any associated objects exist by using the <code>association.nil?</code> method:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">if</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="vi">@msg</span> <span class="o">=</span> <span class="s2">"No account found for this supplier"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="if @supplier.account.nil?
  @msg = &quot;No account found for this supplier&quot;
end
">Copy</button>
</div>
<h4 id="has-one-association-reference-when-are-objects-saved-questionmark"><a class="anchorlink" href="#has-one-association-reference-when-are-objects-saved-questionmark">4.2.5 When are Objects Saved?</a></h4><p>When you assign an object to a <code>has_one</code> association, that object is automatically saved (in order to update its foreign key). In addition, any object being replaced is also automatically saved, because its foreign key will change too.</p><p>If either of these saves fails due to validation errors, then the assignment statement returns <code>false</code> and the assignment itself is cancelled.</p><p>If the parent object (the one declaring the <code>has_one</code> association) is unsaved (that is, <code>new_record?</code> returns <code>true</code>) then the child objects are not saved. They will automatically when the parent object is saved.</p><p>If you want to assign an object to a <code>has_one</code> association without saving the object, use the <code>build_association</code> method.</p><h3 id="has-many-association-reference"><a class="anchorlink" href="#has-many-association-reference">4.3 <code>has_many</code> Association Reference</a></h3><p>The <code>has_many</code> association creates a one-to-many relationship with another model. In database terms, this association says that the other class will have a foreign key that refers to instances of this class.</p><h4 id="methods-added-by-has-many"><a class="anchorlink" href="#methods-added-by-has-many">4.3.1 Methods Added by <code>has_many</code></a></h4><p>When you declare a <code>has_many</code> association, the declaring class automatically gains 17 methods related to the association:</p>
<ul>
<li><code>collection</code></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;(object, ...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete(object, ...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy(object, ...)</code></a></li>
<li><code>collection=(objects)</code></li>
<li><code>collection_singular_ids</code></li>
<li><code>collection_singular_ids=(ids)</code></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find(...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where(...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?(...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build(attributes = {})</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create(attributes = {})</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create-21"><code>collection.create!(attributes = {})</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a></li>
</ul>
<p>In all of these methods, <code>collection</code> is replaced with the symbol passed as the first argument to <code>has_many</code>, and <code>collection_singular</code> is replaced with the singularized version of that symbol. For example, given the declaration:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>Each instance of the <code>Author</code> model will have these methods:</p><div class="code_container">
<pre><code class="highlight plaintext">books
books&lt;&lt;(object, ...)
books.delete(object, ...)
books.destroy(object, ...)
books=(objects)
book_ids
book_ids=(ids)
books.clear
books.empty?
books.size
books.find(...)
books.where(...)
books.exists?(...)
books.build(attributes = {}, ...)
books.create(attributes = {})
books.create!(attributes = {})
books.reload
</code></pre>
<button class="clipboard-button" data-clipboard-text="books
books<<(object, ...)
books.delete(object, ...)
books.destroy(object, ...)
books=(objects)
book_ids
book_ids=(ids)
books.clear
books.empty?
books.size
books.find(...)
books.where(...)
books.exists?(...)
books.build(attributes = {}, ...)
books.create(attributes = {})
books.create!(attributes = {})
books.reload
">Copy</button>
</div>
<h5 id="methods-added-by-has-many-collection"><a class="anchorlink" href="#methods-added-by-has-many-collection">4.3.1.1 <code>collection</code></a></h5><p>The <code>collection</code> method returns a Relation of all of the associated objects. If there are no associated objects, it returns an empty Relation.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@books = @author.books
">Copy</button>
</div>
<h5 id="methods-added-by-has-many-collection-object"><a class="anchorlink" href="#methods-added-by-has-many-collection-object">4.3.1.2 <code>collection&lt;&lt;(object, ...)</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;</code></a> method adds one or more objects to the collection by setting their foreign keys to the primary key of the calling model.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span> <span class="o">&lt;&lt;</span> <span class="vi">@book1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books << @book1
">Copy</button>
</div>
<h5 id="methods-added-by-has-many-collection-delete-object"><a class="anchorlink" href="#methods-added-by-has-many-collection-delete-object">4.3.1.3 <code>collection.delete(object, ...)</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete</code></a> method removes one or more objects from the collection by setting their foreign keys to <code>NULL</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="vi">@book1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books.delete(@book1)
">Copy</button>
</div>
<div class="warning"><p>Additionally, objects will be destroyed if they're associated with <code>dependent: :destroy</code>, and deleted if they're associated with <code>dependent: :delete_all</code>.</p></div><h5 id="methods-added-by-has-many-collection-destroy-object"><a class="anchorlink" href="#methods-added-by-has-many-collection-destroy-object">4.3.1.4 <code>collection.destroy(object, ...)</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy</code></a> method removes one or more objects from the collection by running <code>destroy</code> on each object.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="vi">@book1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books.destroy(@book1)
">Copy</button>
</div>
<div class="warning"><p>Objects will <em>always</em> be removed from the database, ignoring the <code>:dependent</code> option.</p></div><h5 id="methods-added-by-has-many-collection-objects"><a class="anchorlink" href="#methods-added-by-has-many-collection-objects">4.3.1.5 <code>collection=(objects)</code></a></h5><p>The <code>collection=</code> method makes the collection contain only the supplied objects, by adding and deleting as appropriate. The changes are persisted to the database.</p><h5 id="methods-added-by-has-many-collection-singular-ids"><a class="anchorlink" href="#methods-added-by-has-many-collection-singular-ids">4.3.1.6 <code>collection_singular_ids</code></a></h5><p>The <code>collection_singular_ids</code> method returns an array of the ids of the objects in the collection.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book_ids</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">book_ids</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book_ids = @author.book_ids
">Copy</button>
</div>
<h5 id="methods-added-by-has-many-collection-singular-ids-ids"><a class="anchorlink" href="#methods-added-by-has-many-collection-singular-ids-ids">4.3.1.7 <code>collection_singular_ids=(ids)</code></a></h5><p>The <code>collection_singular_ids=</code> method makes the collection contain only the objects identified by the supplied primary key values, by adding and deleting as appropriate. The changes are persisted to the database.</p><h5 id="methods-added-by-has-many-collection-clear"><a class="anchorlink" href="#methods-added-by-has-many-collection-clear">4.3.1.8 <code>collection.clear</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a> method removes all objects from the collection according to the strategy specified by the <code>dependent</code> option. If no option is given, it follows the default strategy. The default strategy for <code>has_many :through</code> associations is <code>delete_all</code>, and for <code>has_many</code> associations is to set the foreign keys to <code>NULL</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">clear</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books.clear
">Copy</button>
</div>
<div class="warning"><p>Objects will be deleted if they're associated with <code>dependent: :destroy</code> or <code>dependent: :destroy_async</code>,
just like <code>dependent: :delete_all</code>.</p></div><h5 id="methods-added-by-has-many-collection-empty-questionmark"><a class="anchorlink" href="#methods-added-by-has-many-collection-empty-questionmark">4.3.1.9 <code>collection.empty?</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a> method returns <code>true</code> if the collection does not contain any associated objects.</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">empty?</span> <span class="cp">%&gt;</span>
  No Books Found
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<% if @author.books.empty? %>
  No Books Found
<% end %>
">Copy</button>
</div>
<h5 id="methods-added-by-has-many-collection-size"><a class="anchorlink" href="#methods-added-by-has-many-collection-size">4.3.1.10 <code>collection.size</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a> method returns the number of objects in the collection.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book_count</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book_count = @author.books.size
">Copy</button>
</div>
<h5 id="methods-added-by-has-many-collection-find"><a class="anchorlink" href="#methods-added-by-has-many-collection-find">4.3.1.11 <code>collection.find(...)</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find</code></a> method finds objects within the collection's table.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@available_book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@available_book = @author.books.find(1)
">Copy</button>
</div>
<h5 id="methods-added-by-has-many-collection-where"><a class="anchorlink" href="#methods-added-by-has-many-collection-where">4.3.1.12 <code>collection.where(...)</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where</code></a> method finds objects within the collection based on the conditions supplied but the objects are loaded lazily meaning that the database is queried only when the object(s) are accessed.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@available_books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">available: </span><span class="kp">true</span><span class="p">)</span> <span class="c1"># No query yet</span>
<span class="vi">@available_book</span> <span class="o">=</span> <span class="vi">@available_books</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Now the database will be queried</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@available_books = @author.books.where(available: true) # No query yet
@available_book = @available_books.first # Now the database will be queried
">Copy</button>
</div>
<h5 id="methods-added-by-has-many-collection-exists-questionmark"><a class="anchorlink" href="#methods-added-by-has-many-collection-exists-questionmark">4.3.1.13 <code>collection.exists?(...)</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?</code></a> method checks whether an object meeting the supplied
conditions exists in the collection's table.</p><h5 id="methods-added-by-has-many-collection-build-attributes"><a class="anchorlink" href="#methods-added-by-has-many-collection-build-attributes">4.3.1.14 <code>collection.build(attributes = {})</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build</code></a> method returns a single or array of new objects of the associated type. The object(s) will be instantiated from the passed attributes, and the link through their foreign key will be created, but the associated objects will <em>not</em> yet be saved.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span>
                            <span class="ss">book_number: </span><span class="s2">"A12345"</span><span class="p">)</span>

<span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">build</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12346"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12347"</span> <span class="p">}</span>
<span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book = @author.books.build(published_at: Time.now,
                            book_number: &quot;A12345&quot;)

@books = @author.books.build([
  { published_at: Time.now, book_number: &quot;A12346&quot; },
  { published_at: Time.now, book_number: &quot;A12347&quot; }
])
">Copy</button>
</div>
<h5 id="methods-added-by-has-many-collection-create-attributes"><a class="anchorlink" href="#methods-added-by-has-many-collection-create-attributes">4.3.1.15 <code>collection.create(attributes = {})</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create</code></a> method returns a single or array of new objects of the associated type. The object(s) will be instantiated from the passed attributes, the link through its foreign key will be created, and, once it passes all of the validations specified on the associated model, the associated object <em>will</em> be saved.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span>
                             <span class="ss">book_number: </span><span class="s2">"A12345"</span><span class="p">)</span>

<span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12346"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12347"</span> <span class="p">}</span>
<span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book = @author.books.create(published_at: Time.now,
                             book_number: &quot;A12345&quot;)

@books = @author.books.create([
  { published_at: Time.now, book_number: &quot;A12346&quot; },
  { published_at: Time.now, book_number: &quot;A12347&quot; }
])
">Copy</button>
</div>
<h5 id="methods-added-by-has-many-collection-create-bang-attributes"><a class="anchorlink" href="#methods-added-by-has-many-collection-create-bang-attributes">4.3.1.16 <code>collection.create!(attributes = {})</code></a></h5><p>Does the same as <code>collection.create</code> above, but raises <code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p><h5 id="methods-added-by-has-many-collection-reload"><a class="anchorlink" href="#methods-added-by-has-many-collection-reload">4.3.1.17 <code>collection.reload</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a> method returns a Relation of all of the associated objects, forcing a database read. If there are no associated objects, it returns an empty Relation.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@books = @author.books.reload
">Copy</button>
</div>
<h4 id="options-for-has-many"><a class="anchorlink" href="#options-for-has-many">4.3.2 Options for <code>has_many</code></a></h4><p>While Rails uses intelligent defaults that will work well in most situations, there may be times when you want to customize the behavior of the <code>has_many</code> association reference. Such customizations can easily be accomplished by passing options when you create the association. For example, this association uses two such options:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">dependent: :delete_all</span><span class="p">,</span> <span class="ss">validate: </span><span class="kp">false</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, dependent: :delete_all, validate: false
end
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many</code></a> association supports these options:</p>
<ul>
<li><code>:as</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:counter_cache</code></li>
<li><code>:dependent</code></li>
<li><code>:disable_joins</code></li>
<li><code>:ensuring_owner_was</code></li>
<li><code>:extend</code></li>
<li><code>:foreign_key</code></li>
<li><code>:foreign_type</code></li>
<li><code>:inverse_of</code></li>
<li><code>:primary_key</code></li>
<li><code>:query_constraints</code></li>
<li><code>:source</code></li>
<li><code>:source_type</code></li>
<li><code>:strict_loading</code></li>
<li><code>:through</code></li>
<li><code>:validate</code></li>
</ul>
<h5 id="options-for-has-many-as"><a class="anchorlink" href="#options-for-has-many-as">4.3.2.1 <code>:as</code></a></h5><p>Setting the <code>:as</code> option indicates that this is a polymorphic association, as discussed <a href="#polymorphic-associations">earlier in this guide</a>.</p><h5 id="options-for-has-many-autosave"><a class="anchorlink" href="#options-for-has-many-autosave">4.3.2.2 <code>:autosave</code></a></h5><p>If you set the <code>:autosave</code> option to <code>true</code>, Rails will save any loaded association members and destroy members that are marked for destruction whenever you save the parent object. Setting <code>:autosave</code> to <code>false</code> is not the same as not setting the <code>:autosave</code> option. If the <code>:autosave</code> option is not present, then new associated objects will be saved, but updated associated objects will not be saved.</p><h5 id="options-for-has-many-class-name"><a class="anchorlink" href="#options-for-has-many-class-name">4.3.2.3 <code>:class_name</code></a></h5><p>If the name of the other model cannot be derived from the association name, you can use the <code>:class_name</code> option to supply the model name. For example, if an author has many books, but the actual name of the model containing books is <code>Transaction</code>, you'd set things up this way:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Transaction"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, class_name: &quot;Transaction&quot;
end
">Copy</button>
</div>
<h5 id="options-for-has-many-counter-cache"><a class="anchorlink" href="#options-for-has-many-counter-cache">4.3.2.4 <code>:counter_cache</code></a></h5><p>This option can be used to configure a custom named <code>:counter_cache</code>. You only need this option when you customized the name of your <code>:counter_cache</code> on the <a href="#options-for-belongs-to">belongs_to association</a>.</p><h5 id="dependent"><a class="anchorlink" href="#dependent">4.3.2.5 <code>:dependent</code></a></h5><p>Controls what happens to the associated objects when their owner is destroyed:</p>
<ul>
<li><code>:destroy</code> causes all the associated objects to also be destroyed</li>
<li><code>:delete_all</code> causes all the associated objects to be deleted directly from the database (so callbacks will not execute)</li>
<li><code>:destroy_async</code>: when the object is destroyed, an <code>ActiveRecord::DestroyAssociationAsyncJob</code> job is enqueued which will call destroy on its associated objects. Active Job must be set up for this to work.</li>
<li><code>:nullify</code> causes the foreign key to be set to <code>NULL</code>. Polymorphic type column is also nullified on polymorphic associations. Callbacks are not executed.</li>
<li><code>:restrict_with_exception</code> causes an <code>ActiveRecord::DeleteRestrictionError</code> exception to be raised if there are any associated records</li>
<li><code>:restrict_with_error</code> causes an error to be added to the owner if there are any associated objects</li>
</ul>
<p>The <code>:destroy</code> and <code>:delete_all</code> options also affect the semantics of the <code>collection.delete</code> and <code>collection=</code> methods by causing them to destroy associated objects when they are removed from the collection.</p><h5 id="options-for-has-many-disable-joins"><a class="anchorlink" href="#options-for-has-many-disable-joins">4.3.2.6 <code>:disable_joins</code></a></h5><p>Specifies whether joins should be skipped for an association. If set to true, two or more queries will be generated. Note that in some cases, if order or limit is applied, it will be done in-memory due to database limitations. This option is only applicable on <code>has_many :through associations</code> as has_many alone do not perform a join.</p><h5 id="options-for-has-many-ensuring-owner-was"><a class="anchorlink" href="#options-for-has-many-ensuring-owner-was">4.3.2.7 <code>:ensuring_owner_was</code></a></h5><p>Specifies an instance method to be called on the owner. The method must return true in order for the associated records to be deleted in a background job.</p><h5 id="extend"><a class="anchorlink" href="#extend">4.3.2.8 <code>:extend</code></a></h5><p>Specifies a module or array of modules that will be extended into the association object returned. Useful for defining methods on associations, especially when they should be shared between multiple association objects.</p><h5 id="options-for-has-many-foreign-key"><a class="anchorlink" href="#options-for-has-many-foreign-key">4.3.2.9 <code>:foreign_key</code></a></h5><p>By convention, Rails assumes that the column used to hold the foreign key on the other model is the name of this model with the suffix <code>_id</code> added. The <code>:foreign_key</code> option lets you set the name of the foreign key directly:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"cust_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, foreign_key: &quot;cust_id&quot;
end
">Copy</button>
</div>
<div class="info"><p>In any case, Rails will not create foreign key columns for you. You need to explicitly define them as part of your migrations.</p></div><h5 id="options-for-has-many-foreign-type"><a class="anchorlink" href="#options-for-has-many-foreign-type">4.3.2.10 <code>:foreign_type</code></a></h5><p>Specify the column used to store the associated object’s type, if this is a polymorphic association. By default this is guessed to be the name of the polymorphic association specified on “<code>as</code>” option with a “<code>_type</code>” suffix. So a class that defines a <code>has_many :tags, as: :taggable</code> association will use “<code>taggable_type</code>” as the default <code>:foreign_type</code>.</p><h5 id="inverse-of"><a class="anchorlink" href="#inverse-of">4.3.2.11 <code>:inverse_of</code></a></h5><p>The <code>:inverse_of</code> option specifies the name of the <code>belongs_to</code> association that is the inverse of this association.
See the <a href="#bi-directional-associations">bi-directional association</a> section for more details.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: :author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">inverse_of: :books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, inverse_of: :author
end

class Book < ApplicationRecord
  belongs_to :author, inverse_of: :books
end
">Copy</button>
</div>
<h5 id="primary-key"><a class="anchorlink" href="#primary-key">4.3.2.12 <code>:primary_key</code></a></h5><p>By convention, Rails assumes that the column used to hold the primary key of the association is <code>id</code>. You can override this and explicitly specify the primary key with the <code>:primary_key</code> option.</p><p>Let's say the <code>users</code> table has <code>id</code> as the primary_key but it also
has a <code>guid</code> column. The requirement is that the <code>todos</code> table should
hold the <code>guid</code> column value as the foreign key and not <code>id</code>
value. This can be achieved like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:todos</span><span class="p">,</span> <span class="ss">primary_key: :guid</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  has_many :todos, primary_key: :guid
end
">Copy</button>
</div>
<p>Now if we execute <code>@todo = @user.todos.create</code> then the <code>@todo</code>
record's <code>user_id</code> value will be the <code>guid</code> value of <code>@user</code>.</p><h5 id="options-for-has-many-query-constraints"><a class="anchorlink" href="#options-for-has-many-query-constraints">4.3.2.13 <code>:query_constraints</code></a></h5><p>Serves as a composite foreign key. Defines the list of columns to be used to query the associated object. This is an optional option. By default Rails will attempt to derive the value automatically. When the value is set the Array size must match associated model’s primary key or <code>query_constraints</code> size.</p><h5 id="options-for-has-many-source"><a class="anchorlink" href="#options-for-has-many-source">4.3.2.14 <code>:source</code></a></h5><p>The <code>:source</code> option specifies the source association name for a <code>has_many :through</code> association. You only need to use this option if the name of the source association cannot be automatically inferred from the association name.</p><h5 id="options-for-has-many-source-type"><a class="anchorlink" href="#options-for-has-many-source-type">4.3.2.15 <code>:source_type</code></a></h5><p>The <code>:source_type</code> option specifies the source association type for a <code>has_many :through</code> association that proceeds through a polymorphic association.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">has_many</span> <span class="ss">:paperbacks</span><span class="p">,</span> <span class="ss">through: :books</span><span class="p">,</span> <span class="ss">source: :format</span><span class="p">,</span> <span class="ss">source_type: </span><span class="s2">"Paperback"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:format</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Hardback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
<span class="k">class</span> <span class="nc">Paperback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books
  has_many :paperbacks, through: :books, source: :format, source_type: &quot;Paperback&quot;
end

class Book < ApplicationRecord
  belongs_to :format, polymorphic: true
end

class Hardback < ApplicationRecord; end
class Paperback < ApplicationRecord; end
">Copy</button>
</div>
<h5 id="options-for-has-many-strict-loading"><a class="anchorlink" href="#options-for-has-many-strict-loading">4.3.2.16 <code>:strict_loading</code></a></h5><p>When set to true, enforces strict loading every time the associated record is loaded through this association.</p><h5 id="options-for-has-many-through"><a class="anchorlink" href="#options-for-has-many-through">4.3.2.17 <code>:through</code></a></h5><p>The <code>:through</code> option specifies a join model through which to perform the query. <code>has_many :through</code> associations provide a way to implement many-to-many relationships, as discussed <a href="#the-has-many-through-association">earlier in this guide</a>.</p><h5 id="options-for-has-many-validate"><a class="anchorlink" href="#options-for-has-many-validate">4.3.2.18 <code>:validate</code></a></h5><p>If you set the <code>:validate</code> option to <code>false</code>, then new associated objects will not be validated whenever you save this object. By default, this is <code>true</code>: new associated objects will be validated when this object is saved.</p><h4 id="scopes-for-has-many"><a class="anchorlink" href="#scopes-for-has-many">4.3.3 Scopes for <code>has_many</code></a></h4><p>There may be times when you wish to customize the query used by <code>has_many</code>. Such customizations can be achieved via a scope block. For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">processed: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, -> { where processed: true }
end
">Copy</button>
</div>
<p>You can use any of the standard <a href="active_record_querying.html">querying methods</a> inside the scope block. The following ones are discussed below:</p>
<ul>
<li><code>where</code></li>
<li><code>extending</code></li>
<li><code>group</code></li>
<li><code>includes</code></li>
<li><code>limit</code></li>
<li><code>offset</code></li>
<li><code>order</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
<li><code>distinct</code></li>
</ul>
<h5 id="scopes-for-has-many-where"><a class="anchorlink" href="#scopes-for-has-many-where">4.3.3.1 <code>where</code></a></h5><p>The <code>where</code> method lets you specify the conditions that the associated object must meet.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:confirmed_books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"confirmed = 1"</span> <span class="p">},</span>
    <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :confirmed_books, -> { where &quot;confirmed = 1&quot; },
    class_name: &quot;Book&quot;
end
">Copy</button>
</div>
<p>You can also set conditions via a hash:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:confirmed_books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">confirmed: </span><span class="kp">true</span> <span class="p">},</span>
    <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :confirmed_books, -> { where confirmed: true },
    class_name: &quot;Book&quot;
end
">Copy</button>
</div>
<p>If you use a hash-style <code>where</code> option, then record creation via this association will be automatically scoped using the hash. In this case, using <code>@author.confirmed_books.create</code> or <code>@author.confirmed_books.build</code> will create books where the confirmed column has the value <code>true</code>.</p><h5 id="scopes-for-has-many-extending"><a class="anchorlink" href="#scopes-for-has-many-extending">4.3.3.2 <code>extending</code></a></h5><p>The <code>extending</code> method specifies a named module to extend the association proxy. Association extensions are discussed in detail <a href="#association-extensions">later in this guide</a>.</p><h5 id="scopes-for-has-many-group"><a class="anchorlink" href="#scopes-for-has-many-group">4.3.3.3 <code>group</code></a></h5><p>The <code>group</code> method supplies an attribute name to group the result set by, using a <code>GROUP BY</code> clause in the finder SQL.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">group</span> <span class="s1">'books.id'</span> <span class="p">},</span>
                      <span class="ss">through: :books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :chapters, -> { group 'books.id' },
                      through: :books
end
">Copy</button>
</div>
<h5 id="scopes-for-has-many-includes"><a class="anchorlink" href="#scopes-for-has-many-includes">4.3.3.4 <code>includes</code></a></h5><p>You can use the <code>includes</code> method to specify second-order associations that should be eager-loaded when this association is used. For example, consider these models:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books
end

class Book < ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Chapter < ApplicationRecord
  belongs_to :book
end
">Copy</button>
</div>
<p>If you frequently retrieve chapters directly from authors (<code>@author.books.chapters</code>), then you can make your code somewhat more efficient by including chapters in the association from authors to books:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:chapters</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, -> { includes :chapters }
end

class Book < ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Chapter < ApplicationRecord
  belongs_to :book
end
">Copy</button>
</div>
<h5 id="scopes-for-has-many-limit"><a class="anchorlink" href="#scopes-for-has-many-limit">4.3.3.5 <code>limit</code></a></h5><p>The <code>limit</code> method lets you restrict the total number of objects that will be fetched through an association.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:recent_books</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'published_at desc'</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="p">},</span>
    <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :recent_books,
    -> { order('published_at desc').limit(100) },
    class_name: &quot;Book&quot;
end
">Copy</button>
</div>
<h5 id="scopes-for-has-many-offset"><a class="anchorlink" href="#scopes-for-has-many-offset">4.3.3.6 <code>offset</code></a></h5><p>The <code>offset</code> method lets you specify the starting offset for fetching objects via an association. For example, <code>-&gt; { offset(11) }</code> will skip the first 11 records.</p><h5 id="scopes-for-has-many-order"><a class="anchorlink" href="#scopes-for-has-many-order">4.3.3.7 <code>order</code></a></h5><p>The <code>order</code> method dictates the order in which associated objects will be received (in the syntax used by an SQL <code>ORDER BY</code> clause).</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span> <span class="s2">"date_confirmed DESC"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, -> { order &quot;date_confirmed DESC&quot; }
end
">Copy</button>
</div>
<h5 id="scopes-for-has-many-readonly"><a class="anchorlink" href="#scopes-for-has-many-readonly">4.3.3.8 <code>readonly</code></a></h5><p>If you use the <code>readonly</code> method, then the associated objects will be read-only when retrieved via the association.</p><h5 id="scopes-for-has-many-select"><a class="anchorlink" href="#scopes-for-has-many-select">4.3.3.9 <code>select</code></a></h5><p>The <code>select</code> method lets you override the SQL <code>SELECT</code> clause that is used to retrieve data about the associated objects. By default, Rails retrieves all columns.</p><div class="warning"><p>If you specify your own <code>select</code>, be sure to include the primary key and foreign key columns of the associated model. If you do not, Rails will throw an error.</p></div><h5 id="scopes-for-has-many-distinct"><a class="anchorlink" href="#scopes-for-has-many-distinct">4.3.3.10 <code>distinct</code></a></h5><p>Use the <code>distinct</code> method to keep the collection free of duplicates. This is
mostly useful together with the <code>:through</code> option.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:readings</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">through: :readings</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person < ApplicationRecord
  has_many :readings
  has_many :articles, through: :readings
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'John'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">to_a</span>
<span class="gp">=&gt; [#&lt;Article id: 5, name: "a1"&gt;</span><span class="p">,</span> <span class="c1">#&lt;Article id: 5, name: "a1"&gt;]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Reading</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">12</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">5</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">13</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">5</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.create(name: 'John')
article = Article.create(name: 'a1')
person.articles << article
person.articles << article
person.articles.to_a
Reading.all.to_a
">Copy</button>
</div>
<p>In the above case there are two readings and <code>person.articles</code> brings out both of
them even though these records are pointing to the same article.</p><p>Now let's set <code>distinct</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Person</span>
  <span class="n">has_many</span> <span class="ss">:readings</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">distinct</span> <span class="p">},</span> <span class="ss">through: :readings</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person
  has_many :readings
  has_many :articles, -> { distinct }, through: :readings
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Honda'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">to_a</span>
<span class="gp">=&gt; [#&lt;Article id: 7, name: "a1"&gt;</span><span class="p">]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Reading</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">16</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">7</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">7</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">17</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">7</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">7</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.create(name: 'Honda')
article = Article.create(name: 'a1')
person.articles << article
person.articles << article
person.articles.to_a
Reading.all.to_a
">Copy</button>
</div>
<p>In the above case there are still two readings. However <code>person.articles</code> shows
only one article because the collection loads only unique records.</p><p>If you want to make sure that, upon insertion, all of the records in the
persisted association are distinct (so that you can be sure that when you
inspect the association that you will never find duplicate records), you should
add a unique index on the table itself. For example, if you have a table named
<code>readings</code> and you want to make sure the articles can only be added to a person once,
you could add the following in a migration:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">add_index</span> <span class="ss">:readings</span><span class="p">,</span> <span class="p">[</span><span class="ss">:person_id</span><span class="p">,</span> <span class="ss">:article_id</span><span class="p">],</span> <span class="ss">unique: </span><span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="add_index :readings, [:person_id, :article_id], unique: true
">Copy</button>
</div>
<p>Once you have this unique index, attempting to add the article to a person twice
will raise an <code>ActiveRecord::RecordNotUnique</code> error:</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Honda'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="go">ActiveRecord::RecordNotUnique
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.create(name: 'Honda')
article = Article.create(name: 'a1')
person.articles << article
person.articles << article
">Copy</button>
</div>
<p>Note that checking for uniqueness using something like <code>include?</code> is subject
to race conditions. Do not attempt to use <code>include?</code> to enforce distinctness
in an association. For instance, using the article example from above, the
following code would be racy because multiple users could be attempting this
at the same time:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span> <span class="k">unless</span> <span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person.articles << article unless person.articles.include?(article)
">Copy</button>
</div>
<h4 id="has-many-association-reference-when-are-objects-saved-questionmark"><a class="anchorlink" href="#has-many-association-reference-when-are-objects-saved-questionmark">4.3.4 When are Objects Saved?</a></h4><p>When you assign an object to a <code>has_many</code> association, that object is automatically saved (in order to update its foreign key). If you assign multiple objects in one statement, then they are all saved.</p><p>If any of these saves fails due to validation errors, then the assignment statement returns <code>false</code> and the assignment itself is cancelled.</p><p>If the parent object (the one declaring the <code>has_many</code> association) is unsaved (that is, <code>new_record?</code> returns <code>true</code>) then the child objects are not saved when they are added. All unsaved members of the association will automatically be saved when the parent is saved.</p><p>If you want to assign an object to a <code>has_many</code> association without saving the object, use the <code>collection.build</code> method.</p><h3 id="has-and-belongs-to-many-association-reference"><a class="anchorlink" href="#has-and-belongs-to-many-association-reference">4.4 <code>has_and_belongs_to_many</code> Association Reference</a></h3><p>The <code>has_and_belongs_to_many</code> association creates a many-to-many relationship with another model. In database terms, this associates two classes via an intermediate join table that includes foreign keys referring to each of the classes.</p><h4 id="methods-added-by-has-and-belongs-to-many"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many">4.4.1 Methods Added by <code>has_and_belongs_to_many</code></a></h4><p>When you declare a <code>has_and_belongs_to_many</code> association, the declaring class automatically gains several methods related to the association:</p>
<ul>
<li><code>collection</code></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;(object, ...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete(object, ...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy(object, ...)</code></a></li>
<li><code>collection=(objects)</code></li>
<li><code>collection_singular_ids</code></li>
<li><code>collection_singular_ids=(ids)</code></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find(...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where(...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?(...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build(attributes = {})</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create(attributes = {})</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create-21"><code>collection.create!(attributes = {})</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a></li>
</ul>
<p>In all of these methods, <code>collection</code> is replaced with the symbol passed as the first argument to <code>has_and_belongs_to_many</code>, and <code>collection_singular</code> is replaced with the singularized version of that symbol. For example, given the declaration:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Part < ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p>Each instance of the <code>Part</code> model will have these methods:</p><div class="code_container">
<pre><code class="highlight plaintext">assemblies
assemblies&lt;&lt;(object, ...)
assemblies.delete(object, ...)
assemblies.destroy(object, ...)
assemblies=(objects)
assembly_ids
assembly_ids=(ids)
assemblies.clear
assemblies.empty?
assemblies.size
assemblies.find(...)
assemblies.where(...)
assemblies.exists?(...)
assemblies.build(attributes = {}, ...)
assemblies.create(attributes = {})
assemblies.create!(attributes = {})
assemblies.reload
</code></pre>
<button class="clipboard-button" data-clipboard-text="assemblies
assemblies<<(object, ...)
assemblies.delete(object, ...)
assemblies.destroy(object, ...)
assemblies=(objects)
assembly_ids
assembly_ids=(ids)
assemblies.clear
assemblies.empty?
assemblies.size
assemblies.find(...)
assemblies.where(...)
assemblies.exists?(...)
assemblies.build(attributes = {}, ...)
assemblies.create(attributes = {})
assemblies.create!(attributes = {})
assemblies.reload
">Copy</button>
</div>
<h5 id="additional-column-methods"><a class="anchorlink" href="#additional-column-methods">4.4.1.1 Additional Column Methods</a></h5><p>If the join table for a <code>has_and_belongs_to_many</code> association has additional columns beyond the two foreign keys, these columns will be added as attributes to records retrieved via that association. Records returned with additional attributes will always be read-only, because Rails cannot save changes to those attributes.</p><div class="warning"><p>The use of extra attributes on the join table in a <code>has_and_belongs_to_many</code> association is deprecated. If you require this sort of complex behavior on the table that joins two models in a many-to-many relationship, you should use a <code>has_many :through</code> association instead of <code>has_and_belongs_to_many</code>.</p></div><h5 id="methods-added-by-has-and-belongs-to-many-collection"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection">4.4.1.2 <code>collection</code></a></h5><p>The <code>collection</code> method returns a Relation of all of the associated objects. If there are no associated objects, it returns an empty Relation.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assemblies = @part.assemblies
">Copy</button>
</div>
<h5 id="methods-added-by-has-and-belongs-to-many-collection-object"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-object">4.4.1.3 <code>collection&lt;&lt;(object, ...)</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;</code></a> method adds one or more objects to the collection by creating records in the join table.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span> <span class="o">&lt;&lt;</span> <span class="vi">@assembly1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@part.assemblies << @assembly1
">Copy</button>
</div>
<div class="note"><p>This method is aliased as <code>collection.concat</code> and <code>collection.push</code>.</p></div><h5 id="methods-added-by-has-and-belongs-to-many-collection-delete-object"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-delete-object">4.4.1.4 <code>collection.delete(object, ...)</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete</code></a> method removes one or more objects from the collection by deleting records in the join table. This does not destroy the objects.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="vi">@assembly1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@part.assemblies.delete(@assembly1)
">Copy</button>
</div>
<h5 id="methods-added-by-has-and-belongs-to-many-collection-destroy-object"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-destroy-object">4.4.1.5 <code>collection.destroy(object, ...)</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy</code></a> method removes one or more objects from the collection by deleting records in the join table. This does not destroy the objects.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="vi">@assembly1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@part.assemblies.destroy(@assembly1)
">Copy</button>
</div>
<h5 id="methods-added-by-has-and-belongs-to-many-collection-objects"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-objects">4.4.1.6 <code>collection=(objects)</code></a></h5><p>The <code>collection=</code> method makes the collection contain only the supplied objects, by adding and deleting as appropriate. The changes are persisted to the database.</p><h5 id="methods-added-by-has-and-belongs-to-many-collection-singular-ids"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-singular-ids">4.4.1.7 <code>collection_singular_ids</code></a></h5><p>The <code>collection_singular_ids</code> method returns an array of the ids of the objects in the collection.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly_ids</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assembly_ids</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly_ids = @part.assembly_ids
">Copy</button>
</div>
<h5 id="methods-added-by-has-and-belongs-to-many-collection-singular-ids-ids"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-singular-ids-ids">4.4.1.8 <code>collection_singular_ids=(ids)</code></a></h5><p>The <code>collection_singular_ids=</code> method makes the collection contain only the objects identified by the supplied primary key values, by adding and deleting as appropriate. The changes are persisted to the database.</p><h5 id="methods-added-by-has-and-belongs-to-many-collection-clear"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-clear">4.4.1.9 <code>collection.clear</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a> method removes every object from the collection by deleting the rows from the joining table. This does not destroy the associated objects.</p><h5 id="methods-added-by-has-and-belongs-to-many-collection-empty-questionmark"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-empty-questionmark">4.4.1.10 <code>collection.empty?</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a> method returns <code>true</code> if the collection does not contain any associated objects.</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">empty?</span> <span class="cp">%&gt;</span>
  This part is not used in any assemblies
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<% if @part.assemblies.empty? %>
  This part is not used in any assemblies
<% end %>
">Copy</button>
</div>
<h5 id="methods-added-by-has-and-belongs-to-many-collection-size"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-size">4.4.1.11 <code>collection.size</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a> method returns the number of objects in the collection.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly_count</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">size</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly_count = @part.assemblies.size
">Copy</button>
</div>
<h5 id="methods-added-by-has-and-belongs-to-many-collection-find"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-find">4.4.1.12 <code>collection.find(...)</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find</code></a> method finds objects within the collection's table.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly = @part.assemblies.find(1)
">Copy</button>
</div>
<h5 id="methods-added-by-has-and-belongs-to-many-collection-where"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-where">4.4.1.13 <code>collection.where(...)</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where</code></a> method finds objects within the collection based on the conditions supplied but the objects are loaded lazily meaning that the database is queried only when the object(s) are accessed.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@new_assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"created_at &gt; ?"</span><span class="p">,</span> <span class="mi">2</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@new_assemblies = @part.assemblies.where(&quot;created_at > ?&quot;, 2.days.ago)
">Copy</button>
</div>
<h5 id="methods-added-by-has-and-belongs-to-many-collection-exists-questionmark"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-exists-questionmark">4.4.1.14 <code>collection.exists?(...)</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?</code></a> method checks whether an object meeting the supplied
conditions exists in the collection's table.</p><h5 id="methods-added-by-has-and-belongs-to-many-collection-build-attributes"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-build-attributes">4.4.1.15 <code>collection.build(attributes = {})</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build</code></a> method returns a new object of the associated type. This object will be instantiated from the passed attributes, and the link through the join table will be created, but the associated object will <em>not</em> yet be saved.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">build</span><span class="p">({</span> <span class="ss">assembly_name: </span><span class="s2">"Transmission housing"</span> <span class="p">})</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly = @part.assemblies.build({ assembly_name: &quot;Transmission housing&quot; })
">Copy</button>
</div>
<h5 id="methods-added-by-has-and-belongs-to-many-collection-create-attributes"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-create-attributes">4.4.1.16 <code>collection.create(attributes = {})</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create</code></a> method returns a new object of the associated type. This object will be instantiated from the passed attributes, the link through the join table will be created, and, once it passes all of the validations specified on the associated model, the associated object <em>will</em> be saved.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">create</span><span class="p">({</span> <span class="ss">assembly_name: </span><span class="s2">"Transmission housing"</span> <span class="p">})</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly = @part.assemblies.create({ assembly_name: &quot;Transmission housing&quot; })
">Copy</button>
</div>
<h5 id="methods-added-by-has-and-belongs-to-many-collection-create-bang-attributes"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-create-bang-attributes">4.4.1.17 <code>collection.create!(attributes = {})</code></a></h5><p>Does the same as <code>collection.create</code>, but raises <code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p><h5 id="methods-added-by-has-and-belongs-to-many-collection-reload"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-collection-reload">4.4.1.18 <code>collection.reload</code></a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a> method returns a Relation of all of the associated objects, forcing a database read. If there are no associated objects, it returns an empty Relation.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assemblies = @part.assemblies.reload
">Copy</button>
</div>
<h4 id="options-for-has-and-belongs-to-many"><a class="anchorlink" href="#options-for-has-and-belongs-to-many">4.4.2 Options for <code>has_and_belongs_to_many</code></a></h4><p>While Rails uses intelligent defaults that will work well in most situations, there may be times when you want to customize the behavior of the <code>has_and_belongs_to_many</code> association reference. Such customizations can easily be accomplished by passing options when you create the association. For example, this association uses two such options:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">readonly</span> <span class="p">},</span>
                                       <span class="ss">autosave: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts < ApplicationRecord
  has_and_belongs_to_many :assemblies, -> { readonly },
                                       autosave: true
end
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many"><code>has_and_belongs_to_many</code></a> association supports these options:</p>
<ul>
<li><code>:association_foreign_key</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:foreign_key</code></li>
<li><code>:join_table</code></li>
<li><code>:strict_loading</code></li>
<li><code>:validate</code></li>
</ul>
<h5 id="association-foreign-key"><a class="anchorlink" href="#association-foreign-key">4.4.2.1 <code>:association_foreign_key</code></a></h5><p>By convention, Rails assumes that the column in the join table used to hold the foreign key pointing to the other model is the name of that model with the suffix <code>_id</code> added. The <code>:association_foreign_key</code> option lets you set the name of the foreign key directly:</p><div class="info"><p>The <code>:foreign_key</code> and <code>:association_foreign_key</code> options are useful when setting up a many-to-many self-join. For example:</p></div><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:friends</span><span class="p">,</span>
      <span class="ss">class_name: </span><span class="s2">"User"</span><span class="p">,</span>
      <span class="ss">foreign_key: </span><span class="s2">"this_user_id"</span><span class="p">,</span>
      <span class="ss">association_foreign_key: </span><span class="s2">"other_user_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  has_and_belongs_to_many :friends,
      class_name: &quot;User&quot;,
      foreign_key: &quot;this_user_id&quot;,
      association_foreign_key: &quot;other_user_id&quot;
end
">Copy</button>
</div>
<h5 id="options-for-has-and-belongs-to-many-autosave"><a class="anchorlink" href="#options-for-has-and-belongs-to-many-autosave">4.4.2.2 <code>:autosave</code></a></h5><p>If you set the <code>:autosave</code> option to <code>true</code>, Rails will save any loaded association members and destroy members that are marked for destruction whenever you save the parent object. Setting <code>:autosave</code> to <code>false</code> is not the same as not setting the <code>:autosave</code> option. If the <code>:autosave</code> option is not present, then new associated objects will be saved, but updated associated objects will not be saved.</p><h5 id="options-for-has-and-belongs-to-many-class-name"><a class="anchorlink" href="#options-for-has-and-belongs-to-many-class-name">4.4.2.3 <code>:class_name</code></a></h5><p>If the name of the other model cannot be derived from the association name, you can use the <code>:class_name</code> option to supply the model name. For example, if a part has many assemblies, but the actual name of the model containing assemblies is <code>Gadget</code>, you'd set things up this way:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Gadget"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts < ApplicationRecord
  has_and_belongs_to_many :assemblies, class_name: &quot;Gadget&quot;
end
">Copy</button>
</div>
<h5 id="options-for-has-and-belongs-to-many-foreign-key"><a class="anchorlink" href="#options-for-has-and-belongs-to-many-foreign-key">4.4.2.4 <code>:foreign_key</code></a></h5><p>By convention, Rails assumes that the column in the join table used to hold the foreign key pointing to this model is the name of this model with the suffix <code>_id</code> added. The <code>:foreign_key</code> option lets you set the name of the foreign key directly:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:friends</span><span class="p">,</span>
      <span class="ss">class_name: </span><span class="s2">"User"</span><span class="p">,</span>
      <span class="ss">foreign_key: </span><span class="s2">"this_user_id"</span><span class="p">,</span>
      <span class="ss">association_foreign_key: </span><span class="s2">"other_user_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  has_and_belongs_to_many :friends,
      class_name: &quot;User&quot;,
      foreign_key: &quot;this_user_id&quot;,
      association_foreign_key: &quot;other_user_id&quot;
end
">Copy</button>
</div>
<h5 id="join-table"><a class="anchorlink" href="#join-table">4.4.2.5 <code>:join_table</code></a></h5><p>If the default name of the join table, based on lexical ordering, is not what you want, you can use the <code>:join_table</code> option to override the default.</p><h5 id="options-for-has-and-belongs-to-many-strict-loading"><a class="anchorlink" href="#options-for-has-and-belongs-to-many-strict-loading">4.4.2.6 <code>:strict_loading</code></a></h5><p>Enforces strict loading every time an associated record is loaded through this association.</p><h5 id="options-for-has-and-belongs-to-many-validate"><a class="anchorlink" href="#options-for-has-and-belongs-to-many-validate">4.4.2.7 <code>:validate</code></a></h5><p>If you set the <code>:validate</code> option to <code>false</code>, then new associated objects will not be validated whenever you save this object. By default, this is <code>true</code>: new associated objects will be validated when this object is saved.</p><h4 id="scopes-for-has-and-belongs-to-many"><a class="anchorlink" href="#scopes-for-has-and-belongs-to-many">4.4.3 Scopes for <code>has_and_belongs_to_many</code></a></h4><p>There may be times when you wish to customize the query used by <code>has_and_belongs_to_many</code>. Such customizations can be achieved via a scope block. For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts < ApplicationRecord
  has_and_belongs_to_many :assemblies, -> { where active: true }
end
">Copy</button>
</div>
<p>You can use any of the standard <a href="active_record_querying.html">querying methods</a> inside the scope block. The following ones are discussed below:</p>
<ul>
<li><code>where</code></li>
<li><code>extending</code></li>
<li><code>group</code></li>
<li><code>includes</code></li>
<li><code>limit</code></li>
<li><code>offset</code></li>
<li><code>order</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
<li><code>distinct</code></li>
</ul>
<h5 id="scopes-for-has-and-belongs-to-many-where"><a class="anchorlink" href="#scopes-for-has-and-belongs-to-many-where">4.4.3.1 <code>where</code></a></h5><p>The <code>where</code> method lets you specify the conditions that the associated object must meet.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"factory = 'Seattle'"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts < ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -> { where &quot;factory = 'Seattle'&quot; }
end
">Copy</button>
</div>
<p>You can also set conditions via a hash:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">factory: </span><span class="s1">'Seattle'</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts < ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -> { where factory: 'Seattle' }
end
">Copy</button>
</div>
<p>If you use a hash-style <code>where</code>, then record creation via this association will be automatically scoped using the hash. In this case, using <code>@parts.assemblies.create</code> or <code>@parts.assemblies.build</code> will create assemblies where the <code>factory</code> column has the value "Seattle".</p><h5 id="scopes-for-has-and-belongs-to-many-extending"><a class="anchorlink" href="#scopes-for-has-and-belongs-to-many-extending">4.4.3.2 <code>extending</code></a></h5><p>The <code>extending</code> method specifies a named module to extend the association proxy. Association extensions are discussed in detail <a href="#association-extensions">later in this guide</a>.</p><h5 id="scopes-for-has-and-belongs-to-many-group"><a class="anchorlink" href="#scopes-for-has-and-belongs-to-many-group">4.4.3.3 <code>group</code></a></h5><p>The <code>group</code> method supplies an attribute name to group the result set by, using a <code>GROUP BY</code> clause in the finder SQL.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">group</span> <span class="s2">"factory"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts < ApplicationRecord
  has_and_belongs_to_many :assemblies, -> { group &quot;factory&quot; }
end
">Copy</button>
</div>
<h5 id="scopes-for-has-and-belongs-to-many-includes"><a class="anchorlink" href="#scopes-for-has-and-belongs-to-many-includes">4.4.3.4 <code>includes</code></a></h5><p>You can use the <code>includes</code> method to specify second-order associations that should be eager-loaded when this association is used.</p><h5 id="scopes-for-has-and-belongs-to-many-limit"><a class="anchorlink" href="#scopes-for-has-and-belongs-to-many-limit">4.4.3.5 <code>limit</code></a></h5><p>The <code>limit</code> method lets you restrict the total number of objects that will be fetched through an association.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s2">"created_at DESC"</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts < ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -> { order(&quot;created_at DESC&quot;).limit(50) }
end
">Copy</button>
</div>
<h5 id="scopes-for-has-and-belongs-to-many-offset"><a class="anchorlink" href="#scopes-for-has-and-belongs-to-many-offset">4.4.3.6 <code>offset</code></a></h5><p>The <code>offset</code> method lets you specify the starting offset for fetching objects via an association. For example, if you set <code>offset(11)</code>, it will skip the first 11 records.</p><h5 id="scopes-for-has-and-belongs-to-many-order"><a class="anchorlink" href="#scopes-for-has-and-belongs-to-many-order">4.4.3.7 <code>order</code></a></h5><p>The <code>order</code> method dictates the order in which associated objects will be received (in the syntax used by an SQL <code>ORDER BY</code> clause).</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span> <span class="s2">"assembly_name ASC"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts < ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -> { order &quot;assembly_name ASC&quot; }
end
">Copy</button>
</div>
<h5 id="scopes-for-has-and-belongs-to-many-readonly"><a class="anchorlink" href="#scopes-for-has-and-belongs-to-many-readonly">4.4.3.8 <code>readonly</code></a></h5><p>If you use the <code>readonly</code> method, then the associated objects will be read-only when retrieved via the association.</p><h5 id="scopes-for-has-and-belongs-to-many-select"><a class="anchorlink" href="#scopes-for-has-and-belongs-to-many-select">4.4.3.9 <code>select</code></a></h5><p>The <code>select</code> method lets you override the SQL <code>SELECT</code> clause that is used to retrieve data about the associated objects. By default, Rails retrieves all columns.</p><h5 id="scopes-for-has-and-belongs-to-many-distinct"><a class="anchorlink" href="#scopes-for-has-and-belongs-to-many-distinct">4.4.3.10 <code>distinct</code></a></h5><p>Use the <code>distinct</code> method to remove duplicates from the collection.</p><h4 id="has-and-belongs-to-many-association-reference-when-are-objects-saved-questionmark"><a class="anchorlink" href="#has-and-belongs-to-many-association-reference-when-are-objects-saved-questionmark">4.4.4 When are Objects Saved?</a></h4><p>When you assign an object to a <code>has_and_belongs_to_many</code> association, that object is automatically saved (in order to update the join table). If you assign multiple objects in one statement, then they are all saved.</p><p>If any of these saves fails due to validation errors, then the assignment statement returns <code>false</code> and the assignment itself is cancelled.</p><p>If the parent object (the one declaring the <code>has_and_belongs_to_many</code> association) is unsaved (that is, <code>new_record?</code> returns <code>true</code>) then the child objects are not saved when they are added. All unsaved members of the association will automatically be saved when the parent is saved.</p><p>If you want to assign an object to a <code>has_and_belongs_to_many</code> association without saving the object, use the <code>collection.build</code> method.</p><h3 id="association-callbacks"><a class="anchorlink" href="#association-callbacks">4.5 Association Callbacks</a></h3><p>Normal callbacks hook into the life cycle of Active Record objects, allowing you to work with those objects at various points. For example, you can use a <code>:before_save</code> callback to cause something to happen just before an object is saved.</p><p>Association callbacks are similar to normal callbacks, but they are triggered by events in the life cycle of a collection. There are four available association callbacks:</p>
<ul>
<li><code>before_add</code></li>
<li><code>after_add</code></li>
<li><code>before_remove</code></li>
<li><code>after_remove</code></li>
</ul>
<p>You define association callbacks by adding options to the association declaration. For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">before_add: :check_credit_limit</span>

  <span class="k">def</span> <span class="nf">check_credit_limit</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, before_add: :check_credit_limit

  def check_credit_limit(book)
    # ...
  end
end
">Copy</button>
</div>
<p>Read more about association callbacks in the <a href="active_record_callbacks.html#association-callbacks">Active Record Callbacks Guide</a></p><h3 id="association-extensions"><a class="anchorlink" href="#association-extensions">4.6 Association Extensions</a></h3><p>You're not limited to the functionality that Rails automatically builds into association proxy objects. You can also extend these objects through anonymous modules, adding new finders, creators, or other methods. For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">find_by_book_prefix</span><span class="p">(</span><span class="n">book_number</span><span class="p">)</span>
      <span class="n">find_by</span><span class="p">(</span><span class="ss">category_id: </span><span class="n">book_number</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books do
    def find_by_book_prefix(book_number)
      find_by(category_id: book_number[0..2])
    end
  end
end
">Copy</button>
</div>
<p>If you have an extension that should be shared by many associations, you can use a named extension module. For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">FindRecentExtension</span>
  <span class="k">def</span> <span class="nf">find_recent</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"created_at &gt; ?"</span><span class="p">,</span> <span class="mi">5</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:deliveries</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module FindRecentExtension
  def find_recent
    where(&quot;created_at > ?&quot;, 5.days.ago)
  end
end

class Author < ApplicationRecord
  has_many :books, -> { extending FindRecentExtension }
end

class Supplier < ApplicationRecord
  has_many :deliveries, -> { extending FindRecentExtension }
end
">Copy</button>
</div>
<p>Extensions can refer to the internals of the association proxy using these three attributes of the <code>proxy_association</code> accessor:</p>
<ul>
<li><code>proxy_association.owner</code> returns the object that the association is a part of.</li>
<li><code>proxy_association.reflection</code> returns the reflection object that describes the association.</li>
<li><code>proxy_association.target</code> returns the associated object for <code>belongs_to</code> or <code>has_one</code>, or the collection of associated objects for <code>has_many</code> or <code>has_and_belongs_to_many</code>.</li>
</ul>
<h3 id="association-scoping-using-the-association-owner"><a class="anchorlink" href="#association-scoping-using-the-association-owner">4.7 Association Scoping using the Association Owner</a></h3><p>The owner of the association can be passed as a single argument to the scope
block in situations where you need even more control over the association
scope. However, as a caveat, preloading the association will no longer be
possible.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">supplier</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="n">supplier</span><span class="p">.</span><span class="nf">active?</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account, ->(supplier) { where active: supplier.active? }
end
">Copy</button>
</div>
<h2 id="single-table-inheritance-sti"><a class="anchorlink" href="#single-table-inheritance-sti">5 Single Table Inheritance (STI)</a></h2><p>Sometimes, you may want to share fields and behavior between different models.
Let's say we have Car, Motorcycle, and Bicycle models. We will want to share
the <code>color</code> and <code>price</code> fields and some methods for all of them, but having some
specific behavior for each, and separated controllers too.</p><p>First, let's generate the base Vehicle model:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model vehicle <span class="nb">type</span>:string color:string price:decimal<span class="o">{</span>10.2<span class="o">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model vehicle type:string color:string price:decimal{10.2}
">Copy</button>
</div>
<p>Did you note we are adding a "type" field? Since all models will be saved in a
single database table, Rails will save in this column the name of the model that
is being saved. In our example, this can be "Car", "Motorcycle" or "Bicycle."
STI won't work without a "type" field in the table.</p><p>Next, we will generate the Car model that inherits from Vehicle. For this,
we can use the <code>--parent=PARENT</code> option, which will generate a model that
inherits from the specified parent and without equivalent migration (since the
table already exists).</p><p>For example, to generate the Car model:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model car <span class="nt">--parent</span><span class="o">=</span>Vehicle
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model car --parent=Vehicle
">Copy</button>
</div>
<p>The generated model will look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">Vehicle</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Car < Vehicle
end
">Copy</button>
</div>
<p>This means that all behavior added to Vehicle is available for Car too, as
associations, public methods, etc.</p><p>Creating a car will save it in the <code>vehicles</code> table with "Car" as the <code>type</code> field:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Car</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">color: </span><span class="s1">'Red'</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">10000</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Car.create(color: 'Red', price: 10000)
">Copy</button>
</div>
<p>will generate the following SQL:</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"vehicles"</span> <span class="p">(</span><span class="nv">"type"</span><span class="p">,</span> <span class="nv">"color"</span><span class="p">,</span> <span class="nv">"price"</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Car'</span><span class="p">,</span> <span class="s1">'Red'</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="INSERT INTO &quot;vehicles&quot; (&quot;type&quot;, &quot;color&quot;, &quot;price&quot;) VALUES ('Car', 'Red', 10000)
">Copy</button>
</div>
<p>Querying car records will search only for vehicles that are cars:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Car</span><span class="p">.</span><span class="nf">all</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Car.all
">Copy</button>
</div>
<p>will run a query like:</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="nv">"vehicles"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"vehicles"</span> <span class="k">WHERE</span> <span class="nv">"vehicles"</span><span class="p">.</span><span class="nv">"type"</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'Car'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT &quot;vehicles&quot;.* FROM &quot;vehicles&quot; WHERE &quot;vehicles&quot;.&quot;type&quot; IN ('Car')
">Copy</button>
</div>
<h2 id="delegated-types"><a class="anchorlink" href="#delegated-types">6 Delegated Types</a></h2><p><a href="#single-table-inheritance-sti"><code>Single Table Inheritance (STI)</code></a> works best when there is little difference between subclasses and their attributes, but includes all attributes of all subclasses you need to create a single table.</p><p>The disadvantage of this approach is that it results in bloat to that table. Since it will even include attributes specific to a subclass that aren't used by anything else.</p><p>In the following example, there are two Active Record models that inherit from the same "Entry" class which includes the <code>subject</code> attribute.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Schema: entries[ id, type, subject, created_at, updated_at]</span>
<span class="k">class</span> <span class="nc">Entry</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">Entry</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">Entry</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Schema: entries[ id, type, subject, created_at, updated_at]
class Entry < ApplicationRecord
end

class Comment < Entry
end

class Message < Entry
end
">Copy</button>
</div>
<p>Delegated types solves this problem, via <code>delegated_type</code>.</p><p>In order to use delegated types, we have to model our data in a particular way. The requirements are as follows:</p>
<ul>
<li>There is a superclass that stores shared attributes among all subclasses in it's table.</li>
<li>Each subclass must inherit from the super class, and will have a separate table for any additional attributes specific to it.</li>
</ul>
<p>This eliminates the need to define attributes in a single table that are unintentionally shared among all subclasses.</p><p>In order to apply this to our example above, we need to regenerate our models.
First, let's generate the base <code>Entry</code> model which will act as our superclass:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model entry entryable_type:string entryable_id:integer
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model entry entryable_type:string entryable_id:integer
">Copy</button>
</div>
<p>Then, we will generate new <code>Message</code> and <code>Comment</code> models for delegation:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model message subject:string body:string
<span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model comment content:string
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model message subject:string body:string
bin/rails generate model comment content:string
">Copy</button>
</div>
<p>After running the generators, we should end up with models that look like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Schema: entries[ id, entryable_type, entryable_id, created_at, updated_at ]</span>
<span class="k">class</span> <span class="nc">Entry</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="c1"># Schema: messages[ id, subject, body, created_at, updated_at ]</span>
<span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="c1"># Schema: comments[ id, content, created_at, updated_at ]</span>
<span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Schema: entries[ id, entryable_type, entryable_id, created_at, updated_at ]
class Entry < ApplicationRecord
end

# Schema: messages[ id, subject, body, created_at, updated_at ]
class Message < ApplicationRecord
end

# Schema: comments[ id, content, created_at, updated_at ]
class Comment < ApplicationRecord
end
">Copy</button>
</div>
<h3 id="declare-delegated-type"><a class="anchorlink" href="#declare-delegated-type">6.1 Declare <code>delegated_type</code></a></h3><p>First, declare a <code>delegated_type</code> in the superclass <code>Entry</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Entry</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">delegated_type</span> <span class="ss">:entryable</span><span class="p">,</span> <span class="ss">types: </span><span class="sx">%w[ Message Comment ]</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Entry < ApplicationRecord
  delegated_type :entryable, types: %w[ Message Comment ], dependent: :destroy
end
">Copy</button>
</div>
<p>The <code>entryable</code> parameter specifies the field to use for delegation, and include the types <code>Message</code> and <code>Comment</code> as the delegate classes.</p><p>The <code>Entry</code> class has <code>entryable_type</code> and <code>entryable_id</code> fields. This is the field with the <code>_type</code>, <code>_id</code> suffixes added to the name <code>entryable</code> in the <code>delegated_type</code> definition.
<code>entryable_type</code> stores the subclass name of the delegatee, and <code>entryable_id</code> stores the record id of the delegatee subclass.</p><p>Next, we must define a module to implement those delegated types, by declaring the <code>as: :entryable</code> parameter to the <code>has_one</code> association.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Entryable</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">has_one</span> <span class="ss">:entry</span><span class="p">,</span> <span class="ss">as: :entryable</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module Entryable
  extend ActiveSupport::Concern

  included do
    has_one :entry, as: :entryable, touch: true
  end
end
">Copy</button>
</div>
<p>And then include the created module in your subclass.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">Entryable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">Entryable</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Message < ApplicationRecord
  include Entryable
end

class Comment < ApplicationRecord
  include Entryable
end
">Copy</button>
</div>
<p>With this definition complete, our <code>Entry</code> delegator now provides the following methods:</p>
<table><thead>
<tr>
<th>Method</th>
<th>Return</th>
</tr>
</thead><tbody>
<tr>
<td><code>Entry.entryable_types</code></td>
<td>["Message", "Comment"]</td>
</tr>
<tr>
<td><code>Entry#entryable_class</code></td>
<td>Message or Comment</td>
</tr>
<tr>
<td><code>Entry#entryable_name</code></td>
<td>"message" or "comment"</td>
</tr>
<tr>
<td><code>Entry.messages</code></td>
<td><code>Entry.where(entryable_type: "Message")</code></td>
</tr>
<tr>
<td><code>Entry#message?</code></td>
<td>Returns true when <code>entryable_type == "Message"</code></td>
</tr>
<tr>
<td><code>Entry#message</code></td>
<td>Returns the message record, when <code>entryable_type == "Message"</code>, otherwise <code>nil</code></td>
</tr>
<tr>
<td><code>Entry#message_id</code></td>
<td>Returns <code>entryable_id</code>, when <code>entryable_type == "Message"</code>, otherwise <code>nil</code></td>
</tr>
<tr>
<td><code>Entry.comments</code></td>
<td><code>Entry.where(entryable_type: "Comment")</code></td>
</tr>
<tr>
<td><code>Entry#comment?</code></td>
<td>Returns true when <code>entryable_type == "Comment"</code></td>
</tr>
<tr>
<td><code>Entry#comment</code></td>
<td>Returns the comment record, when <code>entryable_type == "Comment"</code>, otherwise <code>nil</code></td>
</tr>
<tr>
<td><code>Entry#comment_id</code></td>
<td>Returns entryable_id, when <code>entryable_type == "Comment"</code>, otherwise <code>nil</code></td>
</tr>
</tbody></table>
<h3 id="object-creation"><a class="anchorlink" href="#object-creation">6.2 Object creation</a></h3><p>When creating a new <code>Entry</code> object, we can specify the <code>entryable</code> subclass at the same time.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Entry</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">entryable: </span><span class="no">Message</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">subject: </span><span class="s2">"hello!"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Entry.create! entryable: Message.new(subject: &quot;hello!&quot;)
">Copy</button>
</div>
<h3 id="adding-further-delegation"><a class="anchorlink" href="#adding-further-delegation">6.3 Adding further delegation</a></h3><p>We can expand our <code>Entry</code> delegator and enhance it further by defining <code>delegate</code> and using polymorphism on the subclasses.
For example, to delegate the <code>title</code> method from <code>Entry</code> to it's subclasses:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Entry</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">delegated_type</span> <span class="ss">:entryable</span><span class="p">,</span> <span class="ss">types: </span><span class="sx">%w[ Message Comment ]</span>
  <span class="n">delegate</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">to: :entryable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">Entryable</span>

  <span class="k">def</span> <span class="nf">title</span>
    <span class="n">subject</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">Entryable</span>

  <span class="k">def</span> <span class="nf">title</span>
    <span class="n">content</span><span class="p">.</span><span class="nf">truncate</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Entry < ApplicationRecord
  delegated_type :entryable, types: %w[ Message Comment ]
  delegate :title, to: :entryable
end

class Message < ApplicationRecord
  include Entryable

  def title
    subject
  end
end

class Comment < ApplicationRecord
  include Entryable

  def title
    content.truncate(20)
  end
end
">Copy</button>
</div>


        <h3>Feedback</h3>
        <p>
          You're encouraged to help improve the quality of this guide.
        </p>
        <p>
          Please contribute if you see any typos or factual errors.
          To get started, you can read our <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">documentation contributions</a> section.
        </p>
        <p>
          You may also find incomplete content or stuff that is not up to date.
          Please do add any missing documentation for main. Make sure to check
          <a href="https://edgeguides.rubyonrails.org">Edge Guides</a> first to verify
          if the issues are already fixed or not on the main branch.
          Check the <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a>
          for style and conventions.
        </p>
        <p>
          If for whatever reason you spot something to fix but cannot patch it yourself, please
          <a href="https://github.com/rails/rails/issues">open an issue</a>.
        </p>
        <p>And last but not least, any kind of discussion regarding Ruby on Rails
          documentation is very welcome on the <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">official Ruby on Rails Forum</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>This work is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a> License</p>
<p>"Rails", "Ruby on Rails", and the Rails logo are trademarks of David Heinemeier Hansson. All rights reserved.</p>

    </div>
  </div>
</body>
</html>
