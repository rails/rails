<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Active Record Migrations — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbo-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbo-track="reload">
  
  <link rel="icon" href="images/favicon.ico" sizes="any">
  <link rel="icon" href="images/icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="images/icon.png">
  
  <script src="javascripts/@hotwired--turbo.js" data-turbo-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbo-track="reload"></script>
  <script src="javascripts/guides.js" data-turbo-track="reload"></script>

  <meta property="og:title" content="Active Record Migrations — Ruby on Rails Guides" />
  <meta name="description" content="Active Record MigrationsMigrations are a feature of Active Record that allows you to evolve your database schema over time. Rather than write schema modifications in pure SQL, migrations allow you to use a Ruby DSL to describe changes to your tables.After reading this guide, you will know: The generators you can use to create them. The methods Active Record provides to manipulate your database. The rails commands that manipulate migrations and your schema. How migrations relate to schema.rb." />
  <meta property="og:description" content="Active Record MigrationsMigrations are a feature of Active Record that allows you to evolve your database schema over time. Rather than write schema modifications in pure SQL, migrations allow you to use a Ruby DSL to describe changes to your tables.After reading this guide, you will know: The generators you can use to create them. The methods Active Record provides to manipulate your database. The rails commands that manipulate migrations and your schema. How migrations relate to schema.rb." />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />

  <meta name="theme-color" content="#C81418">
</head>

<body dir="ltr" class="guide">
  <div>
    <div id="version-badge">edge</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">More at <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        More Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://rubyonrails.org/blog">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guides</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribute on GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <div class="header-logo"><a href="index.html" title="Return to home page">Guides.rubyonrails.org</a></div>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guides Index</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Start Here</dt>
                  <dd><a href="getting_started.html">Getting Started with Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Other Components</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Digging Deeper</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="error_reporting.html">Error Reporting in Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading</a></dd>
                  <dd><a href="classic_to_zeitwerk_howto.html">Migrating from Classic to Zeitwerk</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases</a></dd>
                  <dd><a href="active_record_composite_primary_keys.html">Composite Primary Keys</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Extending Rails</dt>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contributing</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Guides Guidelines</a></dd>
                  <dd><a href="development_dependencies_install.html">Installing Rails Core Development Dependencies</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Policies</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="7_1_release_notes.html">Version 7.1 - October 2023</a></dd>
                  <dd><a href="7_0_release_notes.html">Version 7.0 - December 2021</a></dd>
                  <dd><a href="6_1_release_notes.html">Version 6.1 - December 2020</a></dd>
                  <dd><a href="6_0_release_notes.html">Version 6.0 - August 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </dl>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribute</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guides Index</option>
              <optgroup label="Start Here">
                  <option value="getting_started.html">Getting Started with Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Other Components">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
              </optgroup>
              <optgroup label="Digging Deeper">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="error_reporting.html">Error Reporting in Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading</option>
                  <option value="classic_to_zeitwerk_howto.html">Migrating from Classic to Zeitwerk</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases</option>
                  <option value="active_record_composite_primary_keys.html">Composite Primary Keys</option>
              </optgroup>
              <optgroup label="Extending Rails">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
              </optgroup>
              <optgroup label="Contributing">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Guides Guidelines</option>
                  <option value="development_dependencies_install.html">Installing Rails Core Development Dependencies</option>
              </optgroup>
              <optgroup label="Policies">
                  <option value="maintenance_policy.html">Maintenance Policy</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="7_1_release_notes.html">Version 7.1 - October 2023</option>
                  <option value="7_0_release_notes.html">Version 7.0 - December 2021</option>
                  <option value="6_1_release_notes.html">Version 6.1 - December 2020</option>
                  <option value="6_0_release_notes.html">Version 6.0 - August 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h1>Active Record Migrations</h1><p>Migrations are a feature of Active Record that allows you to evolve your
database schema over time. Rather than write schema modifications in pure SQL,
migrations allow you to use a Ruby DSL to describe changes to your tables.</p><p>After reading this guide, you will know:</p>
<ul>
<li>The generators you can use to create them.</li>
<li>The methods Active Record provides to manipulate your database.</li>
<li>The rails commands that manipulate migrations and your schema.</li>
<li>How migrations relate to <code>schema.rb</code>.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/icon_book-close-bookmark-1.svg" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#migration-overview">Migration Overview</a>

<ul>
<li><a href="#making-the-irreversible-possible">Making the Irreversible Possible</a></li>
</ul></li>
<li><a href="#generating-migrations">Generating Migrations</a>

<ul>
<li><a href="#creating-a-standalone-migration">Creating a Standalone Migration</a></li>
<li><a href="#adding-new-columns">Adding New Columns</a></li>
<li><a href="#removing-columns">Removing Columns</a></li>
<li><a href="#creating-new-tables">Creating New Tables</a></li>
<li><a href="#creating-associations-using-references">Creating associations using references</a></li>
<li><a href="#model-generators">Model Generators</a></li>
<li><a href="#passing-modifiers">Passing Modifiers</a></li>
</ul></li>
<li><a href="#writing-migrations">Writing Migrations</a>

<ul>
<li><a href="#creating-a-table">Creating a Table</a></li>
<li><a href="#creating-a-join-table">Creating a Join Table</a></li>
<li><a href="#changing-tables">Changing Tables</a></li>
<li><a href="#changing-columns">Changing Columns</a></li>
<li><a href="#column-modifiers">Column Modifiers</a></li>
<li><a href="#references">References</a></li>
<li><a href="#foreign-keys">Foreign Keys</a></li>
<li><a href="#composite-primary-keys">Composite Primary Keys</a></li>
<li><a href="#when-helpers-aren-t-enough">When Helpers aren't Enough</a></li>
<li><a href="#using-the-change-method">Using the <code>change</code> Method</a></li>
<li><a href="#using-reversible">Using <code>reversible</code></a></li>
<li><a href="#using-the-up-down-methods">Using the <code>up</code>/<code>down</code> Methods</a></li>
<li><a href="#throwing-an-error-to-prevent-reverts">Throwing an error to prevent reverts</a></li>
<li><a href="#reverting-previous-migrations">Reverting Previous Migrations</a></li>
</ul></li>
<li><a href="#running-migrations">Running Migrations</a>

<ul>
<li><a href="#rolling-back">Rolling Back</a></li>
<li><a href="#setup-the-database">Setup the Database</a></li>
<li><a href="#preparing-the-database">Preparing the Database</a></li>
<li><a href="#resetting-the-database">Resetting the Database</a></li>
<li><a href="#running-specific-migrations">Running Specific Migrations</a></li>
<li><a href="#running-migrations-in-different-environments">Running Migrations in Different Environments</a></li>
<li><a href="#changing-the-output-of-running-migrations">Changing the Output of Running Migrations</a></li>
</ul></li>
<li><a href="#changing-existing-migrations">Changing Existing Migrations</a></li>
<li><a href="#schema-dumping-and-you">Schema Dumping and You</a>

<ul>
<li><a href="#what-are-schema-files-for-questionmark">What are Schema Files for?</a></li>
<li><a href="#types-of-schema-dumps">Types of Schema Dumps</a></li>
<li><a href="#schema-dumps-and-source-control">Schema Dumps and Source Control</a></li>
</ul></li>
<li><a href="#active-record-and-referential-integrity">Active Record and Referential Integrity</a></li>
<li><a href="#migrations-and-seed-data">Migrations and Seed Data</a></li>
<li><a href="#old-migrations">Old Migrations</a>

<ul>
<li><a href="#migrations-from-engines">Migrations from Engines</a></li>
</ul></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h2 id="migration-overview"><a class="anchorlink" href="#migration-overview">1 Migration Overview</a></h2><p>Migrations are a convenient way to
<a href="https://en.wikipedia.org/wiki/Schema_migration">alter your database schema over time</a>
in a consistent way. They use a Ruby DSL so that you don't have to
write SQL by hand, allowing your schema and changes to be database independent.</p><p>You can think of each migration as being a new 'version' of the database. A
schema starts off with nothing in it, and each migration modifies it to add or
remove tables, columns, or entries. Active Record knows how to update your
schema along this timeline, bringing it from whatever point it is in the
history to the latest version. Active Record will also update your
<code>db/schema.rb</code> file to match the up-to-date structure of your database.</p><p>Here's an example of a migration:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:description</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateProducts < ActiveRecord::Migration[7.2]
  def change
    create_table :products do |t|
      t.string :name
      t.text :description

      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>This migration adds a table called <code>products</code> with a string column called
<code>name</code> and a text column called <code>description</code>. A primary key column called <code>id</code>
will also be added implicitly, as it's the default primary key for all Active
Record models. The <code>timestamps</code> macro adds two columns, <code>created_at</code> and
<code>updated_at</code>. These special columns are automatically managed by Active Record
if they exist.</p><p>Note that we define the change that we want to happen moving forward in time.
Before this migration is run, there will be no table. After, the table will
exist. Active Record knows how to reverse this migration as well: if we roll
this migration back, it will remove the table.</p><p>On databases that support transactions with statements that change the schema,
each migration is wrapped in a transaction. If the database does not support this
then when a migration fails the parts of it that succeeded will not be rolled
back. You will have to rollback the changes that were made by hand.</p><div class="note"><p>There are certain queries that can't run inside a transaction. If your
adapter supports DDL transactions you can use <code>disable_ddl_transaction!</code> to
disable them for a single migration.</p></div><h3 id="making-the-irreversible-possible"><a class="anchorlink" href="#making-the-irreversible-possible">1.1 Making the Irreversible Possible</a></h3><p>If you wish for a migration to do something that Active Record doesn't know how
to reverse, you can use <code>reversible</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ChangeProductsPrice</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">reversible</span> <span class="k">do</span> <span class="o">|</span><span class="n">direction</span><span class="o">|</span>
      <span class="n">change_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">direction</span><span class="p">.</span><span class="nf">up</span>   <span class="p">{</span> <span class="n">t</span><span class="p">.</span><span class="nf">change</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:string</span> <span class="p">}</span>
        <span class="n">direction</span><span class="p">.</span><span class="nf">down</span> <span class="p">{</span> <span class="n">t</span><span class="p">.</span><span class="nf">change</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:integer</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ChangeProductsPrice < ActiveRecord::Migration[7.2]
  def change
    reversible do |direction|
      change_table :products do |t|
        direction.up   { t.change :price, :string }
        direction.down { t.change :price, :integer }
      end
    end
  end
end
">Copy</button>
</div>
<p>This migration will change the type of the <code>price</code> column to a string,
or back to an integer when the migration is reverted. Notice the block being
passed to <code>direction.up</code> and <code>direction.down</code> respectively.</p><p>Alternatively, you can use <code>up</code> and <code>down</code> instead of <code>change</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ChangeProductsPrice</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">change_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">change</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">down</span>
    <span class="n">change_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">change</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:integer</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ChangeProductsPrice < ActiveRecord::Migration[7.2]
  def up
    change_table :products do |t|
      t.change :price, :string
    end
  end

  def down
    change_table :products do |t|
      t.change :price, :integer
    end
  end
end
">Copy</button>
</div>
<div class="info"><p>More on <a href="#using-reversible"><code>reversible</code></a> later.</p></div><h2 id="generating-migrations"><a class="anchorlink" href="#generating-migrations">2 Generating Migrations</a></h2><h3 id="creating-a-standalone-migration"><a class="anchorlink" href="#creating-a-standalone-migration">2.1 Creating a Standalone Migration</a></h3><p>Migrations are stored as files in the <code>db/migrate</code> directory, one for each
migration class. The name of the file is of the form
<code>YYYYMMDDHHMMSS_create_products.rb</code>, that is to say a UTC timestamp
identifying the migration followed by an underscore followed by the name
of the migration. The name of the migration class (CamelCased version)
should match the latter part of the file name. For example
<code>20080906120000_create_products.rb</code> should define class <code>CreateProducts</code> and
<code>20080906120001_add_details_to_products.rb</code> should define
<code>AddDetailsToProducts</code>. Rails uses this timestamp to determine which migration
should be run and in what order, so if you're copying a migration from another
application or generate a file yourself, be aware of its position in the order.</p><p>Of course, calculating timestamps is no fun, so Active Record provides a
generator to handle making it for you:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration AddPartNumberToProducts
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate migration AddPartNumberToProducts
">Copy</button>
</div>
<p>This will create an appropriately named empty migration:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddPartNumberToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class AddPartNumberToProducts < ActiveRecord::Migration[7.2]
  def change
  end
end
">Copy</button>
</div>
<p>This generator can do much more than prepend a timestamp to the file name.
Based on naming conventions and additional (optional) arguments it can
also start fleshing out the migration.</p><h3 id="adding-new-columns"><a class="anchorlink" href="#adding-new-columns">2.2 Adding New Columns</a></h3><p>If the migration name is of the form "AddColumnToTable" or
"RemoveColumnFromTable" and is followed by a list of column names and
types then a migration containing the appropriate <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_column"><code>add_column</code></a> and
<a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_column"><code>remove_column</code></a> statements will be created.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration AddPartNumberToProducts part_number:string
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate migration AddPartNumberToProducts part_number:string
">Copy</button>
</div>
<p>This will generate the following migration:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddPartNumberToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class AddPartNumberToProducts < ActiveRecord::Migration[7.2]
  def change
    add_column :products, :part_number, :string
  end
end
">Copy</button>
</div>
<p>If you'd like to add an index on the new column, you can do that as well.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration AddPartNumberToProducts part_number:string:index
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate migration AddPartNumberToProducts part_number:string:index
">Copy</button>
</div>
<p>This will generate the appropriate <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_column"><code>add_column</code></a> and <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_index"><code>add_index</code></a> statements:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddPartNumberToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">add_index</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class AddPartNumberToProducts < ActiveRecord::Migration[7.2]
  def change
    add_column :products, :part_number, :string
    add_index :products, :part_number
  end
end
">Copy</button>
</div>
<p>You are <strong>not</strong> limited to one magically generated column. For example:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration AddDetailsToProducts part_number:string price:decimal
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate migration AddDetailsToProducts part_number:string price:decimal
">Copy</button>
</div>
<p>Will generate a schema migration which adds two additional
columns to the <code>products</code> table.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddDetailsToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:decimal</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class AddDetailsToProducts < ActiveRecord::Migration[7.2]
  def change
    add_column :products, :part_number, :string
    add_column :products, :price, :decimal
  end
end
">Copy</button>
</div>
<h3 id="removing-columns"><a class="anchorlink" href="#removing-columns">2.3 Removing Columns</a></h3><p>Similarly, you can generate a migration to remove a column from the command line:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration RemovePartNumberFromProducts part_number:string
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate migration RemovePartNumberFromProducts part_number:string
">Copy</button>
</div>
<p>This generates the appropriate <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_column"><code>remove_column</code></a> statements:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">RemovePartNumberFromProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">remove_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class RemovePartNumberFromProducts < ActiveRecord::Migration[7.2]
  def change
    remove_column :products, :part_number, :string
  end
end
">Copy</button>
</div>
<h3 id="creating-new-tables"><a class="anchorlink" href="#creating-new-tables">2.4 Creating New Tables</a></h3><p>If the migration name is of the form "CreateXXX" and is followed by a list of
column names and types then a migration creating the table XXX with the
columns listed will be generated. For example:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration CreateProducts name:string part_number:string
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate migration CreateProducts name:string part_number:string
">Copy</button>
</div>
<p>generates</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:part_number</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateProducts < ActiveRecord::Migration[7.2]
  def change
    create_table :products do |t|
      t.string :name
      t.string :part_number

      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>As always, what has been generated for you is just a starting point.
You can add or remove from it as you see fit by editing the
<code>db/migrate/YYYYMMDDHHMMSS_create_products.rb</code> file.</p><h3 id="creating-associations-using-references"><a class="anchorlink" href="#creating-associations-using-references">2.5 Creating associations using references</a></h3><p>Also, the generator accepts column type as <code>references</code> (also available as
<code>belongs_to</code>). For example,</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration AddUserRefToProducts user:references
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate migration AddUserRefToProducts user:references
">Copy</button>
</div>
<p>generates the following <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_reference"><code>add_reference</code></a> call:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddUserRefToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_reference</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class AddUserRefToProducts < ActiveRecord::Migration[7.2]
  def change
    add_reference :products, :user, foreign_key: true
  end
end
">Copy</button>
</div>
<p>This migration will create a <code>user_id</code> column. <a href="#references">References</a> are a
shorthand for creating columns, indexes, foreign keys, or even polymorphic
association columns.</p><p>There is also a generator which will produce join tables if <code>JoinTable</code> is part of the name:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration CreateJoinTableCustomerProduct customer product
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate migration CreateJoinTableCustomerProduct customer product
">Copy</button>
</div>
<p>will produce the following migration:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateJoinTableCustomerProduct</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_join_table</span> <span class="ss">:customers</span><span class="p">,</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="c1"># t.index [:customer_id, :product_id]</span>
      <span class="c1"># t.index [:product_id, :customer_id]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateJoinTableCustomerProduct < ActiveRecord::Migration[7.2]
  def change
    create_join_table :customers, :products do |t|
      # t.index [:customer_id, :product_id]
      # t.index [:product_id, :customer_id]
    end
  end
end
">Copy</button>
</div>
<h3 id="model-generators"><a class="anchorlink" href="#model-generators">2.6 Model Generators</a></h3><p>The model, resource, and scaffold generators will create migrations appropriate for adding
a new model. This migration will already contain instructions for creating the
relevant table. If you tell Rails what columns you want, then statements for
adding these columns will also be created. For example, running:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model Product name:string description:text
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model Product name:string description:text
">Copy</button>
</div>
<p>This will create a migration that looks like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:description</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateProducts < ActiveRecord::Migration[7.2]
  def change
    create_table :products do |t|
      t.string :name
      t.text :description

      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>You can append as many column name/type pairs as you want.</p><h3 id="passing-modifiers"><a class="anchorlink" href="#passing-modifiers">2.7 Passing Modifiers</a></h3><p>Some commonly used <a href="#column-modifiers">type modifiers</a> can be passed directly on
the command line. They are enclosed by curly braces and follow the field type:</p><p>For instance, running:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration AddDetailsToProducts <span class="s1">'price:decimal{5,2}'</span> supplier:references<span class="o">{</span>polymorphic<span class="o">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate migration AddDetailsToProducts 'price:decimal{5,2}' supplier:references{polymorphic}
">Copy</button>
</div>
<p>will produce a migration that looks like this</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddDetailsToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:decimal</span><span class="p">,</span> <span class="ss">precision: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">scale: </span><span class="mi">2</span>
    <span class="n">add_reference</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class AddDetailsToProducts < ActiveRecord::Migration[7.2]
  def change
    add_column :products, :price, :decimal, precision: 5, scale: 2
    add_reference :products, :supplier, polymorphic: true
  end
end
">Copy</button>
</div>
<div class="info"><p>Have a look at the generators help output (<code>bin/rails generate --help</code>)
for further details.</p></div><h2 id="writing-migrations"><a class="anchorlink" href="#writing-migrations">3 Writing Migrations</a></h2><p>Once you have created your migration using one of the generators it's time to
get to work!</p><h3 id="creating-a-table"><a class="anchorlink" href="#creating-a-table">3.1 Creating a Table</a></h3><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-create_table"><code>create_table</code></a> method is one of the most fundamental, but most of the time,
will be generated for you from using a model, resource, or scaffold generator. A typical
use would be</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :products do |t|
  t.string :name
end
">Copy</button>
</div>
<p>This method creates a <code>products</code> table with a column called <code>name</code>.</p><p>By default, <code>create_table</code> will implicitly create a primary key called <code>id</code> for
you. You can change the name of the column with the <code>:primary_key</code> option, or
pass an array to <code>:primary_key</code> for a composite primary key. If you don't want
a primary key at all, you can pass the option <code>id: false</code>.</p><p>If you need to pass database-specific options you can place an SQL fragment in
the <code>:options</code> option. For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">options: </span><span class="s2">"ENGINE=BLACKHOLE"</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :products, options: &quot;ENGINE=BLACKHOLE&quot; do |t|
  t.string :name, null: false
end
">Copy</button>
</div>
<p>This will append <code>ENGINE=BLACKHOLE</code> to the SQL statement used to create the table.</p><p>An index can be created on the columns created within the <code>create_table</code> block
by passing <code>index: true</code> or an options hash to the <code>:index</code> option:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">index: </span><span class="p">{</span> <span class="ss">unique: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">name: </span><span class="s1">'unique_emails'</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :users do |t|
  t.string :name, index: true
  t.string :email, index: { unique: true, name: 'unique_emails' }
end
">Copy</button>
</div>
<p>Also, you can pass the <code>:comment</code> option with any description for the table that
will be stored in the database itself and can be viewed with database
administration tools, such as MySQL Workbench or PgAdmin III. It's highly
recommended to specify comments in migrations for applications with large
databases as it helps people to understand the data model and generate
documentation. Currently only the MySQL and PostgreSQL adapters support
comments.</p><h3 id="creating-a-join-table"><a class="anchorlink" href="#creating-a-join-table">3.2 Creating a Join Table</a></h3><p>The migration method <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-create_join_table"><code>create_join_table</code></a> creates an HABTM (has and belongs to
many) join table. A typical use would be:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_join_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:categories</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_join_table :products, :categories
">Copy</button>
</div>
<p>This migration will create a <code>categories_products</code> table with two columns called
<code>category_id</code> and <code>product_id</code>.</p><p>These columns have the option <code>:null</code> set to <code>false</code> by default, meaning that
you <strong>must</strong> provide a value in order to save a record to this table. This can
be overridden by specifying the <code>:column_options</code> option:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_join_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:categories</span><span class="p">,</span> <span class="ss">column_options: </span><span class="p">{</span> <span class="ss">null: </span><span class="kp">true</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_join_table :products, :categories, column_options: { null: true }
">Copy</button>
</div>
<p>By default, the name of the join table comes from the union of the first two
arguments provided to create_join_table, in alphabetical order.</p><p>To customize the name of the table, provide a <code>:table_name</code> option:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_join_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:categories</span><span class="p">,</span> <span class="ss">table_name: :categorization</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_join_table :products, :categories, table_name: :categorization
">Copy</button>
</div>
<p>This ensure the name of the join table is <code>categorization</code> as requested.</p><p>Also, <code>create_join_table</code> accepts a block, which you can use to add indices
(which are not created by default) or any additional columns you so choose.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_join_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:categories</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:product_id</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:category_id</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_join_table :products, :categories do |t|
  t.index :product_id
  t.index :category_id
end
">Copy</button>
</div>
<h3 id="changing-tables"><a class="anchorlink" href="#changing-tables">3.3 Changing Tables</a></h3><p>If you want to change an existing table in place, there is <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_table"><code>change_table</code></a>.</p><p>It is used in a similar fashion to <code>create_table</code> but the object yielded inside
the block has access to a number of special functions, for example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">change_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">remove</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:name</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:part_number</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:part_number</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">rename</span> <span class="ss">:upccode</span><span class="p">,</span> <span class="ss">:upc_code</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="change_table :products do |t|
  t.remove :description, :name
  t.string :part_number
  t.index :part_number
  t.rename :upccode, :upc_code
end
">Copy</button>
</div>
<p>This migration will remove the <code>description</code> and <code>name</code> columns, create a new
string column called <code>part_number</code> and adds an index on it. Finally it renames
the <code>upccode</code> column to <code>upc_code</code>.</p><h3 id="changing-columns"><a class="anchorlink" href="#changing-columns">3.4 Changing Columns</a></h3><p>Similar to the <code>remove_column</code> and <code>add_column</code> methods we covered
<a href="#adding-new-columns">earlier</a>, Rails also provides the <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_column"><code>change_column</code></a>
migration method.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">change_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:text</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="change_column :products, :part_number, :text
">Copy</button>
</div>
<p>This changes the column <code>part_number</code> on products table to be a <code>:text</code> field.</p><div class="note"><p>The <code>change_column</code> command is <strong>irreversible</strong>.
You should provide your own <code>reversible</code> migration, like we discussed
<a href="#making-the-irreversible-possible">before</a>.</p></div><p>Besides <code>change_column</code>, the <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_column_null"><code>change_column_null</code></a> and <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_column_default"><code>change_column_default</code></a>
methods are used specifically to change a null constraint and default values of
a column.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">change_column_null</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="kp">false</span>
<span class="n">change_column_default</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:approved</span><span class="p">,</span> <span class="ss">from: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">to: </span><span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="change_column_null :products, :name, false
change_column_default :products, :approved, from: true, to: false
">Copy</button>
</div>
<p>This sets <code>:name</code> field on products to a <code>NOT NULL</code> column and the default
value of the <code>:approved</code> field from true to false. Both of these changes will
only be applied to future transactions, any existing records do not apply.</p><p>When setting the null constraint to true, this means that column will accept a
null value, otherwise the <code>NOT NULL</code> constraint is applied and a value must be
passed in order to persist the record to the database.</p><div class="note"><p>You could also write the above <code>change_column_default</code> migration as
<code>change_column_default :products, :approved, false</code>, but unlike the previous
example, this would make your migration irreversible.</p></div><h3 id="column-modifiers"><a class="anchorlink" href="#column-modifiers">3.5 Column Modifiers</a></h3><p>Column modifiers can be applied when creating or changing a column:</p>
<ul>
<li><code>comment</code>      Adds a comment for the column.</li>
<li><code>collation</code>    Specifies the collation for a <code>string</code> or <code>text</code> column.</li>
<li><code>default</code>      Allows to set a default value on the column. Note that if you
are using a dynamic value (such as a date), the default will only be calculated
the first time (i.e. on the date the migration is applied). Use <code>nil</code> for <code>NULL</code>.</li>
<li><code>limit</code>        Sets the maximum number of characters for a <code>string</code> column
and the maximum number of bytes for <code>text/binary/integer</code> columns.</li>
<li><code>null</code>         Allows or disallows <code>NULL</code> values in the column.</li>
<li><code>precision</code>    Specifies the precision for <code>decimal/numeric/datetime/time</code> columns.</li>
<li><code>scale</code>        Specifies the scale for the <code>decimal</code> and <code>numeric</code> columns,
representing the number of digits after the decimal point.</li>
</ul>
<div class="note"><p>For <code>add_column</code> or <code>change_column</code> there is no option for adding indexes.
They need to be added separately using <code>add_index</code>.</p></div><p>Some adapters may support additional options; see the adapter specific API docs
for further information.</p><div class="note"><p><code>null</code> and <code>default</code> cannot be specified via command line when generating
migrations.</p></div><h3 id="references"><a class="anchorlink" href="#references">3.6 References</a></h3><p>The <code>add_reference</code> method allows the creation of an appropriately named column
acting as the connection between one or more associations.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">add_reference</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:role</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="add_reference :users, :role
">Copy</button>
</div>
<p>This migration will create a <code>role_id</code> column in the users table. It creates an
index for this column as well, unless explicitly told not to with the
<code>index: false</code> option.</p><div class="info"><p>See also the <a href="association_basics.html">Active Record Associations</a> guide to learn more.</p></div><p>The method <code>add_belongs_to</code> is an alias of <code>add_reference</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">add_belongs_to</span> <span class="ss">:taggings</span><span class="p">,</span> <span class="ss">:taggable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="add_belongs_to :taggings, :taggable, polymorphic: true
">Copy</button>
</div>
<p>The polymorphic option will create two columns on the taggings table which can
be used for polymorphic associations: <code>taggable_type</code> and <code>taggable_id</code>.</p><div class="info"><p>See this guide to learn more about <a href="association_basics.html#polymorphic-associations">polymorphic associations</a>.</p></div><p>A foreign key can be created with the <code>foreign_key</code> option.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">add_reference</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:role</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="add_reference :users, :role, foreign_key: true
">Copy</button>
</div>
<p>For more <code>add_reference</code> options, visit the <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_reference">API documentation</a>.</p><p>References can also be removed:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">remove_reference</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="remove_reference :products, :user, foreign_key: true, index: false
">Copy</button>
</div>
<h3 id="foreign-keys"><a class="anchorlink" href="#foreign-keys">3.7 Foreign Keys</a></h3><p>While it's not required, you might want to add foreign key constraints to
<a href="#active-record-and-referential-integrity">guarantee referential integrity</a>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">add_foreign_key</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">:authors</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="add_foreign_key :articles, :authors
">Copy</button>
</div>
<p>This <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_foreign_key"><code>add_foreign_key</code></a> call adds a new constraint to the <code>articles</code> table.
The constraint guarantees that a row in the <code>authors</code> table exists where
the <code>id</code> column matches the <code>articles.author_id</code>.</p><p>If the <code>from_table</code> column name cannot be derived from the <code>to_table</code> name,
you can use the <code>:column</code> option. Use the <code>:primary_key</code> option if the
referenced primary key is not <code>:id</code>.</p><p>For example, to add a foreign key on <code>articles.reviewer</code> referencing <code>authors.email</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">add_foreign_key</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">:authors</span><span class="p">,</span> <span class="ss">column: :reviewer</span><span class="p">,</span> <span class="ss">primary_key: :email</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="add_foreign_key :articles, :authors, column: :reviewer, primary_key: :email
">Copy</button>
</div>
<p>This will add a constraint to the <code>articles</code> table that guarantees a row in the
<code>authors</code> table exists where the <code>email</code> column matches the <code>articles.reviewer</code>
field.</p><p>Several other options such as <code>name</code>, <code>on_delete</code>, <code>if_not_exists</code>, <code>validate</code>,
and <code>deferrable</code> are supported by <code>add_foreign_key</code>.</p><p>Foreign keys can also be removed using <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_foreign_key"><code>remove_foreign_key</code></a>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># let Active Record figure out the column name</span>
<span class="n">remove_foreign_key</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">:branches</span>

<span class="c1"># remove foreign key for a specific column</span>
<span class="n">remove_foreign_key</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">column: :owner_id</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# let Active Record figure out the column name
remove_foreign_key :accounts, :branches

# remove foreign key for a specific column
remove_foreign_key :accounts, column: :owner_id
">Copy</button>
</div>
<div class="note"><p>Active Record only supports single column foreign keys. <code>execute</code> and
<code>structure.sql</code> are required to use composite foreign keys. See
<a href="#schema-dumping-and-you">Schema Dumping and You</a>.</p></div><h3 id="composite-primary-keys"><a class="anchorlink" href="#composite-primary-keys">3.8 Composite Primary Keys</a></h3><p>Sometimes a single column's value isn't enough to uniquely identify every row
of a table, but a combination of two or more columns <em>does</em> uniquely identify
it. This can be the case when using a legacy database schema without a single
<code>id</code> column as a primary key, or when altering schemas for sharding or
multitenancy.</p><p>You can create a table with a composite primary key by passing the
<code>:primary_key</code> option to <code>create_table</code> with an array value:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">primary_key: </span><span class="p">[</span><span class="ss">:customer_id</span><span class="p">,</span> <span class="ss">:product_sku</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:customer_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:product_sku</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:description</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateProducts < ActiveRecord::Migration[7.2]
  def change
    create_table :products, primary_key: [:customer_id, :product_sku] do |t|
      t.integer :customer_id
      t.string :product_sku
      t.text :description
    end
  end
end
">Copy</button>
</div>
<div class="info"><p>Tables with composite primary keys require passing array values rather
than integer IDs to many methods. See also the <a href="active_record_querying.html">Active Record Querying</a> guide to learn more.</p></div><h3 id="when-helpers-aren-t-enough"><a class="anchorlink" href="#when-helpers-aren-t-enough">3.9 When Helpers aren't Enough</a></h3><p>If the helpers provided by Active Record aren't enough you can use the <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/DatabaseStatements.html#method-i-execute"><code>execute</code></a>
method to execute arbitrary SQL:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Product</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s2">"UPDATE products SET price = 'free' WHERE 1=1"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Product.connection.execute(&quot;UPDATE products SET price = 'free' WHERE 1=1&quot;)
">Copy</button>
</div>
<p>For more details and examples of individual methods, check the API documentation.</p><p>In particular the documentation for
<a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html"><code>ActiveRecord::ConnectionAdapters::SchemaStatements</code></a>, which provides the methods available in the <code>change</code>, <code>up</code> and <code>down</code> methods.</p><p>For methods available regarding the object yielded by <code>create_table</code>, see <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/TableDefinition.html"><code>ActiveRecord::ConnectionAdapters::TableDefinition</code></a>.</p><p>And for the object yielded by <code>change_table</code>, see <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/Table.html"><code>ActiveRecord::ConnectionAdapters::Table</code></a>.</p><h3 id="using-the-change-method"><a class="anchorlink" href="#using-the-change-method">3.10 Using the <code>change</code> Method</a></h3><p>The <code>change</code> method is the primary way of writing migrations. It works for the
majority of cases in which Active Record knows how to reverse a migration's
actions automatically. Below are some of the actions that <code>change</code> supports:</p>
<ul>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_check_constraint"><code>add_check_constraint</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_column"><code>add_column</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_foreign_key"><code>add_foreign_key</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_index"><code>add_index</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_reference"><code>add_reference</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_timestamps"><code>add_timestamps</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_column_comment"><code>change_column_comment</code></a> (must supply <code>:from</code> and <code>:to</code> options)</li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_column_default"><code>change_column_default</code></a> (must supply <code>:from</code> and <code>:to</code> options)</li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_column_null"><code>change_column_null</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_table_comment"><code>change_table_comment</code></a> (must supply <code>:from</code> and <code>:to</code> options)</li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-create_join_table"><code>create_join_table</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-create_table"><code>create_table</code></a></li>
<li><code>disable_extension</code></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-drop_join_table"><code>drop_join_table</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-drop_table"><code>drop_table</code></a> (must supply table creation options and block)</li>
<li><code>enable_extension</code></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_check_constraint"><code>remove_check_constraint</code></a> (must supply original constraint expression)</li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_column"><code>remove_column</code></a> (must supply original type and column options)</li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_columns"><code>remove_columns</code></a> (must supply original type and column options)</li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_foreign_key"><code>remove_foreign_key</code></a> (must supply other table and original options)</li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_index"><code>remove_index</code></a> (must supply columns and original options)</li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_reference"><code>remove_reference</code></a> (must supply original options)</li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_timestamps"><code>remove_timestamps</code></a> (must supply original options)</li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-rename_column"><code>rename_column</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-rename_index"><code>rename_index</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-rename_table"><code>rename_table</code></a></li>
</ul>
<p><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_table"><code>change_table</code></a> is also reversible, as long as the block only calls
reversible operations like the ones listed above.</p><p>If you're going to need to use any other methods, you should use <code>reversible</code>
or write the <code>up</code> and <code>down</code> methods instead of using the <code>change</code> method.</p><h3 id="using-reversible"><a class="anchorlink" href="#using-reversible">3.11 Using <code>reversible</code></a></h3><p>Complex migrations may require processing that Active Record doesn't know how to
reverse. You can use <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Migration.html#method-i-reversible"><code>reversible</code></a> to specify what to do when running a
migration and what else to do when reverting it. For example:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ExampleMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:distributors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:zipcode</span>
    <span class="k">end</span>

    <span class="n">reversible</span> <span class="k">do</span> <span class="o">|</span><span class="n">direction</span><span class="o">|</span>
      <span class="n">direction</span><span class="p">.</span><span class="nf">up</span> <span class="k">do</span>
        <span class="c1"># create a distributors view</span>
        <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
          CREATE VIEW distributors_view AS
          SELECT id, zipcode
          FROM distributors;
</span><span class="no">        SQL</span>
      <span class="k">end</span>
      <span class="n">direction</span><span class="p">.</span><span class="nf">down</span> <span class="k">do</span>
        <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
          DROP VIEW distributors_view;
</span><span class="no">        SQL</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:address</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ExampleMigration < ActiveRecord::Migration[7.2]
  def change
    create_table :distributors do |t|
      t.string :zipcode
    end

    reversible do |direction|
      direction.up do
        # create a distributors view
        execute <<-SQL
          CREATE VIEW distributors_view AS
          SELECT id, zipcode
          FROM distributors;
        SQL
      end
      direction.down do
        execute <<-SQL
          DROP VIEW distributors_view;
        SQL
      end
    end

    add_column :users, :address, :string
  end
end
">Copy</button>
</div>
<p>Using <code>reversible</code> will ensure that the instructions are executed in the right
order too. If the previous example migration is reverted, the <code>down</code> block will
be run after the <code>users.address</code> column is removed and before the <code>distributors</code>
table is dropped.</p><h3 id="using-the-up-down-methods"><a class="anchorlink" href="#using-the-up-down-methods">3.12 Using the <code>up</code>/<code>down</code> Methods</a></h3><p>You can also use the old style of migration using <code>up</code> and <code>down</code> methods
instead of the <code>change</code> method.</p><p>The <code>up</code> method should describe the transformation you'd like to make to your
schema, and the <code>down</code> method of your migration should revert the
transformations done by the <code>up</code> method. In other words, the database schema
should be unchanged if you do an <code>up</code> followed by a <code>down</code>.</p><p>For example, if you create a table in the <code>up</code> method, you should drop it in the
<code>down</code> method. It is wise to perform the transformations in precisely the
reverse order they were made in the <code>up</code> method. The example in the <code>reversible</code>
section is equivalent to:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ExampleMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">create_table</span> <span class="ss">:distributors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:zipcode</span>
    <span class="k">end</span>

    <span class="c1"># create a distributors view</span>
    <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
      CREATE VIEW distributors_view AS
      SELECT id, zipcode
      FROM distributors;
</span><span class="no">    SQL</span>

    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:address</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">down</span>
    <span class="n">remove_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:address</span>

    <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
      DROP VIEW distributors_view;
</span><span class="no">    SQL</span>

    <span class="n">drop_table</span> <span class="ss">:distributors</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ExampleMigration < ActiveRecord::Migration[7.2]
  def up
    create_table :distributors do |t|
      t.string :zipcode
    end

    # create a distributors view
    execute <<-SQL
      CREATE VIEW distributors_view AS
      SELECT id, zipcode
      FROM distributors;
    SQL

    add_column :users, :address, :string
  end

  def down
    remove_column :users, :address

    execute <<-SQL
      DROP VIEW distributors_view;
    SQL

    drop_table :distributors
  end
end
">Copy</button>
</div>
<h3 id="throwing-an-error-to-prevent-reverts"><a class="anchorlink" href="#throwing-an-error-to-prevent-reverts">3.13 Throwing an error to prevent reverts</a></h3><p>Sometimes your migration will do something which is just plain irreversible; for
example, it might destroy some data.</p><p>In such cases, you can raise <code>ActiveRecord::IrreversibleMigration</code> in your
<code>down</code> block.</p><p>If someone tries to revert your migration, an error message will be displayed
saying that it can't be done.</p><h3 id="reverting-previous-migrations"><a class="anchorlink" href="#reverting-previous-migrations">3.14 Reverting Previous Migrations</a></h3><p>You can use Active Record's ability to rollback migrations using the <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Migration.html#method-i-revert"><code>revert</code></a> method:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require_relative</span> <span class="s2">"20121212123456_example_migration"</span>

<span class="k">class</span> <span class="nc">FixupExampleMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">revert</span> <span class="no">ExampleMigration</span>

    <span class="n">create_table</span><span class="p">(</span><span class="ss">:apples</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:variety</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="require_relative &quot;20121212123456_example_migration&quot;

class FixupExampleMigration < ActiveRecord::Migration[7.2]
  def change
    revert ExampleMigration

    create_table(:apples) do |t|
      t.string :variety
    end
  end
end
">Copy</button>
</div>
<p>The <code>revert</code> method also accepts a block of instructions to reverse. This could
be useful to revert selected parts of previous migrations.</p><p>For example, let's imagine that <code>ExampleMigration</code> is committed and it is later
decided that a Distributors view is no longer needed.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">DontUseDistributorsViewMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">revert</span> <span class="k">do</span>
      <span class="c1"># copy-pasted code from ExampleMigration</span>
      <span class="n">reversible</span> <span class="k">do</span> <span class="o">|</span><span class="n">direction</span><span class="o">|</span>
        <span class="n">direction</span><span class="p">.</span><span class="nf">up</span> <span class="k">do</span>
          <span class="c1"># create a distributors view</span>
          <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
            CREATE VIEW distributors_view AS
            SELECT id, zipcode
            FROM distributors;
</span><span class="no">          SQL</span>
        <span class="k">end</span>
        <span class="n">direction</span><span class="p">.</span><span class="nf">down</span> <span class="k">do</span>
          <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
            DROP VIEW distributors_view;
</span><span class="no">          SQL</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="c1"># The rest of the migration was ok</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class DontUseDistributorsViewMigration < ActiveRecord::Migration[7.2]
  def change
    revert do
      # copy-pasted code from ExampleMigration
      reversible do |direction|
        direction.up do
          # create a distributors view
          execute <<-SQL
            CREATE VIEW distributors_view AS
            SELECT id, zipcode
            FROM distributors;
          SQL
        end
        direction.down do
          execute <<-SQL
            DROP VIEW distributors_view;
          SQL
        end
      end

      # The rest of the migration was ok
    end
  end
end
">Copy</button>
</div>
<p>The same migration could also have been written without using <code>revert</code> but this
would have involved a few more steps:</p>
<ol>
<li>Reverse the order of <code>create_table</code> and <code>reversible</code>.</li>
<li>Replace <code>create_table</code> with <code>drop_table</code>.</li>
<li>Finally, replace <code>up</code> with <code>down</code> and vice-versa.</li>
</ol>
<p>This is all taken care of by <code>revert</code>.</p><h2 id="running-migrations"><a class="anchorlink" href="#running-migrations">4 Running Migrations</a></h2><p>Rails provides a set of commands to run certain sets of migrations.</p><p>The very first migration related rails command you will use will probably be
<code>bin/rails db:migrate</code>. In its most basic form it just runs the <code>change</code> or <code>up</code>
method for all the migrations that have not yet been run. If there are
no such migrations, it exits. It will run these migrations in order based
on the date of the migration.</p><p>Note that running the <code>db:migrate</code> command also invokes the <code>db:schema:dump</code> command, which
will update your <code>db/schema.rb</code> file to match the structure of your database.</p><p>If you specify a target version, Active Record will run the required migrations
(change, up, down) until it has reached the specified version. The version
is the numerical prefix on the migration's filename. For example, to migrate
to version 20080906120000 run:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:migrate <span class="nv">VERSION</span><span class="o">=</span>20080906120000
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails db:migrate VERSION=20080906120000
">Copy</button>
</div>
<p>If version 20080906120000 is greater than the current version (i.e., it is
migrating upwards), this will run the <code>change</code> (or <code>up</code>) method
on all migrations up to and
including 20080906120000, and will not execute any later migrations. If
migrating downwards, this will run the <code>down</code> method on all the migrations
down to, but not including, 20080906120000.</p><h3 id="rolling-back"><a class="anchorlink" href="#rolling-back">4.1 Rolling Back</a></h3><p>A common task is to rollback the last migration. For example, if you made a
mistake in it and wish to correct it. Rather than tracking down the version
number associated with the previous migration you can run:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:rollback
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails db:rollback
">Copy</button>
</div>
<p>This will rollback the latest migration, either by reverting the <code>change</code>
method or by running the <code>down</code> method. If you need to undo
several migrations you can provide a <code>STEP</code> parameter:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:rollback <span class="nv">STEP</span><span class="o">=</span>3
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails db:rollback STEP=3
">Copy</button>
</div>
<p>The last 3 migrations will be reverted.</p><p>The <code>db:migrate:redo</code> command is a shortcut for doing a rollback and then migrating
back up again. As with the <code>db:rollback</code> command, you can use the <code>STEP</code> parameter
if you need to go more than one version back, for example:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:migrate:redo <span class="nv">STEP</span><span class="o">=</span>3
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails db:migrate:redo STEP=3
">Copy</button>
</div>
<p>Neither of these rails commands do anything you could not do with <code>db:migrate</code>. They
are there for convenience, since you do not need to explicitly specify the
version to migrate to.</p><h3 id="setup-the-database"><a class="anchorlink" href="#setup-the-database">4.2 Setup the Database</a></h3><p>The <code>bin/rails db:setup</code> command will create the database, load the schema, and initialize
it with the seed data.</p><h3 id="preparing-the-database"><a class="anchorlink" href="#preparing-the-database">4.3 Preparing the Database</a></h3><p>The <code>bin/rails db:prepare</code> command is similar to <code>bin/rails db:setup</code>, but it
operates idempotently.</p>
<ul>
<li>If the database has not been created yet, the command will run as the
<code>bin/rails db:setup</code> does.</li>
<li>If the database exists but the tables have not been created, the command will
load the schema, run any pending migrations, dump the updated schema, and
finally load the seed data.</li>
<li>If both the database and tables exist but the seed data has not been loaded,
the command will only load the seed data.</li>
<li>If the database, tables, and seed data are all in place, the command will do
nothing.</li>
</ul>
<div class="note"><p>Once the database, tables, and seed data are all established, the command
will not try to reload the seed data, even if the previously loaded seed data or
the existing seed file have been altered or deleted. To reload the seed data,
you can manually run <code>bin/rails db:seed</code>.</p></div><h3 id="resetting-the-database"><a class="anchorlink" href="#resetting-the-database">4.4 Resetting the Database</a></h3><p>The <code>bin/rails db:reset</code> command will drop the database and set it up again. This is
functionally equivalent to <code>bin/rails db:drop db:setup</code>.</p><div class="note"><p>This is not the same as running all the migrations. It will only use the
contents of the current <code>db/schema.rb</code> or <code>db/structure.sql</code> file.
If a migration can't be rolled back, <code>bin/rails db:reset</code> may not help you. To
find out more about dumping the schema see <a href="#schema-dumping-and-you">Schema Dumping and You</a> section.</p></div><h3 id="running-specific-migrations"><a class="anchorlink" href="#running-specific-migrations">4.5 Running Specific Migrations</a></h3><p>If you need to run a specific migration up or down, the <code>db:migrate:up</code> and
<code>db:migrate:down</code> commands will do that. Just specify the appropriate version and
the corresponding migration will have its <code>change</code>, <code>up</code> or <code>down</code> method
invoked, for example:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:migrate:up <span class="nv">VERSION</span><span class="o">=</span>20080906120000
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails db:migrate:up VERSION=20080906120000
">Copy</button>
</div>
<p>By running this command the <code>change</code> method (or the <code>up</code> method) will be
executed for the migration with the version "20080906120000".</p><p>First, this command will check whether the migration exists and if it has
already been performed and will do nothing if so.</p><p>If the version specified does not exist, Rails will throw an exception.</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:migrate <span class="nv">VERSION</span><span class="o">=</span>zomg
<span class="go">rails aborted!
ActiveRecord::UnknownMigrationVersionError:

No migration with version number zomg.
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails db:migrate VERSION=zomg
">Copy</button>
</div>
<h3 id="running-migrations-in-different-environments"><a class="anchorlink" href="#running-migrations-in-different-environments">4.6 Running Migrations in Different Environments</a></h3><p>By default running <code>bin/rails db:migrate</code> will run in the <code>development</code> environment.</p><p>To run migrations against another environment you can specify it using the
<code>RAILS_ENV</code> environment variable while running the command. For example to run
migrations against the <code>test</code> environment you could run:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:migrate <span class="nv">RAILS_ENV</span><span class="o">=</span><span class="nb">test</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails db:migrate RAILS_ENV=test
">Copy</button>
</div>
<h3 id="changing-the-output-of-running-migrations"><a class="anchorlink" href="#changing-the-output-of-running-migrations">4.7 Changing the Output of Running Migrations</a></h3><p>By default migrations tell you exactly what they're doing and how long it took.
A migration creating a table and adding an index might produce output like this</p><div class="code_container">
<pre><code class="highlight plaintext">==  CreateProducts: migrating =================================================
-- create_table(:products)
   -&gt; 0.0028s
==  CreateProducts: migrated (0.0028s) ========================================
</code></pre>
<button class="clipboard-button" data-clipboard-text="==  CreateProducts: migrating =================================================
-- create_table(:products)
   -> 0.0028s
==  CreateProducts: migrated (0.0028s) ========================================
">Copy</button>
</div>
<p>Several methods are provided in migrations that allow you to control all this:</p>
<table><thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead><tbody>
<tr>
<td><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Migration.html#method-i-suppress_messages"><code>suppress_messages</code></a></td>
<td>Takes a block as an argument and suppresses any output generated by the block.</td>
</tr>
<tr>
<td><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Migration.html#method-i-say"><code>say</code></a></td>
<td>Takes a message argument and outputs it as is. A second boolean argument can be passed to specify whether to indent or not.</td>
</tr>
<tr>
<td><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Migration.html#method-i-say_with_time"><code>say_with_time</code></a></td>
<td>Outputs text along with how long it took to run its block. If the block returns an integer it assumes it is the number of rows affected.</td>
</tr>
</tbody></table>
<p>For example, take the following migration:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">suppress_messages</span> <span class="k">do</span>
      <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:description</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">say</span> <span class="s2">"Created a table"</span>

    <span class="n">suppress_messages</span> <span class="p">{</span> <span class="n">add_index</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:name</span> <span class="p">}</span>
    <span class="n">say</span> <span class="s2">"and an index!"</span><span class="p">,</span> <span class="kp">true</span>

    <span class="n">say_with_time</span> <span class="s1">'Waiting for a while'</span> <span class="k">do</span>
      <span class="nb">sleep</span> <span class="mi">10</span>
      <span class="mi">250</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateProducts < ActiveRecord::Migration[7.2]
  def change
    suppress_messages do
      create_table :products do |t|
        t.string :name
        t.text :description
        t.timestamps
      end
    end

    say &quot;Created a table&quot;

    suppress_messages { add_index :products, :name }
    say &quot;and an index!&quot;, true

    say_with_time 'Waiting for a while' do
      sleep 10
      250
    end
  end
end
">Copy</button>
</div>
<p>This will generate the following output:</p><div class="code_container">
<pre><code class="highlight plaintext">==  CreateProducts: migrating =================================================
-- Created a table
   -&gt; and an index!
-- Waiting for a while
   -&gt; 10.0013s
   -&gt; 250 rows
==  CreateProducts: migrated (10.0054s) =======================================
</code></pre>
<button class="clipboard-button" data-clipboard-text="==  CreateProducts: migrating =================================================
-- Created a table
   -> and an index!
-- Waiting for a while
   -> 10.0013s
   -> 250 rows
==  CreateProducts: migrated (10.0054s) =======================================
">Copy</button>
</div>
<p>If you want Active Record to not output anything, then running <code>bin/rails db:migrate
VERBOSE=false</code> will suppress all output.</p><h2 id="changing-existing-migrations"><a class="anchorlink" href="#changing-existing-migrations">5 Changing Existing Migrations</a></h2><p>Occasionally you will make a mistake when writing a migration. If you have
already run the migration, then you cannot just edit the migration and run the
migration again: Rails thinks it has already run the migration and so will do
nothing when you run <code>bin/rails db:migrate</code>. You must rollback the migration (for
example with <code>bin/rails db:rollback</code>), edit your migration, and then run
<code>bin/rails db:migrate</code> to run the corrected version.</p><p>In general, editing existing migrations is not a good idea. You will be
creating extra work for yourself and your co-workers and cause major headaches
if the existing version of the migration has already been run on production
machines.</p><p>Instead, you should write a new migration that performs the changes
you require. Editing a freshly generated migration that has not yet been
committed to source control (or, more generally, which has not been propagated
beyond your development machine) is relatively harmless.</p><p>The <code>revert</code> method can be helpful when writing a new migration to undo previous
migrations in whole or in part (see <a href="#reverting-previous-migrations">Reverting Previous Migrations</a> above).</p><h2 id="schema-dumping-and-you"><a class="anchorlink" href="#schema-dumping-and-you">6 Schema Dumping and You</a></h2><h3 id="what-are-schema-files-for-questionmark"><a class="anchorlink" href="#what-are-schema-files-for-questionmark">6.1 What are Schema Files for?</a></h3><p>Migrations, mighty as they may be, are not the authoritative source for your
database schema. <strong>Your database remains the source of truth.</strong></p><p>By default, Rails generates <code>db/schema.rb</code> which attempts to capture the current
state of your database schema.</p><p>It tends to be faster and less error prone to create a new instance of your
application's database by loading the schema file via <code>bin/rails db:schema:load</code>
than it is to replay the entire migration history.
<a href="#old-migrations">Old migrations</a> may fail to apply correctly if those migrations use changing
external dependencies or rely on application code which evolves separately from
your migrations.</p><p>Schema files are also useful if you want a quick look at what attributes an
Active Record object has. This information is not in the model's code and is
frequently spread across several migrations, but the information is nicely
summed up in the schema file.</p><h3 id="types-of-schema-dumps"><a class="anchorlink" href="#types-of-schema-dumps">6.2 Types of Schema Dumps</a></h3><p>The format of the schema dump generated by Rails is controlled by the
<a href="configuring.html#config-active-record-schema-format"><code>config.active_record.schema_format</code></a> setting defined in
<code>config/application.rb</code>. By default, the format is <code>:ruby</code>, or alternatively can
be set to <code>:sql</code>.</p><h4 id="using-the-default-ruby-schema"><a class="anchorlink" href="#using-the-default-ruby-schema">6.2.1 Using the default <code>:ruby</code> schema</a></h4><p>When <code>:ruby</code> is selected, then the schema is stored in <code>db/schema.rb</code>. If you look
at this file you'll find that it looks an awful lot like one very big migration:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Schema</span><span class="p">[</span><span class="mf">7.2</span><span class="p">].</span><span class="nf">define</span><span class="p">(</span><span class="ss">version: </span><span class="mi">2008_09_06_171750</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">create_table</span> <span class="s2">"authors"</span><span class="p">,</span> <span class="ss">force: </span><span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="s2">"name"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"created_at"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"updated_at"</span>
  <span class="k">end</span>

  <span class="n">create_table</span> <span class="s2">"products"</span><span class="p">,</span> <span class="ss">force: </span><span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="s2">"name"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">text</span>     <span class="s2">"description"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"created_at"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"updated_at"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="s2">"part_number"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="ActiveRecord::Schema[7.2].define(version: 2008_09_06_171750) do
  create_table &quot;authors&quot;, force: true do |t|
    t.string   &quot;name&quot;
    t.datetime &quot;created_at&quot;
    t.datetime &quot;updated_at&quot;
  end

  create_table &quot;products&quot;, force: true do |t|
    t.string   &quot;name&quot;
    t.text     &quot;description&quot;
    t.datetime &quot;created_at&quot;
    t.datetime &quot;updated_at&quot;
    t.string   &quot;part_number&quot;
  end
end
">Copy</button>
</div>
<p>In many ways this is exactly what it is. This file is created by inspecting the
database and expressing its structure using <code>create_table</code>, <code>add_index</code>, and so
on.</p><h4 id="using-the-sql-schema-dumper"><a class="anchorlink" href="#using-the-sql-schema-dumper">6.2.2 Using the <code>:sql</code> schema dumper</a></h4><p>However, <code>db/schema.rb</code> cannot express everything your database may support such
as triggers, sequences, stored procedures, etc.</p><p>While migrations may use <code>execute</code> to create database constructs that are not
supported by the Ruby migration DSL, these constructs may not be able to be
reconstituted by the schema dumper.</p><p>If you are using features like these, you should set the schema format to <code>:sql</code>
in order to get an accurate schema file that is useful to create new database
instances.</p><p>When the schema format is set to <code>:sql</code>, the database structure will be dumped
using a tool specific to the database into <code>db/structure.sql</code>. For example, for
PostgreSQL, the <code>pg_dump</code> utility is used. For MySQL and MariaDB, this file will
contain the output of <code>SHOW CREATE TABLE</code> for the various tables.</p><p>To load the schema from <code>db/structure.sql</code>, run <code>bin/rails db:schema:load</code>.
Loading this file is done by executing the SQL statements it contains. By
definition, this will create a perfect copy of the database's structure.</p><h3 id="schema-dumps-and-source-control"><a class="anchorlink" href="#schema-dumps-and-source-control">6.3 Schema Dumps and Source Control</a></h3><p>Because schema files are commonly used to create new databases, it is strongly
recommended that you check your schema file into source control.</p><p>Merge conflicts can occur in your schema file when two branches modify schema.
To resolve these conflicts run <code>bin/rails db:migrate</code> to regenerate the schema file.</p><div class="info"><p>Newly generated Rails apps will already have the migrations folder
included in the git tree, so all you have to do is be sure to add any new
migrations you add and commit them.</p></div><h2 id="active-record-and-referential-integrity"><a class="anchorlink" href="#active-record-and-referential-integrity">7 Active Record and Referential Integrity</a></h2><p>The Active Record way claims that intelligence belongs in your models, not in
the database. As such, features such as triggers or constraints, which push some
of that intelligence back into the database, are not recommended.</p><p>Validations such as <code>validates :foreign_key, uniqueness: true</code> are one way in
which models can enforce data integrity. The <code>:dependent</code> option on associations
allows models to automatically destroy child objects when the parent is
destroyed. Like anything which operates at the application level, these cannot
guarantee referential integrity and so some people augment them with <a href="#foreign-keys">foreign
key constraints</a> in the database.</p><p>Although Active Record does not provide all the tools for working directly with
such features, the <code>execute</code> method can be used to execute arbitrary SQL.</p><h2 id="migrations-and-seed-data"><a class="anchorlink" href="#migrations-and-seed-data">8 Migrations and Seed Data</a></h2><p>The main purpose of Rails' migration feature is to issue commands that modify
the schema using a consistent process. Migrations can also be used to add or
modify data. This is useful in an existing database that can't be destroyed and
recreated, such as a production database.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddInitialProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
      <span class="no">Product</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Product #</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">description: </span><span class="s2">"A product."</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">down</span>
    <span class="no">Product</span><span class="p">.</span><span class="nf">delete_all</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class AddInitialProducts < ActiveRecord::Migration[7.2]
  def up
    5.times do |i|
      Product.create(name: &quot;Product ##{i}&quot;, description: &quot;A product.&quot;)
    end
  end

  def down
    Product.delete_all
  end
end
">Copy</button>
</div>
<p>To add initial data after a database is created, Rails has a built-in 'seeds'
feature that speeds up the process. This is especially useful when reloading the
database frequently in development and test environments, or when setting up
initial data for production.</p><p>To get started with this feature, open up <code>db/seeds.rb</code> and add some Ruby code,
then run <code>bin/rails db:seed</code>.</p><div class="note"><p>The code here should be idempotent so that it can be executed at any point
in every environment.</p></div><div class="code_container">
<pre><code class="highlight ruby"><span class="p">[</span><span class="s2">"Action"</span><span class="p">,</span> <span class="s2">"Comedy"</span><span class="p">,</span> <span class="s2">"Drama"</span><span class="p">,</span> <span class="s2">"Horror"</span><span class="p">].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">genre_name</span><span class="o">|</span>
  <span class="no">MovieGenre</span><span class="p">.</span><span class="nf">find_or_create_by!</span><span class="p">(</span><span class="ss">name: </span><span class="n">genre_name</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="[&quot;Action&quot;, &quot;Comedy&quot;, &quot;Drama&quot;, &quot;Horror&quot;].each do |genre_name|
  MovieGenre.find_or_create_by!(name: genre_name)
end
">Copy</button>
</div>
<p>This is generally a much cleaner way to set up the database of a blank
application.</p><h2 id="old-migrations"><a class="anchorlink" href="#old-migrations">9 Old Migrations</a></h2><p>The <code>db/schema.rb</code> or <code>db/structure.sql</code> is a snapshot of the current state of
your database and is the authoritative source for rebuilding that database. This
makes it possible to delete or prune old migration files.</p><p>When you delete migration files in the <code>db/migrate/</code> directory, any environment
where <code>bin/rails db:migrate</code> was run when those files still existed will hold a
reference to the migration timestamp specific to them inside an internal Rails
database table named <code>schema_migrations</code>. This table is used to keep track of
whether migrations have been executed in a specific environment.</p><p>If you run the <code>bin/rails db:migrate:status</code> command, which displays the status
(up or down) of each migration, you should see <code>********** NO FILE **********</code>
displayed next to any deleted migration file which was once executed on a
specific environment but can no longer be found in the <code>db/migrate/</code> directory.</p><h3 id="migrations-from-engines"><a class="anchorlink" href="#migrations-from-engines">9.1 Migrations from Engines</a></h3><p>There's a caveat, though with <a href="engines.html">Engines</a>. Rake tasks to install migrations from
engines are idempotent, meaning they will have the same result no matter how
many times they are called. Migrations present in the parent application due to
a previous installation are skipped, and missing ones are copied with a new
leading timestamp. If you deleted old engine migrations and ran the install task
again, you'd get new files with new timestamps, and <code>db:migrate</code> would attempt
to run them again.</p><p>Thus, you generally want to preserve migrations coming from engines. They have a
special comment like this:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># This migration comes from blorgh (originally 20210621082949)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# This migration comes from blorgh (originally 20210621082949)
">Copy</button>
</div>


        <h3>Feedback</h3>
        <p>
          You're encouraged to help improve the quality of this guide.
        </p>
        <p>
          Please contribute if you see any typos or factual errors.
          To get started, you can read our <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">documentation contributions</a> section.
        </p>
        <p>
          You may also find incomplete content or stuff that is not up to date.
          Please do add any missing documentation for main. Make sure to check
          <a href="https://edgeguides.rubyonrails.org">Edge Guides</a> first to verify
          if the issues are already fixed or not on the main branch.
          Check the <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a>
          for style and conventions.
        </p>
        <p>
          If for whatever reason you spot something to fix but cannot patch it yourself, please
          <a href="https://github.com/rails/rails/issues">open an issue</a>.
        </p>
        <p>And last but not least, any kind of discussion regarding Ruby on Rails
          documentation is very welcome on the <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">official Ruby on Rails Forum</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>This work is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a> License</p>
<p>"Rails", "Ruby on Rails", and the Rails logo are trademarks of David Heinemeier Hansson. All rights reserved.</p>

    </div>
  </div>
</body>
</html>
