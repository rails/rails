require 'rake/testtask'
require 'rubygems/package_task'

task :default => :test

desc "Run all unit tests"
task :test => 'test:isolated'

namespace :test do
  task :isolated do
    # Splitting test folders between these builds:
    #   GEM=railties:test/application
    #   GEM=railties:test/others
    dirs = case ENV["GEM"]
    when "railties:test/application"
      dirs = ["application"]
    when "railties:test/others"
      dirs = Dir.glob("*").select { |f| File.directory?(f) } - ["application"]
    else
      (ENV["TEST_DIR"] || ENV["TEST_DIRS"] || "**").split(",")
    end

    test_files = dirs.map { |dir| "test/#{dir}/*_test.rb" }
    # Add files in `/test` folder when splitting subfolders
    test_files << "test/*_test.rb" if ENV["GEM"] == "railties:test/others"

    Dir[*test_files].each do |file|
      next true if file.include?("fixtures")
      dash_i = [
        'test',
        'lib',
        "#{File.dirname(__FILE__)}/../activesupport/lib",
        "#{File.dirname(__FILE__)}/../actionpack/lib",
        "#{File.dirname(__FILE__)}/../activemodel/lib"
      ]
      ruby "-w", "-I#{dash_i.join ':'}", file
    end
  end
end

Rake::TestTask.new('test:regular') do |t|
  t.libs << 'test' << "#{File.dirname(__FILE__)}/../activesupport/lib"
  t.pattern = 'test/**/*_test.rb'
  t.warning = true
  t.verbose = true
  t.ruby_opts = ["--dev"] if defined?(JRUBY_VERSION)
end

# Generate GEM ----------------------------------------------------------------------------

spec = eval(File.read('railties.gemspec'))

Gem::PackageTask.new(spec) do |pkg|
  pkg.gem_spec = spec
end

# Publishing -------------------------------------------------------

desc "Release to rubygems"
task :release => :package do
  require 'rake/gemcutter'
  Rake::Gemcutter::Tasks.new(spec).define
  Rake::Task['gem:push'].invoke
end
