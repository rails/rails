# frozen_string_literal: true

require "rake/testtask"

task default: :test

task :package

desc "Run all unit tests"
task test: "test:isolated"

namespace :test do
  task :isolated do
    dirs = (ENV["TEST_DIR"] || ENV["TEST_DIRS"] || "**").split(",")
    test_files = dirs.map { |dir| "test/#{dir}/*_test.rb" }
    test_files = Dir[*test_files]

    skip_dirs = (ENV["SKIP_TEST_DIR"] || ENV["SKIP_TEST_DIRS"] || "").split(",")

    if !skip_dirs.empty?
      test_files.reject! do |filename|
        skip_dirs.any? { |skip_dir| filename.include?(skip_dir) }
      end
    end

    test_files.each do |file|
      next true if file.include?("fixtures")
      dash_i = [
        "test",
        "lib",
        "#{__dir__}/../activesupport/lib",
        "#{__dir__}/../actionpack/lib",
        "#{__dir__}/../actionview/lib",
        "#{__dir__}/../activemodel/lib"
      ]
      ruby "-w", "-I#{dash_i.join ':'}", file
    end
  end
end

Rake::TestTask.new("test:regular") do |t|
  t.libs << "test" << "#{__dir__}/../activesupport/lib"
  t.pattern = "test/**/*_test.rb"
  t.warning = false
  t.verbose = true
  t.ruby_opts = ["--dev"] if defined?(JRUBY_VERSION)
end
